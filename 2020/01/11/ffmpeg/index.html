<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":true,"show_result":true,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="1.ffmpeg常用命令 视频录制命令 多媒体文件的分解&#x2F;复用命令 裁剪与合并互转命令 直播相关命令 各种滤镜命令 11. 视频--H264编码&#x2F;解码22. 音频--ACC编码&#x2F;解码2.应用场景 直播类：音视频会议、教育直播、娱乐&#x2F;游戏 短视频：抖音、快手 网络视频：腾讯视频、优酷视频、爱奇艺 视频通话：微信、QQ 视频监控：幼儿园、停车场 人工智能：人脸视频、智能音箱">
<meta name="keywords" content="ffmpeg">
<meta property="og:type" content="article">
<meta property="og:title" content="ffmpeg学习笔记">
<meta property="og:url" content="http:&#x2F;&#x2F;lanxuexing.github.io&#x2F;2020&#x2F;01&#x2F;11&#x2F;ffmpeg&#x2F;index.html">
<meta property="og:site_name" content="Sunny Bottle">
<meta property="og:description" content="1.ffmpeg常用命令 视频录制命令 多媒体文件的分解&#x2F;复用命令 裁剪与合并互转命令 直播相关命令 各种滤镜命令 11. 视频--H264编码&#x2F;解码22. 音频--ACC编码&#x2F;解码2.应用场景 直播类：音视频会议、教育直播、娱乐&#x2F;游戏 短视频：抖音、快手 网络视频：腾讯视频、优酷视频、爱奇艺 视频通话：微信、QQ 视频监控：幼儿园、停车场 人工智能：人脸视频、智能音箱">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-01-13T02:19:18.548Z">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://lanxuexing.github.io/2020/01/11/ffmpeg/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>ffmpeg学习笔记 | Sunny Bottle</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Sunny Bottle</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/lanxuexing" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://lanxuexing.github.io/2020/01/11/ffmpeg/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="lanxuexing">
      <meta itemprop="description" content="love digging into the internals of frontend. always trying to reach the next level.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Sunny Bottle">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ffmpeg学习笔记
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-01-11 19:21:43" itemprop="dateCreated datePublished" datetime="2020-01-11T19:21:43+08:00">2020-01-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-01-13 10:19:18" itemprop="dateModified" datetime="2020-01-13T10:19:18+08:00">2020-01-13</time>
              </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>132k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>2:01</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h4 id="1-ffmpeg常用命令"><a href="#1-ffmpeg常用命令" class="headerlink" title="1.ffmpeg常用命令"></a>1.ffmpeg常用命令</h4><ol>
<li>视频录制命令</li>
<li>多媒体文件的分解/复用命令</li>
<li>裁剪与合并互转命令</li>
<li>直播相关命令</li>
<li>各种滤镜命令</li>
</ol><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>. 视频--H264编码/解码</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="number">2</span>. 音频--ACC编码/解码</span></pre></td></tr></table></figure><h4 id="2-应用场景"><a href="#2-应用场景" class="headerlink" title="2.应用场景"></a>2.应用场景</h4><ul>
<li>直播类：音视频会议、教育直播、娱乐/游戏</li>
<li>短视频：抖音、快手</li>
<li>网络视频：腾讯视频、优酷视频、爱奇艺</li>
<li>视频通话：微信、QQ</li>
<li>视频监控：幼儿园、停车场</li>
<li>人工智能：人脸视频、智能音箱</li>
</ul><a id="more"></a>



<h4 id="3-基本流程"><a href="#3-基本流程" class="headerlink" title="3.基本流程"></a>3.基本流程</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">1. 解复用 ---  音视频解码（ffmpeg）--- 音频播放&#x2F;视频渲染（SDL）</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">2. YUL数据 --- 渲染器渲染成纹理 --- 显卡计算交换 --- 窗口展示</span></pre></td></tr></table></figure>

<h4 id="4-ffmpeg的历史"><a href="#4-ffmpeg的历史" class="headerlink" title="4.ffmpeg的历史"></a>4.ffmpeg的历史</h4><ul>
<li>2000年，由法布里斯.贝拉创建</li>
<li>2004年，迈克尔接管</li>
<li>2011年，Libav从ffmpeg分离</li>
</ul>
<h4 id="5-下载"><a href="#5-下载" class="headerlink" title="5.下载"></a>5.下载</h4><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">git clone http<span class="variable">s:</span>//git.ffmpeg.org/ffmpeg.git</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">./configure --<span class="keyword">list</span>-filters</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">./configure --helo | more</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">--disable-gpl</span></pre></td></tr></table></figure>

<h4 id="6-ffmpeg命令分类"><a href="#6-ffmpeg命令分类" class="headerlink" title="6.ffmpeg命令分类"></a>6.ffmpeg命令分类</h4><ul>
<li>基本信息查询命令</li>
<li>录制命令</li>
<li>分解/复用命令</li>
<li>处理原始数据命令</li>
<li>裁剪与合并命令</li>
<li>图片/视频互转命令</li>
<li>直播相关命令</li>
<li>各种滤镜命令</li>
</ul>
<h4 id="7-ffmpeg处理流程"><a href="#7-ffmpeg处理流程" class="headerlink" title="7.ffmpeg处理流程"></a>7.ffmpeg处理流程</h4><p>输入文件 – demuxer处理 — 编码数据包 — decoder处理 — 解码后数据帧 — encoder处理 — 编码数据包 — muxer处理 — 输出文件</p>
<h4 id="8-ffmpeg命令之基本信息查询"><a href="#8-ffmpeg命令之基本信息查询" class="headerlink" title="8.ffmpeg命令之基本信息查询"></a>8.ffmpeg命令之基本信息查询</h4><table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>-version</td>
<td>显示版本</td>
</tr>
<tr>
<td>-demuxers</td>
<td>显示可用的demuxers</td>
</tr>
<tr>
<td>-muxers</td>
<td>显示可用的muxers</td>
</tr>
<tr>
<td>-devices</td>
<td>显示可用的设备</td>
</tr>
<tr>
<td>-codecs</td>
<td>显示所有编解码器</td>
</tr>
<tr>
<td>-decoders</td>
<td>显示可用的解码器</td>
</tr>
<tr>
<td>-encoders</td>
<td>显示所有的编码器</td>
</tr>
<tr>
<td>-bsfs</td>
<td>显示比特流filter</td>
</tr>
<tr>
<td>-formats</td>
<td>显示可用的格式</td>
</tr>
<tr>
<td>-protocols</td>
<td>显示可用的协议</td>
</tr>
<tr>
<td>-filters</td>
<td>显示可用的过滤器</td>
</tr>
<tr>
<td>-pix_fmts</td>
<td>显示可用的像素格式</td>
</tr>
<tr>
<td>-sample_fmts</td>
<td>显示可用过的采样格式</td>
</tr>
<tr>
<td>-layouts</td>
<td>显示channel名称</td>
</tr>
<tr>
<td>-colors</td>
<td>显示识别的颜色名称</td>
</tr>
</tbody></table>
<h4 id="9-ffmpeg命令之录制"><a href="#9-ffmpeg命令之录制" class="headerlink" title="9.ffmpeg命令之录制"></a>9.ffmpeg命令之录制</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">1. 录制屏幕：ffmpeg -f avfoundation -i1-r30 out.yuv</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">-f: 指定使用 avfoundation 采集数据</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">-i：指定从哪儿采集数据，它是一个文件的索引号</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">-r：指定帧率</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">.yuv：采集之后保存的数据 </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">2. 录制音频：ffmpeg -f avfoundation -i :0 out.wav</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">-f: 指定使用 avfoundation 采集数据</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">-i：指定从哪儿采集数据，它是一个文件的索引号（：0 是音频，冒号前是视频）</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">.yuv：采集之后保存的数据</span></pre></td></tr></table></figure>


<h4 id="10-ffmpeg命令之分解与复用"><a href="#10-ffmpeg命令之分解与复用" class="headerlink" title="10.ffmpeg命令之分解与复用"></a>10.ffmpeg命令之分解与复用</h4><p>输入文件 – demuxer – 编码数据包 – muxer 输出文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">1. 多媒体格式转换：ffmpeg -i out.mp4 -vcodec copy -acodec copy out.flv</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">-i：输入文件</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">-vcodec copy：视频编码处理方式</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">-acodec copy：音频编码处理方式 </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">2. 抽取视频：ffmpeg -i f35.mp4 -an -vcodec copy out.h264</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">3. 抽取音频：ffmpeg -i f35.mp4 -acodec -vn copy out.aac</span></pre></td></tr></table></figure>


<h4 id="11-ffmpeg命令之处理原始数据"><a href="#11-ffmpeg命令之处理原始数据" class="headerlink" title="11.ffmpeg命令之处理原始数据"></a>11.ffmpeg命令之处理原始数据</h4><p>原始数据：ffmpeg解码在之后的数据，对于音频就是pcm数据，对于视频就是yuv数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">1. 提取yuv数据：ffmpeg -i input.mp4 -an -c:v rawvideo -pix_fmt yuv420p out.yuv</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">-i：输入文件</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">-an：audio no 就是不需要音频</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">-c:v：对视频进行编码，使用rawvideo格式进行编码</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">-pix_fmt：指定像素格式</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">2. 提取pcm数据：ffmpeg -i out.mp4 -vn -ar 44100 -ac2 -f s16le out.pcm</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">-i：输入文件</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">-vn：video no 就是不需要视频</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">-ar：audio read：指定音频采样率</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">-ac2：audio channel 指定单声道、双声道、立体声、环绕立体声等等声道数</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">-f：指定抽取出来的数据存储方式</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">ffplay播放的时候原始数据需要指定一些参数以正确播放：</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">视频： -s 指定分辨率</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">音频:  -ar 指定采样率 -ar 指定声道数 -f 指定数据存储方式</span></pre></td></tr></table></figure>


<h4 id="12-ffmpeg命令之滤镜"><a href="#12-ffmpeg命令之滤镜" class="headerlink" title="12.ffmpeg命令之滤镜"></a>12.ffmpeg命令之滤镜</h4><p>视频加水印、logo、画中画等等…处理解码后的数据帧<br>decoded frames — filter处理 — filtered frames — encoder处理 —  encoded data</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">1. 视频裁剪：ffmpeg -i in.mov -vf crop&#x3D;in_w-200:in_h-200 -c:v libx264 -c:a copy out.mp4</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">-i：输入文件</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">-vf：video filter 指定视频滤镜且要&#x3D;指定宽高w:h</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">-c:v：指定视频编码器</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">-c:a：指定音频编码器</span></pre></td></tr></table></figure>


<h4 id="13-ffmpeg命令之裁剪与合并"><a href="#13-ffmpeg命令之裁剪与合并" class="headerlink" title="13.ffmpeg命令之裁剪与合并"></a>13.ffmpeg命令之裁剪与合并</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">1. 视频裁剪：ffmpeg -i in.mp4 -ss 00:00:00 -t 10 out.ts</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">-i：输入文件</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">-ss：指定裁剪的起始点</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">-t：指定裁剪的时长(持续时长)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">2. 视频合并：ffmpeg -f concat -i inputs.txt out.flv</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">-f：file 指定文件处理方式</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">-i: 输入文件集合，inputs.txt内容为 &#39;file filename&#39; 格式</span></pre></td></tr></table></figure>


<h4 id="14-ffmpeg命令之图片与视频互转"><a href="#14-ffmpeg命令之图片与视频互转" class="headerlink" title="14.ffmpeg命令之图片与视频互转"></a>14.ffmpeg命令之图片与视频互转</h4><p>机器学习，视频裁切成一张张图片，然后使用图片识别技术识别图片上的内容。又或者多张图片合成一个视频等等。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">1. 视频转图片：ffmpeg -i in.flv -r 1 -f image2 image-%3d.jpeg</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">-i：输入文件</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">-r：指定转换图片的帧率(每秒钟转出1张图片)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">-f：指定文件转换格式</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">2. 图片转视频：ffmpeg -i image-%3d.jpeg out.mp4</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">-i：输入文件</span></pre></td></tr></table></figure>


<h4 id="15-ffmpeg命令之直播推流与拉流"><a href="#15-ffmpeg命令之直播推流与拉流" class="headerlink" title="15.ffmpeg命令之直播推流与拉流"></a>15.ffmpeg命令之直播推流与拉流</h4><p><a href="https://blog.csdn.net/github_30662571/article/details/72466091" target="_blank" rel="noopener">一些直播流的rtmp地址</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">1. 直播推流：ffmpeg -re -i out.mp4 -c copy -f flv rtmp:&#x2F;&#x2F;server&#x2F;live&#x2F;streamName</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">-re：减慢帧率速度，保持帧率同步</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">-i：指定推流的文件</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">-c：音视频编解码 a是音频 v是视频 copy保持参数不变</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">-f：指定推流的文件格式</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">2. 直播拉流：ffmpeg -i rtmp:&#x2F;&#x2F;server&#x2F;live&#x2F;streamName -c copy dump.flv</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">-i：指定直播发布的rtmp服务地址</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">-c：指定音视频编码器</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">&#96;&#96;&#96; </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">#### 16.vim编辑器</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">- 命令模式：拷贝&#x2F;删除、粘贴 i&#x2F;a 切换到编辑模式</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">- 编辑模式：esc退出编辑模式</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">- 创建文件：vim filename</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">- 保存：:w</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">- 退出：:q</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">- 保存并退出：:wq</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">- 拷贝：yy&#x2F;yw  yy是拷贝一行   yw是拷贝一个单词</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">- 粘贴：p</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">- 删除：dd&#x2F;dw  dd是删除一行   dw是删除一个单词</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">- 左下上右：h&#x2F;j&#x2F;k&#x2F;l</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">- 跳到文件头：gg</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">- 跳到文件尾：GG</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">- 移动到行首：^</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">- 移动到行尾：$</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">- 按单词移动：向前 w&#x2F;2w  向后 b&#x2F;2b</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">- 查找关键字：&#x2F;关键字   下一个n  上一个N</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">- 查找与替换：:%s&#x2F;关键字&#x2F;替换字&#x2F;gc  c是表示要二次确认</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">- 分窗口：split&#x2F;vsplit</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">- 窗口间跳转：ctrl + ww&#x2F;w[hjkl]  ctrl + w + &#x3D; 恢复等屏幕    ctrl + w shift + | 最大化当前窗口  ctrl + w shift + - 最大化当前窗口</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">#### 17.C语言基础</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">&#96;&#96;&#96;c</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;  &#x2F;&#x2F; 导入头文件</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">int  main(int argc, char* argv[]) &#123; &#x2F;&#x2F; 入口函数</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">    int a &#x3D; 100;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">    float b &#x3D; 7 .79;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">    char c &#x3D; &#39;today&#39;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">    printf(&quot;Hello Worl!\n&quot;);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">    printf(&quot;a&#x3D;%d\n&quot;, a);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">    printf(&quot;b&#x3D;%f\n&quot;, b);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line">    printf(&quot;c&#x3D;%c\n&quot;, c);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line">    return 0;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">51</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">52</span></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;  clang -g -o helloworld helloworld.c    -g输出debug信息  -o是输出可执行程序</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">53</span></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; .&#x2F;helloworld</span></pre></td></tr></table></figure>


<h4 id="18-C语言基础之常用基本类型"><a href="#18-C语言基础之常用基本类型" class="headerlink" title="18.C语言基础之常用基本类型"></a>18.C语言基础之常用基本类型</h4><ul>
<li>short int long</li>
<li>float double</li>
<li>char</li>
<li>void</li>
</ul>
<h4 id="19-C语言基础之指针与数组"><a href="#19-C语言基础之指针与数组" class="headerlink" title="19.C语言基础之指针与数组"></a>19.C语言基础之指针与数组</h4><ul>
<li>指针就是内存地址：void*  char*</li>
<li>数组： char c[2]   int arr[20]   连续的同一类型的内存空间</li>
<li>指针本身运算</li>
<li>指针所指内容的操作</li>
<li>操作系统如何管理内存？栈空间、堆空间、内存映射</li>
<li>分配内存：void* mem = malloc(size);</li>
<li>释放内存：free(mem);</li>
<li>申请的内存不用也不释放以引起内存泄漏</li>
<li>占用别人的内存成为野指针</li>
<li>函数指针：返回值类型(*指针变量名)([形参列表])</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">int func(int x); &#x2F;&#x2F; 声明一个函数</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">int (*f) (int x); &#x2F;&#x2F; 声明一个函数指针</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">f &#x3D; func; &#x2F;&#x2F; 将func函数的首地址赋给指针f</span></pre></td></tr></table></figure>


<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;studio.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> a + b;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sub</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> a - b;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argc[])</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">     <span class="keyword">int</span> *a, *b; <span class="comment">// 定义两个指针类型</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">     a = (<span class="keyword">int</span>*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">int</span>)); <span class="comment">// 在堆里开辟空间</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">     b = (<span class="keyword">int</span>*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">     *a = <span class="number">1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">     *b = <span class="number">2</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">     <span class="keyword">int</span> c[<span class="number">3</span>] = &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>&#125;; <span class="comment">// 定义一个数组</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">     <span class="built_in">printf</span>(<span class="string">"addr of a:%p\n, %p, %d\n"</span>, &amp;a, a, *a);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">     <span class="built_in">printf</span>(<span class="string">"addr of b:%p\n, %p, %d\n"</span>, &amp;b, a, *b);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">     <span class="built_in">printf</span>(<span class="string">"addr of c:%p, %p, %d, %d, %d"</span>, &amp;c, c, c[<span class="number">0</span>], c[<span class="number">1</span>], c[<span class="number">2</span>]);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">     </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">     <span class="keyword">int</span> (*f)(<span class="keyword">int</span>, <span class="keyword">int</span>); <span class="comment">// 定义一个函数指针</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">     <span class="keyword">int</span> result;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">     <span class="keyword">int</span> r;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">     f = sum;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">     retsult = f(<span class="number">3</span>, <span class="number">5</span>); <span class="comment">// 通过函数指针调用函数</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">     </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">     f = sub;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">     r = f(result, <span class="number">5</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">     <span class="built_in">printf</span>(<span class="string">"3+5=%d\n"</span>, result);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">     <span class="built_in">printf</span>(<span class="string">"8-5=%d\n"</span>, r);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">     <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>


<h4 id="20-C语言基础之结构体"><a href="#20-C语言基础之结构体" class="headerlink" title="20.C语言基础之结构体"></a>20.C语言基础之结构体</h4><p>原始类型，自定义的类型–结构体、枚举</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;studio.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">st</span> &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> a;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> b;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> em &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    red = <span class="number">10</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    green = <span class="number">20</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    blue = <span class="number">30</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[]) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    struct st sst;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    sst.a = <span class="number">10</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    sst.b = <span class="number">20</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">printf</span>(<span class="string">"struct cpntent is:%d. %d\n"</span>, sst.a, sst.b);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">enum</span> etype et;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    et = red;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">printf</span>(<span class="string">"the color is %d\n"</span>, et);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">    et = blue;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">printf</span>(<span class="string">"the color is %d\n"</span>, et);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>


<h4 id="20-C语言基础之算数运算符与比较运算符"><a href="#20-C语言基础之算数运算符与比较运算符" class="headerlink" title="20.C语言基础之算数运算符与比较运算符"></a>20.C语言基础之算数运算符与比较运算符</h4><ul>
<li>+、-、*、/、%</li>
<li>&lt;=、&lt;、&gt;、&gt;=</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;studio.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> a = <span class="number">10</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> b = <span class="number">20</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> c = a + b;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">printf</span>(<span class="string">"c=%d"</span>, c);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>


<h4 id="21-C语言基础之循环"><a href="#21-C语言基础之循环" class="headerlink" title="21.C语言基础之循环"></a>21.C语言基础之循环</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;studio.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">printf</span>(<span class="string">"i=%d\n"</span>, i);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> j = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">while</span> (j &lt; <span class="number">10</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        printf('j=%d\n', j);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        j++;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>


<h4 id="22-C语言基础之函数"><a href="#22-C语言基础之函数" class="headerlink" title="22.C语言基础之函数"></a>22.C语言基础之函数</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span>  a + b;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">log</span><span class="params">()</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">printf</span>(<span class="string">"this is log info..."</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> result;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    result = sum(<span class="number">1</span>, <span class="number">2</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">printf</span>(<span class="string">"1 + 2 =%d\n"</span>, result);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">log</span>();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>


<h4 id="23-C语言基础之文件操作"><a href="#23-C语言基础之文件操作" class="headerlink" title="23.C语言基础之文件操作"></a>23.C语言基础之文件操作</h4><ul>
<li>问价类型：FILE* file;</li>
<li>打开文件 FILE* fopen(path, mode);</li>
<li>关闭文件 fclose(FILE*);</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;studio.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    FILE* file;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>] = &#123;<span class="number">0</span>,&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    file = fopen(<span class="string">"1.txt"</span>, <span class="string">"a+"</span>); <span class="comment">// 打开一个文件，如果不存在就创建一个同名的文件</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    fwrite(<span class="string">"Hello World"</span>, <span class="number">1</span>, <span class="number">11</span>, file);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    rewind(file); <span class="comment">// 手动将游标放到文件的开头</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    fread(buf, <span class="number">1</span>, <span class="number">11</span>, file);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    fclose(file);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">printf</span>(<span class="string">"buf: %s\n"</span>, buf);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>


<h4 id="24-C语言基础之编译器"><a href="#24-C语言基础之编译器" class="headerlink" title="24.C语言基础之编译器"></a>24.C语言基础之编译器</h4><ul>
<li>Mac上使用clang，Linux上使用gcc</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">1. gcc&#x2F;clang -g -O2 -o test test.c -I... -L... -l</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">-g：输出文件中的调试信息</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">-O：对输出文件做指令优化</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">-o：输出文件</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">-I：指定头文件</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">-L：指定库文件位置</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">-l：指定使用哪个库</span></pre></td></tr></table></figure>

<ul>
<li>预编译：将头文件代码拷贝过来和项目代码合并</li>
<li>编译</li>
<li>链接、动态链接、静态链接</li>
<li>clang -g -c add.c  ==&gt;  add.o</li>
<li>libtool -static -o libmylib.a add.o  生成静态库</li>
<li>静态库代码<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// add.h</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __MY_LIBRARY__</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __MY_LIBRARY__</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span></pre></td></tr></table></figure></li>
<li>引用静态库</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"add.h"</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">printf</span>(<span class="string">"add=%d\n"</span>, add(<span class="number">3</span>, <span class="number">3</span>));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<ul>
<li>编译：clang -g -o testlib testlib.c -I . -L . -l -lmylib</li>
</ul>
<h4 id="25-C语言基础之调试器"><a href="#25-C语言基础之调试器" class="headerlink" title="25.C语言基础之调试器"></a>25.C语言基础之调试器</h4><p>Mac下使用的是LLDB，Linux下使用Gdb</p>
<ul>
<li>编译输出带调试信息的程序</li>
<li>调试信息包含：指令地址、对应源代码及行号</li>
<li>指令完成后，回调</li>
</ul>
<table>
<thead>
<tr>
<th>命令</th>
<th>gdb/lldb</th>
</tr>
</thead>
<tbody><tr>
<td>设置断点</td>
<td>b</td>
</tr>
<tr>
<td>运行程序</td>
<td>r</td>
</tr>
<tr>
<td>单步执行</td>
<td>n</td>
</tr>
<tr>
<td>跳入函数</td>
<td>s</td>
</tr>
<tr>
<td>跳出函数</td>
<td>finish</td>
</tr>
<tr>
<td>打印内容</td>
<td>p</td>
</tr>
</tbody></table>
<ul>
<li>lldb testlib</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">break list &#x2F;&#x2F; 查看断点信息</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">p xxx &#x2F;&#x2F; 打印变量信息</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">c &#x2F;&#x2F; 一次执行完毕</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">n &#x2F;&#x2F; 下一步</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">quit &#x2F;&#x2F; 退出当前程序</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">xxx.dSYM &#x2F;&#x2F; 带调试信息的编译后文件，使用dwarfdump xxx 即可查看对应的调试文件</span></pre></td></tr></table></figure>


<h4 id="27-ffmpeg代码结构"><a href="#27-ffmpeg代码结构" class="headerlink" title="27.ffmpeg代码结构"></a>27.ffmpeg代码结构</h4><table>
<thead>
<tr>
<th>文件夹</th>
<th>描述信息</th>
</tr>
</thead>
<tbody><tr>
<td>libavcodec</td>
<td>提供了一系列编码器的实现</td>
</tr>
<tr>
<td>libavformat</td>
<td>实现在流协议，容器格式及基本IO访问</td>
</tr>
<tr>
<td>libavutil</td>
<td>包括了hash器，解码器和各种工具函数</td>
</tr>
<tr>
<td>libavfilter</td>
<td>提供了各种音视频过滤器</td>
</tr>
<tr>
<td>libavdevice</td>
<td>提供了访问捕获设备和回访设备的接口</td>
</tr>
<tr>
<td>libswresample</td>
<td>实现了混音和重采样</td>
</tr>
<tr>
<td>libswscale</td>
<td>实现了色彩转换和缩放功能</td>
</tr>
</tbody></table>
<h4 id="28-ffmpeg日志系统"><a href="#28-ffmpeg日志系统" class="headerlink" title="28.ffmpeg日志系统"></a>28.ffmpeg日志系统</h4><ul>
<li>include &lt;libavutil/log.h&gt;  日志头文件</li>
<li>av_log_set_level(AV_LOG_DEBUG)  设置debug样式界别</li>
<li>av_log(NULL, AV_LOG_INFO, “..%s\n”, op)  日志打印</li>
<li>常用日志级别<ul>
<li>AV_LOG_ERROR </li>
<li>AV_LOG_WARNING</li>
<li>AV_LOG_INFO</li>
<li>AV_:OG_DEBUG</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavutil/log.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    av_log_set_level(AV_LOG_DEBUG);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    av_log(<span class="literal">NULL</span>, AV_LOG_INFO, <span class="string">"Hello WOrld!:%s\n"</span>, <span class="string">"Hi~"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<ul>
<li>执行命令：clang -g -o ffmpeg_log ffmpeg_log.c -lavutil</li>
</ul>
<h4 id="29-ffmpeg文件的删除与重命名"><a href="#29-ffmpeg文件的删除与重命名" class="headerlink" title="29.ffmpeg文件的删除与重命名"></a>29.ffmpeg文件的删除与重命名</h4><ul>
<li>avpriv_io_delete()</li>
<li>avpriv_io_move()</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavformat/avformat.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> ret;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    ret = avpriv_io_move(<span class="string">"111.txt"</span>, <span class="string">"222.txt"</span>); <span class="comment">// 重命名文件</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Failed to rename\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    av_log(<span class="literal">NULL</span>, AV_LOG_INFO, <span class="string">"Success to rename\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    ret = avpriv_io_delete(<span class="string">"./mytestfile.txt"</span>); <span class="comment">// 删除文件</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Failed to delete file mytestfile.txt\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    av_log(<span class="literal">NULL</span>, AV_LOG_INFO, <span class="string">"Success to delete mytestfile.txt\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<ul>
<li>执行程序：clang -g -o ffmpeg_del ffmpeg_file.c <code>pkg-config --libs libavformat</code></li>
</ul>
<h4 id="30-ffmpeg操作目录函数"><a href="#30-ffmpeg操作目录函数" class="headerlink" title="30.ffmpeg操作目录函数"></a>30.ffmpeg操作目录函数</h4><ul>
<li>avio_open_dir()</li>
<li>avio_read_dir()</li>
<li>avio_close_dir()<ul>
<li>AVIO_DirContext操作目录的上下文</li>
<li>AVIODirEntry目录想，用于存放文件名、文件属性等等</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavutil/log.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavformat/avformat.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> ret;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    AVIODirEntry *entry = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    AVIODirCotext *ctx = <span class="literal">NULL</span>:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    av_log_set_level(AV_LOG_INFO);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    ret = avio_open_dir(&amp;ctx, <span class="string">"./"</span>, <span class="literal">NULL</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Cant open dir:%s\n"</span>, av_err2str(ret));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">        ret = avio_read_dir(ctx, &amp;entry);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">            av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Cant read dir:%s\n"</span>, av_err2str(ret));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">goto</span> __fail;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (!entry) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_INFO, <span class="string">"%12"</span>PRId64<span class="string">" %s \n"</span>, entry-&gt;<span class="built_in">size</span>, entry-&gt;name);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">        avio_free_directory_entry(&amp;entry); <span class="comment">// 释放内存</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    __fail;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">    avio_close_dir(&amp;ctx);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>


<h4 id="31-多媒体文件"><a href="#31-多媒体文件" class="headerlink" title="31.多媒体文件"></a>31.多媒体文件</h4><ul>
<li>多媒体文件其实就是个容器</li>
<li>在容器里又很多流（Stream/Track）</li>
<li>每种流是由不同的编码器编码的</li>
<li>从流中读取的数据称为包</li>
<li>在一个包中包含着一个或多个帧</li>
<li>AVFormatContext   读取多媒体文件的上下文</li>
<li>AVStream</li>
<li>AVPacket</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">解复用 -- 获取流 -- 读取数据包 -- 释放资源</span></pre></td></tr></table></figure>


<h4 id="32-打印音视频信息"><a href="#32-打印音视频信息" class="headerlink" title="32.打印音视频信息"></a>32.打印音视频信息</h4><ul>
<li>av_register_all()</li>
<li>avformat_open_input() / avformat_close_input()</li>
<li>av_dump_format()</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavutil/log.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavformat/avformat.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> ret;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    AVFormatContext *fmt_ctx = <span class="literal">NULL</span>: <span class="comment">// 格式上下文</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    av_log_set_level(AV_LOG_INFO);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    av_register_all(); <span class="comment">// 注册各种解码器、协议等等</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    ret = avformat_open_input(&amp;fmt_ctx, <span class="string">"./test.mp4"</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"Cant open file: %s\n"</span>, averr2str(ret));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    av_dump_format(fmt_ctx, <span class="number">0</span>, <span class="string">"./test.mp4"</span>, <span class="number">0</span>); <span class="comment">// 打印metadata</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    avformat_close_input(&amp;fmt_ctx);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<ul>
<li>执行程序：clang -g -o mediainfo mediainfo.c <code>pkg-config --libs libavutil libavformat</code></li>
</ul>
<h4 id="33-抽取音频数据"><a href="#33-抽取音频数据" class="headerlink" title="33.抽取音频数据"></a>33.抽取音频数据</h4><ul>
<li>av_init_packet()  初始化数据包结构体</li>
<li>av_find_best_stream()   从对媒体文件中找到最好的一路流</li>
<li>av_read_frame()/av_packet_unref()   读取流中的数据包/释放读取之后的引用计数-1，防止内存泄漏</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavutil/log.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavformat/avformat.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ADTS_HEADER_LEN 7;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">adts_header</span><span class="params">(<span class="keyword">char</span> *szAdtsHeader, <span class="keyword">int</span> dataLen)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> audio_object_type = <span class="number">2</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> sampling_frequency_index = <span class="number">7</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> channel_config = <span class="number">2</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> adtsLen = dataLen + <span class="number">7</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    szAdtsHeader[<span class="number">0</span>] = <span class="number">0xff</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    szAdtsHeader[<span class="number">1</span>] = <span class="number">0xf0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    szAdtsHeader[<span class="number">1</span>] |= (<span class="number">0</span> &lt;&lt; <span class="number">3</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    szAdtsHeader[<span class="number">1</span>] |= (<span class="number">0</span> &lt;&lt; <span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    szAdtsHeader[<span class="number">1</span>] |= <span class="number">1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    szAdtsHeader[<span class="number">2</span>] = (audio_object_type - <span class="number">1</span>) &lt;&lt; <span class="number">6</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    szAdtsHeader[<span class="number">2</span>] |= (sampling_frequency_index &amp; <span class="number">0x0f</span>) &lt;&lt; <span class="number">2</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    szAdtsHeader[<span class="number">2</span>] |= (<span class="number">0</span> &lt;&lt; <span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    szAdtsHeader[<span class="number">2</span>] |= (channel_config &amp; <span class="number">0x04</span>) &gt;&gt; <span class="number">2</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    szAdtsHeader[<span class="number">3</span>] = (channel_config &amp; <span class="number">0x03</span>) &lt;&lt; <span class="number">6</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    szAdtsHeader[<span class="number">3</span>] |= (<span class="number">0</span> &lt;&lt; <span class="number">5</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">    szAdtsHeader[<span class="number">3</span>] |= (<span class="number">0</span> &lt;&lt; <span class="number">4</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">    szAdtsHeader[<span class="number">3</span>] |= (<span class="number">0</span> &lt;&lt; <span class="number">3</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    szAdtsHeader[<span class="number">3</span>] |= (<span class="number">0</span> &lt;&lt; <span class="number">2</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">    szAdtsHeader[<span class="number">3</span>] |= ((adtsLen &amp; <span class="number">0x1800</span>) &gt;&gt; <span class="number">11</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">    szAdtsHeader[<span class="number">4</span>] = (<span class="keyword">uint8_t</span>)((adtsLen &amp; <span class="number">0x7f8</span>) &gt;&gt; <span class="number">3</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">    szAdtsHeader[<span class="number">5</span>] = (<span class="keyword">uint8_t</span>)((adtsLen &amp; <span class="number">0x7</span>) &lt;&lt; <span class="number">5</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">    szAdtsHeader[<span class="number">5</span>] = <span class="number">0x1f</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">    szAdtsHeader[<span class="number">6</span>] = <span class="number">0xfc</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> ret;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> len;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> audio_index;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">char</span>* src = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">char</span>* dst = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">    AVPacket pkt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">    AVFormatContext *fmt_ctx = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">    av_log_set_level(AV_LOG_INFO);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// av_register_all(); // 注册各种解码器、协议等等，ffmpeg4.0之后不再需要手动注册</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 第一步：从控制台读取两次参数</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">3</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"the count of params should be more than three! \n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">51</span></pre></td><td class="code"><pre><span class="line">    src = argv[<span class="number">1</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">52</span></pre></td><td class="code"><pre><span class="line">    dst = argv[<span class="number">2</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">53</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!src || !dst) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">54</span></pre></td><td class="code"><pre><span class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"src or dst is null! \n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">55</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">56</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">57</span></pre></td><td class="code"><pre><span class="line">    ret = avformat_open_input(&amp;fmt_ctx, src, <span class="literal">NULL</span>, <span class="literal">NULL</span>); <span class="comment">// 读取多媒体文件</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">58</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">59</span></pre></td><td class="code"><pre><span class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"can not open file: %s\n"</span>, av_err2str(ret));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">60</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">61</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">62</span></pre></td><td class="code"><pre><span class="line">    FILE* dst_fd = fopen(dst, <span class="string">"wb"</span>); <span class="comment">// 以只写的方式打开一个二进制文件，若无则创建这个文件</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">63</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!dst_fd) &#123; <span class="comment">// 判断输出文件是否存在</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">64</span></pre></td><td class="code"><pre><span class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"can not open out file! \n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">65</span></pre></td><td class="code"><pre><span class="line">        avformat_close_input(&amp;fmt_ctx);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">66</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">67</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">68</span></pre></td><td class="code"><pre><span class="line">    av_dump_format(fmt_ctx, <span class="number">0</span>, src, <span class="number">0</span>); <span class="comment">// 打印metadata</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">69</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 2.第二步：获取流</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">70</span></pre></td><td class="code"><pre><span class="line">    ret = av_find_best_stream(fmt_ctx, AVMEDIA_TYPE_AUDIO, <span class="number">-1</span>, <span class="number">-1</span>, <span class="literal">NULL</span>, <span class="number">0</span>); <span class="comment">// 音频</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">71</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">72</span></pre></td><td class="code"><pre><span class="line">        av_log(<span class="literal">NULL</span>, AV_LOG_ERROR, <span class="string">"can not find the best stream!\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">73</span></pre></td><td class="code"><pre><span class="line">        avformat_close_input(&amp;fmt_ctx);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">74</span></pre></td><td class="code"><pre><span class="line">        fclose(dst_fd);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">75</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">76</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">77</span></pre></td><td class="code"><pre><span class="line">    audio_index = ret;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">78</span></pre></td><td class="code"><pre><span class="line">    av_init_packet(&amp;pkt);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">79</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">while</span>(av_read_frame(fmt_ctx, &amp;pkt) &gt;= <span class="number">0</span>) &#123; <span class="comment">// 读取流中的所有数据包</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">80</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span>(pkt.stream_index == audio_index) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">81</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">char</span> adts_header_buf[<span class="number">7</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">82</span></pre></td><td class="code"><pre><span class="line">            adts_header(adts_header_buf, pkt.<span class="built_in">size</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">83</span></pre></td><td class="code"><pre><span class="line">            fwrite(adts_header_buf, <span class="number">1</span>, <span class="number">7</span>, dst_fd);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">84</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 第三步：读取流数据包</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">85</span></pre></td><td class="code"><pre><span class="line">            len = fwrite(pkt.data, <span class="number">1</span>, pkt.<span class="built_in">size</span>, dst_fd);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">86</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">if</span>(len != pkt.<span class="built_in">size</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">87</span></pre></td><td class="code"><pre><span class="line">                av_log(<span class="literal">NULL</span>, AV_LOG_WARNING, <span class="string">"warning length of data is not equal size of pkt! \n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">88</span></pre></td><td class="code"><pre><span class="line">            &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">89</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">90</span></pre></td><td class="code"><pre><span class="line">        av_packet_unref(&amp;pkt);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">91</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">92</span></pre></td><td class="code"><pre><span class="line">    avformat_close_input(&amp;fmt_ctx);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">93</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (dst_fd) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">94</span></pre></td><td class="code"><pre><span class="line">        fclose(dst_fd);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">95</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">96</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">97</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">98</span></pre></td><td class="code"><pre><span class="line">```  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">99</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">100</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">101</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">102</span></pre></td><td class="code"><pre><span class="line">#### <span class="number">34.</span>抽取视频数据</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">103</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">104</span></pre></td><td class="code"><pre><span class="line">- Start code  特征码</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">105</span></pre></td><td class="code"><pre><span class="line">- SPS/PPS  去解码的视频参数  超级小，一般每一帧前面加</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">106</span></pre></td><td class="code"><pre><span class="line">- codec -&gt; extradata  获取SPS/PPS，在编码器的扩展数据空间里获取</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">107</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">108</span></pre></td><td class="code"><pre><span class="line">```c</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">109</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavutil/log.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">110</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavformat/avformat.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">111</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">112</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">113</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">114</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>


<h4 id="35-将MP4转成FLV格式"><a href="#35-将MP4转成FLV格式" class="headerlink" title="35.将MP4转成FLV格式"></a>35.将MP4转成FLV格式</h4><ul>
<li>avformat_alloc_output_context2() / avformat_free_context()</li>
<li>avformat_new_stream()</li>
<li>avcodec_parameters_copy()</li>
<li>avformat_write_header()</li>
<li>av_write_frame() / av_interleaved_write_frame()</li>
<li>av_write_trailer()</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavutil/timestamp.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavformat/avformat.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">log_packet</span><span class="params">(<span class="keyword">const</span> AVFormatContext *fmt_ctx, <span class="keyword">const</span> AVPacket *pkt, <span class="keyword">const</span> <span class="keyword">char</span> *tag)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    AVRational *time_base = &amp;fmt_ctx-&gt;streams[pkt-&gt;stream_index]-&gt;time_base;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s: pts:%s pts_time:%s dts:%s dts_time:%s duration:%s duration_time:%s stream_index:%d\n"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">           tag,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">           av_ts2str(pkt-&gt;pts), av_ts2timestr(pkt-&gt;pts, time_base),</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">           av_ts2str(pkt-&gt;dts), av_ts2timestr(pkt-&gt;dts, time_base),</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">           av_ts2str(pkt-&gt;duration), av_ts2timestr(pkt-&gt;duration, time_base),</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">           pkt-&gt;stream_index);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    AVOutputFormat *ofmt = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    AVFormatContext *ifmt_ctx = <span class="literal">NULL</span>, *ofmt_ctx = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    AVPacket pkt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *in_filename, *out_filename;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> ret, i;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> stream_index = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> *stream_mapping = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> stream_mapping_size = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">3</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">printf</span>(<span class="string">"usage: %s input output\n"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">               <span class="string">"API example program to remux a media file with libavformat and libavcodec.\n"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">               <span class="string">"The output format is guessed according to the file extension.\n"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">               <span class="string">"\n"</span>, argv[<span class="number">0</span>]);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">    in_filename  = argv[<span class="number">1</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">    out_filename = argv[<span class="number">2</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">    av_register_all();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> ((ret = avformat_open_input(&amp;ifmt_ctx, in_filename, <span class="number">0</span>, <span class="number">0</span>)) &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Could not open input file '%s'"</span>, in_filename);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">goto</span> <span class="built_in">end</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> ((ret = avformat_find_stream_info(ifmt_ctx, <span class="number">0</span>)) &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Failed to retrieve input stream information"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">goto</span> <span class="built_in">end</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line">    av_dump_format(ifmt_ctx, <span class="number">0</span>, in_filename, <span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">51</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">52</span></pre></td><td class="code"><pre><span class="line">    avformat_alloc_output_context2(&amp;ofmt_ctx, <span class="literal">NULL</span>, <span class="literal">NULL</span>, out_filename);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">53</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!ofmt_ctx) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">54</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Could not create output context\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">55</span></pre></td><td class="code"><pre><span class="line">        ret = AVERROR_UNKNOWN;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">56</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">goto</span> <span class="built_in">end</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">57</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">58</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">59</span></pre></td><td class="code"><pre><span class="line">    stream_mapping_size = ifmt_ctx-&gt;nb_streams;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">60</span></pre></td><td class="code"><pre><span class="line">    stream_mapping = av_mallocz_array(stream_mapping_size, <span class="keyword">sizeof</span>(*stream_mapping));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">61</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!stream_mapping) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">62</span></pre></td><td class="code"><pre><span class="line">        ret = AVERROR(ENOMEM);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">63</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">goto</span> <span class="built_in">end</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">64</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">65</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">66</span></pre></td><td class="code"><pre><span class="line">    ofmt = ofmt_ctx-&gt;oformat;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">67</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">68</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ifmt_ctx-&gt;nb_streams; i++) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">69</span></pre></td><td class="code"><pre><span class="line">        AVStream *out_stream;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">70</span></pre></td><td class="code"><pre><span class="line">        AVStream *in_stream = ifmt_ctx-&gt;streams[i];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">71</span></pre></td><td class="code"><pre><span class="line">        AVCodecParameters *in_codecpar = in_stream-&gt;codecpar;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">72</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">73</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (in_codecpar-&gt;codec_type != AVMEDIA_TYPE_AUDIO &amp;&amp;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">74</span></pre></td><td class="code"><pre><span class="line">            in_codecpar-&gt;codec_type != AVMEDIA_TYPE_VIDEO &amp;&amp;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">75</span></pre></td><td class="code"><pre><span class="line">            in_codecpar-&gt;codec_type != AVMEDIA_TYPE_SUBTITLE) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">76</span></pre></td><td class="code"><pre><span class="line">            stream_mapping[i] = <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">77</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">continue</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">78</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">79</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">80</span></pre></td><td class="code"><pre><span class="line">        stream_mapping[i] = stream_index++;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">81</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">82</span></pre></td><td class="code"><pre><span class="line">        out_stream = avformat_new_stream(ofmt_ctx, <span class="literal">NULL</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">83</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (!out_stream) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">84</span></pre></td><td class="code"><pre><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Failed allocating output stream\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">85</span></pre></td><td class="code"><pre><span class="line">            ret = AVERROR_UNKNOWN;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">86</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">goto</span> <span class="built_in">end</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">87</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">88</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">89</span></pre></td><td class="code"><pre><span class="line">        ret = avcodec_parameters_copy(out_stream-&gt;codecpar, in_codecpar);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">90</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">91</span></pre></td><td class="code"><pre><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Failed to copy codec parameters\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">92</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">goto</span> <span class="built_in">end</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">93</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">94</span></pre></td><td class="code"><pre><span class="line">        out_stream-&gt;codecpar-&gt;codec_tag = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">95</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">96</span></pre></td><td class="code"><pre><span class="line">    av_dump_format(ofmt_ctx, <span class="number">0</span>, out_filename, <span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">97</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">98</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!(ofmt-&gt;flags &amp; AVFMT_NOFILE)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">99</span></pre></td><td class="code"><pre><span class="line">        ret = avio_open(&amp;ofmt_ctx-&gt;pb, out_filename, AVIO_FLAG_WRITE);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">100</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">101</span></pre></td><td class="code"><pre><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Could not open output file '%s'"</span>, out_filename);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">102</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">goto</span> <span class="built_in">end</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">103</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">104</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">105</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">106</span></pre></td><td class="code"><pre><span class="line">    ret = avformat_write_header(ofmt_ctx, <span class="literal">NULL</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">107</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">108</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error occurred when opening output file\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">109</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">goto</span> <span class="built_in">end</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">110</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">111</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">112</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">113</span></pre></td><td class="code"><pre><span class="line">        AVStream *in_stream, *out_stream;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">114</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">115</span></pre></td><td class="code"><pre><span class="line">        ret = av_read_frame(ifmt_ctx, &amp;pkt);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">116</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">117</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">118</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">119</span></pre></td><td class="code"><pre><span class="line">        in_stream  = ifmt_ctx-&gt;streams[pkt.stream_index];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">120</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (pkt.stream_index &gt;= stream_mapping_size ||</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">121</span></pre></td><td class="code"><pre><span class="line">            stream_mapping[pkt.stream_index] &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">122</span></pre></td><td class="code"><pre><span class="line">            av_packet_unref(&amp;pkt);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">123</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">continue</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">124</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">125</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">126</span></pre></td><td class="code"><pre><span class="line">        pkt.stream_index = stream_mapping[pkt.stream_index];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">127</span></pre></td><td class="code"><pre><span class="line">        out_stream = ofmt_ctx-&gt;streams[pkt.stream_index];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">128</span></pre></td><td class="code"><pre><span class="line">        log_packet(ifmt_ctx, &amp;pkt, <span class="string">"in"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">129</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">130</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">/* copy packet */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">131</span></pre></td><td class="code"><pre><span class="line">        pkt.pts = av_rescale_q_rnd(pkt.pts, in_stream-&gt;time_base, out_stream-&gt;time_base, AV_ROUND_NEAR_INF|AV_ROUND_PASS_MINMAX);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">132</span></pre></td><td class="code"><pre><span class="line">        pkt.dts = av_rescale_q_rnd(pkt.dts, in_stream-&gt;time_base, out_stream-&gt;time_base, AV_ROUND_NEAR_INF|AV_ROUND_PASS_MINMAX);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">133</span></pre></td><td class="code"><pre><span class="line">        pkt.duration = av_rescale_q(pkt.duration, in_stream-&gt;time_base, out_stream-&gt;time_base);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">134</span></pre></td><td class="code"><pre><span class="line">        pkt.pos = <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">135</span></pre></td><td class="code"><pre><span class="line">        log_packet(ofmt_ctx, &amp;pkt, <span class="string">"out"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">136</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">137</span></pre></td><td class="code"><pre><span class="line">        ret = av_interleaved_write_frame(ofmt_ctx, &amp;pkt);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">138</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">139</span></pre></td><td class="code"><pre><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error muxing packet\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">140</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">141</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">142</span></pre></td><td class="code"><pre><span class="line">        av_packet_unref(&amp;pkt);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">143</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">144</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">145</span></pre></td><td class="code"><pre><span class="line">    av_write_trailer(ofmt_ctx);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">146</span></pre></td><td class="code"><pre><span class="line"><span class="built_in">end</span>:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">147</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">148</span></pre></td><td class="code"><pre><span class="line">    avformat_close_input(&amp;ifmt_ctx);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">149</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">150</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* close output */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">151</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (ofmt_ctx &amp;&amp; !(ofmt-&gt;flags &amp; AVFMT_NOFILE))</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">152</span></pre></td><td class="code"><pre><span class="line">        avio_closep(&amp;ofmt_ctx-&gt;pb);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">153</span></pre></td><td class="code"><pre><span class="line">    avformat_free_context(ofmt_ctx);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">154</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">155</span></pre></td><td class="code"><pre><span class="line">    av_freep(&amp;stream_mapping);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">156</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">157</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span> &amp;&amp; ret != AVERROR_EOF) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">158</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error occurred: %s\n"</span>, av_err2str(ret));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">159</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">160</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">161</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">162</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">163</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">164</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">165</span></pre></td><td class="code"><pre><span class="line">```  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">166</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">167</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">168</span></pre></td><td class="code"><pre><span class="line">#### <span class="number">36.</span>cong从MP4截取一段视频</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">169</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">170</span></pre></td><td class="code"><pre><span class="line">- av_seek_frame()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">171</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">172</span></pre></td><td class="code"><pre><span class="line">```c</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">173</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">174</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavutil/timestamp.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">175</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavformat/avformat.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">176</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">177</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">log_packet</span><span class="params">(<span class="keyword">const</span> AVFormatContext *fmt_ctx, <span class="keyword">const</span> AVPacket *pkt, <span class="keyword">const</span> <span class="keyword">char</span> *tag)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">178</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">179</span></pre></td><td class="code"><pre><span class="line">    AVRational *time_base = &amp;fmt_ctx-&gt;streams[pkt-&gt;stream_index]-&gt;time_base;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">180</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">181</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s: pts:%s pts_time:%s dts:%s dts_time:%s duration:%s duration_time:%s stream_index:%d\n"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">182</span></pre></td><td class="code"><pre><span class="line">           tag,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">183</span></pre></td><td class="code"><pre><span class="line">           av_ts2str(pkt-&gt;pts), av_ts2timestr(pkt-&gt;pts, time_base),</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">184</span></pre></td><td class="code"><pre><span class="line">           av_ts2str(pkt-&gt;dts), av_ts2timestr(pkt-&gt;dts, time_base),</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">185</span></pre></td><td class="code"><pre><span class="line">           av_ts2str(pkt-&gt;duration), av_ts2timestr(pkt-&gt;duration, time_base),</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">186</span></pre></td><td class="code"><pre><span class="line">           pkt-&gt;stream_index);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">187</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">188</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">189</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">cut_video</span><span class="params">(<span class="keyword">double</span> from_seconds, <span class="keyword">double</span> end_seconds, <span class="keyword">const</span> <span class="keyword">char</span>* in_filename, <span class="keyword">const</span> <span class="keyword">char</span>* out_filename)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">190</span></pre></td><td class="code"><pre><span class="line">    AVOutputFormat *ofmt = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">191</span></pre></td><td class="code"><pre><span class="line">    AVFormatContext *ifmt_ctx = <span class="literal">NULL</span>, *ofmt_ctx = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">192</span></pre></td><td class="code"><pre><span class="line">    AVPacket pkt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">193</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> ret, i;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">194</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">195</span></pre></td><td class="code"><pre><span class="line">    av_register_all();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">196</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">197</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> ((ret = avformat_open_input(&amp;ifmt_ctx, in_filename, <span class="number">0</span>, <span class="number">0</span>)) &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">198</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Could not open input file '%s'"</span>, in_filename);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">199</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">goto</span> <span class="built_in">end</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">200</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">201</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">202</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> ((ret = avformat_find_stream_info(ifmt_ctx, <span class="number">0</span>)) &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">203</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Failed to retrieve input stream information"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">204</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">goto</span> <span class="built_in">end</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">205</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">206</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">207</span></pre></td><td class="code"><pre><span class="line">    av_dump_format(ifmt_ctx, <span class="number">0</span>, in_filename, <span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">208</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">209</span></pre></td><td class="code"><pre><span class="line">    avformat_alloc_output_context2(&amp;ofmt_ctx, <span class="literal">NULL</span>, <span class="literal">NULL</span>, out_filename);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">210</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!ofmt_ctx) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">211</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Could not create output context\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">212</span></pre></td><td class="code"><pre><span class="line">        ret = AVERROR_UNKNOWN;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">213</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">goto</span> <span class="built_in">end</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">214</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">215</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">216</span></pre></td><td class="code"><pre><span class="line">    ofmt = ofmt_ctx-&gt;oformat;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">217</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">218</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ifmt_ctx-&gt;nb_streams; i++) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">219</span></pre></td><td class="code"><pre><span class="line">        AVStream *in_stream = ifmt_ctx-&gt;streams[i];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">220</span></pre></td><td class="code"><pre><span class="line">        AVStream *out_stream = avformat_new_stream(ofmt_ctx, in_stream-&gt;codec-&gt;codec);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">221</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (!out_stream) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">222</span></pre></td><td class="code"><pre><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Failed allocating output stream\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">223</span></pre></td><td class="code"><pre><span class="line">            ret = AVERROR_UNKNOWN;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">224</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">goto</span> <span class="built_in">end</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">225</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">226</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">227</span></pre></td><td class="code"><pre><span class="line">        ret = avcodec_copy_context(out_stream-&gt;codec, in_stream-&gt;codec);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">228</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">229</span></pre></td><td class="code"><pre><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Failed to copy context from input to output stream codec context\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">230</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">goto</span> <span class="built_in">end</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">231</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">232</span></pre></td><td class="code"><pre><span class="line">        out_stream-&gt;codec-&gt;codec_tag = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">233</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (ofmt_ctx-&gt;oformat-&gt;flags &amp; AVFMT_GLOBALHEADER)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">234</span></pre></td><td class="code"><pre><span class="line">            out_stream-&gt;codec-&gt;flags |= AV_CODEC_FLAG_GLOBAL_HEADER;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">235</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">236</span></pre></td><td class="code"><pre><span class="line">    av_dump_format(ofmt_ctx, <span class="number">0</span>, out_filename, <span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">237</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">238</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!(ofmt-&gt;flags &amp; AVFMT_NOFILE)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">239</span></pre></td><td class="code"><pre><span class="line">        ret = avio_open(&amp;ofmt_ctx-&gt;pb, out_filename, AVIO_FLAG_WRITE);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">240</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">241</span></pre></td><td class="code"><pre><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Could not open output file '%s'"</span>, out_filename);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">242</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">goto</span> <span class="built_in">end</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">243</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">244</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">245</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">246</span></pre></td><td class="code"><pre><span class="line">    ret = avformat_write_header(ofmt_ctx, <span class="literal">NULL</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">247</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">248</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error occurred when opening output file\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">249</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">goto</span> <span class="built_in">end</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">250</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">251</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">252</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//    int indexs[8] = &#123;0&#125;;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">253</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">254</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">255</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//    int64_t start_from = 8*AV_TIME_BASE;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">256</span></pre></td><td class="code"><pre><span class="line">    ret = av_seek_frame(ifmt_ctx, <span class="number">-1</span>, from_seconds*AV_TIME_BASE, AVSEEK_FLAG_ANY);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">257</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">258</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error seek\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">259</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">goto</span> <span class="built_in">end</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">260</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">261</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">262</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int64_t</span> *dts_start_from = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">int64_t</span>) * ifmt_ctx-&gt;nb_streams);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">263</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">memset</span>(dts_start_from, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">int64_t</span>) * ifmt_ctx-&gt;nb_streams);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">264</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int64_t</span> *pts_start_from = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">int64_t</span>) * ifmt_ctx-&gt;nb_streams);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">265</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">memset</span>(pts_start_from, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">int64_t</span>) * ifmt_ctx-&gt;nb_streams);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">266</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">267</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">268</span></pre></td><td class="code"><pre><span class="line">        AVStream *in_stream, *out_stream;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">269</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">270</span></pre></td><td class="code"><pre><span class="line">        ret = av_read_frame(ifmt_ctx, &amp;pkt);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">271</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">272</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">273</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">274</span></pre></td><td class="code"><pre><span class="line">        in_stream  = ifmt_ctx-&gt;streams[pkt.stream_index];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">275</span></pre></td><td class="code"><pre><span class="line">        out_stream = ofmt_ctx-&gt;streams[pkt.stream_index];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">276</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">277</span></pre></td><td class="code"><pre><span class="line">        log_packet(ifmt_ctx, &amp;pkt, <span class="string">"in"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">278</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">279</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (av_q2d(in_stream-&gt;time_base) * pkt.pts &gt; end_seconds) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">280</span></pre></td><td class="code"><pre><span class="line">            av_free_packet(&amp;pkt);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">281</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">282</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">283</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">284</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (dts_start_from[pkt.stream_index] == <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">285</span></pre></td><td class="code"><pre><span class="line">            dts_start_from[pkt.stream_index] = pkt.dts;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">286</span></pre></td><td class="code"><pre><span class="line">            <span class="built_in">printf</span>(<span class="string">"dts_start_from: %s\n"</span>, av_ts2str(dts_start_from[pkt.stream_index]));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">287</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">288</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (pts_start_from[pkt.stream_index] == <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">289</span></pre></td><td class="code"><pre><span class="line">            pts_start_from[pkt.stream_index] = pkt.pts;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">290</span></pre></td><td class="code"><pre><span class="line">            <span class="built_in">printf</span>(<span class="string">"pts_start_from: %s\n"</span>, av_ts2str(pts_start_from[pkt.stream_index]));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">291</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">292</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">293</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">/* copy packet */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">294</span></pre></td><td class="code"><pre><span class="line">        pkt.pts = av_rescale_q_rnd(pkt.pts - pts_start_from[pkt.stream_index], in_stream-&gt;time_base, out_stream-&gt;time_base, AV_ROUND_NEAR_INF|AV_ROUND_PASS_MINMAX);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">295</span></pre></td><td class="code"><pre><span class="line">        pkt.dts = av_rescale_q_rnd(pkt.dts - dts_start_from[pkt.stream_index], in_stream-&gt;time_base, out_stream-&gt;time_base, AV_ROUND_NEAR_INF|AV_ROUND_PASS_MINMAX);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">296</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (pkt.pts &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">297</span></pre></td><td class="code"><pre><span class="line">            pkt.pts = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">298</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">299</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (pkt.dts &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">300</span></pre></td><td class="code"><pre><span class="line">            pkt.dts = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">301</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">302</span></pre></td><td class="code"><pre><span class="line">        pkt.duration = (<span class="keyword">int</span>)av_rescale_q((<span class="keyword">int64_t</span>)pkt.duration, in_stream-&gt;time_base, out_stream-&gt;time_base);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">303</span></pre></td><td class="code"><pre><span class="line">        pkt.pos = <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">304</span></pre></td><td class="code"><pre><span class="line">        log_packet(ofmt_ctx, &amp;pkt, <span class="string">"out"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">305</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">306</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">307</span></pre></td><td class="code"><pre><span class="line">        ret = av_interleaved_write_frame(ofmt_ctx, &amp;pkt);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">308</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">309</span></pre></td><td class="code"><pre><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error muxing packet\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">310</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">311</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">312</span></pre></td><td class="code"><pre><span class="line">        av_free_packet(&amp;pkt);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">313</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">314</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">free</span>(dts_start_from);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">315</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">free</span>(pts_start_from);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">316</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">317</span></pre></td><td class="code"><pre><span class="line">    av_write_trailer(ofmt_ctx);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">318</span></pre></td><td class="code"><pre><span class="line"><span class="built_in">end</span>:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">319</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">320</span></pre></td><td class="code"><pre><span class="line">    avformat_close_input(&amp;ifmt_ctx);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">321</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">322</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* close output */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">323</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (ofmt_ctx &amp;&amp; !(ofmt-&gt;flags &amp; AVFMT_NOFILE))</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">324</span></pre></td><td class="code"><pre><span class="line">        avio_closep(&amp;ofmt_ctx-&gt;pb);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">325</span></pre></td><td class="code"><pre><span class="line">    avformat_free_context(ofmt_ctx);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">326</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">327</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span> &amp;&amp; ret != AVERROR_EOF) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">328</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error occurred: %s\n"</span>, av_err2str(ret));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">329</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">330</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">331</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">332</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">333</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">334</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">335</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">336</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(argc &lt; <span class="number">5</span>)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">337</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Usage: \</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">338</span></pre></td><td class="code"><pre><span class="line"><span class="string">                command startime, endtime, srcfile, outfile"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">339</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">340</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">341</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">342</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">double</span> startime = atoi(argv[<span class="number">1</span>]);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">343</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">double</span> endtime = atoi(argv[<span class="number">2</span>]);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">344</span></pre></td><td class="code"><pre><span class="line">    cut_video(startime, endtime, argv[<span class="number">3</span>], argv[<span class="number">4</span>]);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">345</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">346</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">347</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">348</span></pre></td><td class="code"><pre><span class="line">```  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">349</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">350</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">351</span></pre></td><td class="code"><pre><span class="line">#### <span class="number">37.</span>h264解码</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">352</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">353</span></pre></td><td class="code"><pre><span class="line">- 常用数据结构体</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">354</span></pre></td><td class="code"><pre><span class="line">    - AVCodec 编码器结构体</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">355</span></pre></td><td class="code"><pre><span class="line">    - AVCodecCotext 编码器上下文</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">356</span></pre></td><td class="code"><pre><span class="line">    - AVFrame 解码后的帧</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">357</span></pre></td><td class="code"><pre><span class="line">- av_frame_alloc() / av_frame_free()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">358</span></pre></td><td class="code"><pre><span class="line">- avcodec_alloc_context3()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">359</span></pre></td><td class="code"><pre><span class="line">- avcodec_free_context()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">360</span></pre></td><td class="code"><pre><span class="line">- 解码步骤</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">361</span></pre></td><td class="code"><pre><span class="line">    <span class="number">1.</span> 查找解码器（avcodec_find_decoder / avcodec_find_encoder_by_name）</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">362</span></pre></td><td class="code"><pre><span class="line">    <span class="number">2.</span> 打开解码器（avcodec_open2）</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">363</span></pre></td><td class="code"><pre><span class="line">    <span class="number">3.</span> 解码（avcodec_decode_video2）</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">364</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">365</span></pre></td><td class="code"><pre><span class="line">- h264编码流程</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">366</span></pre></td><td class="code"><pre><span class="line">    <span class="number">1.</span> 查找编码器（avcodec_find_encoder_by_name）</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">367</span></pre></td><td class="code"><pre><span class="line">    <span class="number">2.</span> 设置编码参数，并打开编码器（avcodec_open2）</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">368</span></pre></td><td class="code"><pre><span class="line">    <span class="number">3.</span> 编码（avcodec_encode_video2）</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">369</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">370</span></pre></td><td class="code"><pre><span class="line">```c</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">371</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">372</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">373</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">374</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">375</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavformat/avformat.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">376</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavcodec/avcodec.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">377</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libswscale/swscale.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">378</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">379</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INBUF_SIZE 4096</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">380</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">381</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WORD uint16_t</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">382</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DWORD uint32_t</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">383</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LONG int32_t</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">384</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">385</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> pack(2)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">386</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tagBITMAPFILEHEADER</span> &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">387</span></pre></td><td class="code"><pre><span class="line">  WORD  bfType;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">388</span></pre></td><td class="code"><pre><span class="line">  DWORD bfSize;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">389</span></pre></td><td class="code"><pre><span class="line">  WORD  bfReserved1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">390</span></pre></td><td class="code"><pre><span class="line">  WORD  bfReserved2;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">391</span></pre></td><td class="code"><pre><span class="line">  DWORD bfOffBits;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">392</span></pre></td><td class="code"><pre><span class="line">&#125; BITMAPFILEHEADER, *PBITMAPFILEHEADER;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">393</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">394</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">395</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tagBITMAPINFOHEADER</span> &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">396</span></pre></td><td class="code"><pre><span class="line">  DWORD biSize;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">397</span></pre></td><td class="code"><pre><span class="line">  LONG  biWidth;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">398</span></pre></td><td class="code"><pre><span class="line">  LONG  biHeight;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">399</span></pre></td><td class="code"><pre><span class="line">  WORD  biPlanes;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">400</span></pre></td><td class="code"><pre><span class="line">  WORD  biBitCount;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">401</span></pre></td><td class="code"><pre><span class="line">  DWORD biCompression;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">402</span></pre></td><td class="code"><pre><span class="line">  DWORD biSizeImage;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">403</span></pre></td><td class="code"><pre><span class="line">  LONG  biXPelsPerMeter;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">404</span></pre></td><td class="code"><pre><span class="line">  LONG  biYPelsPerMeter;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">405</span></pre></td><td class="code"><pre><span class="line">  DWORD biClrUsed;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">406</span></pre></td><td class="code"><pre><span class="line">  DWORD biClrImportant;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">407</span></pre></td><td class="code"><pre><span class="line">&#125; BITMAPINFOHEADER, *PBITMAPINFOHEADER;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">408</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">409</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveBMP</span><span class="params">(struct SwsContext *img_convert_ctx, AVFrame *frame, <span class="keyword">char</span> *filename)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">410</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">411</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//1 先进行转换,  YUV420=&gt;RGB24:</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">412</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> w = frame-&gt;<span class="built_in">width</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">413</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> h = frame-&gt;<span class="built_in">height</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">414</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">415</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">416</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> numBytes=avpicture_get_size(AV_PIX_FMT_BGR24, w, h);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">417</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">uint8_t</span> *<span class="built_in">buffer</span>=(<span class="keyword">uint8_t</span> *)av_malloc(numBytes*<span class="keyword">sizeof</span>(<span class="keyword">uint8_t</span>));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">418</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">419</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">420</span></pre></td><td class="code"><pre><span class="line">    AVFrame *pFrameRGB = av_frame_alloc();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">421</span></pre></td><td class="code"><pre><span class="line">     <span class="comment">/* buffer is going to be written to rawvideo file, no alignment */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">422</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/*</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">423</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    if (av_image_alloc(pFrameRGB-&gt;data, pFrameRGB-&gt;linesize,</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">424</span></pre></td><td class="code"><pre><span class="line"><span class="comment">                              w, h, AV_PIX_FMT_BGR24, pix_fmt, 1) &lt; 0) &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">425</span></pre></td><td class="code"><pre><span class="line"><span class="comment">        fprintf(stderr, "Could not allocate destination image\n");</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">426</span></pre></td><td class="code"><pre><span class="line"><span class="comment">        exit(1);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">427</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    &#125;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">428</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">429</span></pre></td><td class="code"><pre><span class="line">    avpicture_fill((AVPicture *)pFrameRGB, <span class="built_in">buffer</span>, AV_PIX_FMT_BGR24, w, h);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">430</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">431</span></pre></td><td class="code"><pre><span class="line">    sws_scale(img_convert_ctx, frame-&gt;data, frame-&gt;linesize,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">432</span></pre></td><td class="code"><pre><span class="line">              <span class="number">0</span>, h, pFrameRGB-&gt;data, pFrameRGB-&gt;linesize);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">433</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">434</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//2 构造 BITMAPINFOHEADER</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">435</span></pre></td><td class="code"><pre><span class="line">    BITMAPINFOHEADER header;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">436</span></pre></td><td class="code"><pre><span class="line">    header.biSize = <span class="keyword">sizeof</span>(BITMAPINFOHEADER);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">437</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">438</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">439</span></pre></td><td class="code"><pre><span class="line">    header.biWidth = w;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">440</span></pre></td><td class="code"><pre><span class="line">    header.biHeight = h*(<span class="number">-1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">441</span></pre></td><td class="code"><pre><span class="line">    header.biBitCount = <span class="number">24</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">442</span></pre></td><td class="code"><pre><span class="line">    header.biCompression = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">443</span></pre></td><td class="code"><pre><span class="line">    header.biSizeImage = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">444</span></pre></td><td class="code"><pre><span class="line">    header.biClrImportant = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">445</span></pre></td><td class="code"><pre><span class="line">    header.biClrUsed = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">446</span></pre></td><td class="code"><pre><span class="line">    header.biXPelsPerMeter = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">447</span></pre></td><td class="code"><pre><span class="line">    header.biYPelsPerMeter = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">448</span></pre></td><td class="code"><pre><span class="line">    header.biPlanes = <span class="number">1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">449</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">450</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//3 构造文件头</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">451</span></pre></td><td class="code"><pre><span class="line">    BITMAPFILEHEADER bmpFileHeader = &#123;<span class="number">0</span>,&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">452</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//HANDLE hFile = NULL;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">453</span></pre></td><td class="code"><pre><span class="line">    DWORD dwTotalWriten = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">454</span></pre></td><td class="code"><pre><span class="line">    DWORD dwWriten;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">455</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">456</span></pre></td><td class="code"><pre><span class="line">    bmpFileHeader.bfType = <span class="number">0x4d42</span>; <span class="comment">//'BM';</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">457</span></pre></td><td class="code"><pre><span class="line">    bmpFileHeader.bfSize = <span class="keyword">sizeof</span>(BITMAPFILEHEADER) + <span class="keyword">sizeof</span>(BITMAPINFOHEADER)+ numBytes;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">458</span></pre></td><td class="code"><pre><span class="line">    bmpFileHeader.bfOffBits=<span class="keyword">sizeof</span>(BITMAPFILEHEADER)+<span class="keyword">sizeof</span>(BITMAPINFOHEADER);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">459</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">460</span></pre></td><td class="code"><pre><span class="line">    FILE* pf = fopen(filename, <span class="string">"wb"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">461</span></pre></td><td class="code"><pre><span class="line">    fwrite(&amp;bmpFileHeader, <span class="keyword">sizeof</span>(BITMAPFILEHEADER), <span class="number">1</span>, pf);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">462</span></pre></td><td class="code"><pre><span class="line">    fwrite(&amp;header, <span class="keyword">sizeof</span>(BITMAPINFOHEADER), <span class="number">1</span>, pf);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">463</span></pre></td><td class="code"><pre><span class="line">    fwrite(pFrameRGB-&gt;data[<span class="number">0</span>], <span class="number">1</span>, numBytes, pf);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">464</span></pre></td><td class="code"><pre><span class="line">    fclose(pf);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">465</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">466</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">467</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//释放资源</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">468</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//av_free(buffer);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">469</span></pre></td><td class="code"><pre><span class="line">    av_freep(&amp;pFrameRGB[<span class="number">0</span>]);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">470</span></pre></td><td class="code"><pre><span class="line">    av_free(pFrameRGB);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">471</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">472</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">473</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">pgm_save</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">int</span> wrap, <span class="keyword">int</span> xsize, <span class="keyword">int</span> ysize,</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">474</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="params">                     <span class="keyword">char</span> *filename)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">475</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">476</span></pre></td><td class="code"><pre><span class="line">    FILE *f;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">477</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> i;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">478</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">479</span></pre></td><td class="code"><pre><span class="line">    f = fopen(filename,<span class="string">"w"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">480</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">fprintf</span>(f, <span class="string">"P5\n%d %d\n%d\n"</span>, xsize, ysize, <span class="number">255</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">481</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ysize; i++)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">482</span></pre></td><td class="code"><pre><span class="line">        fwrite(buf + i * wrap, <span class="number">1</span>, xsize, f);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">483</span></pre></td><td class="code"><pre><span class="line">    fclose(f);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">484</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">485</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">486</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">decode_write_frame</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *outfilename, AVCodecContext *avctx,</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">487</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="params">                              struct SwsContext *img_convert_ctx, AVFrame *frame, <span class="keyword">int</span> *frame_count, AVPacket *pkt, <span class="keyword">int</span> last)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">488</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">489</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> len, got_frame;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">490</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">491</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">492</span></pre></td><td class="code"><pre><span class="line">    len = avcodec_decode_video2(avctx, frame, &amp;got_frame, pkt);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">493</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">494</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error while decoding frame %d\n"</span>, *frame_count);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">495</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> len;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">496</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">497</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (got_frame) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">498</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">printf</span>(<span class="string">"Saving %sframe %3d\n"</span>, last ? <span class="string">"last "</span> : <span class="string">""</span>, *frame_count);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">499</span></pre></td><td class="code"><pre><span class="line">        fflush(<span class="built_in">stdout</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">500</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">501</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">/* the picture is allocated by the decoder, no need to free it */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">502</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span>(buf), <span class="string">"%s-%d.bmp"</span>, outfilename, *frame_count);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">503</span></pre></td><td class="code"><pre><span class="line">        </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">504</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">/*</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">505</span></pre></td><td class="code"><pre><span class="line"><span class="comment">        pgm_save(frame-&gt;data[0], frame-&gt;linesize[0],</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">506</span></pre></td><td class="code"><pre><span class="line"><span class="comment">                 frame-&gt;width, frame-&gt;height, buf);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">507</span></pre></td><td class="code"><pre><span class="line"><span class="comment">        */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">508</span></pre></td><td class="code"><pre><span class="line">        </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">509</span></pre></td><td class="code"><pre><span class="line">        saveBMP(img_convert_ctx, frame, buf);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">510</span></pre></td><td class="code"><pre><span class="line">        </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">511</span></pre></td><td class="code"><pre><span class="line">        (*frame_count)++;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">512</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">513</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (pkt-&gt;data) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">514</span></pre></td><td class="code"><pre><span class="line">        pkt-&gt;<span class="built_in">size</span> -= len;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">515</span></pre></td><td class="code"><pre><span class="line">        pkt-&gt;data += len;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">516</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">517</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">518</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">519</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">520</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">521</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">522</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> ret;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">523</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">524</span></pre></td><td class="code"><pre><span class="line">    FILE *f;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">525</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">526</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *filename, *outfilename;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">527</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">528</span></pre></td><td class="code"><pre><span class="line">    AVFormatContext *fmt_ctx = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">529</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">530</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">const</span> AVCodec *codec;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">531</span></pre></td><td class="code"><pre><span class="line">    AVCodecContext *c= <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">532</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">533</span></pre></td><td class="code"><pre><span class="line">    AVStream *st = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">534</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> stream_index;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">535</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">536</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> frame_count;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">537</span></pre></td><td class="code"><pre><span class="line">    AVFrame *frame;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">538</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">539</span></pre></td><td class="code"><pre><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">SwsContext</span> *<span class="title">img_convert_ctx</span>;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">540</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">541</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//uint8_t inbuf[INBUF_SIZE + AV_INPUT_BUFFER_PADDING_SIZE];</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">542</span></pre></td><td class="code"><pre><span class="line">    AVPacket avpkt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">543</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">544</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (argc &lt;= <span class="number">2</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">545</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Usage: %s &lt;input file&gt; &lt;output file&gt;\n"</span>, argv[<span class="number">0</span>]);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">546</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">547</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">548</span></pre></td><td class="code"><pre><span class="line">    filename    = argv[<span class="number">1</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">549</span></pre></td><td class="code"><pre><span class="line">    outfilename = argv[<span class="number">2</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">550</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">551</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* register all formats and codecs */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">552</span></pre></td><td class="code"><pre><span class="line">    av_register_all();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">553</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">554</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* open input file, and allocate format context */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">555</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (avformat_open_input(&amp;fmt_ctx, filename, <span class="literal">NULL</span>, <span class="literal">NULL</span>) &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">556</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Could not open source file %s\n"</span>, filename);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">557</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">558</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">559</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">560</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* retrieve stream information */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">561</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (avformat_find_stream_info(fmt_ctx, <span class="literal">NULL</span>) &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">562</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Could not find stream information\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">563</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">564</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">565</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">566</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* dump input information to stderr */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">567</span></pre></td><td class="code"><pre><span class="line">    av_dump_format(fmt_ctx, <span class="number">0</span>, filename, <span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">568</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">569</span></pre></td><td class="code"><pre><span class="line">    av_init_packet(&amp;avpkt);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">570</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">571</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* set end of buffer to 0 (this ensures that no overreading happens for damaged MPEG streams) */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">572</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//memset(inbuf + INBUF_SIZE, 0, AV_INPUT_BUFFER_PADDING_SIZE);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">573</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">574</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">575</span></pre></td><td class="code"><pre><span class="line">    ret = av_find_best_stream(fmt_ctx, AVMEDIA_TYPE_VIDEO, <span class="number">-1</span>, <span class="number">-1</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">576</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">577</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Could not find %s stream in input file '%s'\n"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">578</span></pre></td><td class="code"><pre><span class="line">                av_get_media_type_string(AVMEDIA_TYPE_VIDEO), filename);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">579</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> ret;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">580</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">581</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">582</span></pre></td><td class="code"><pre><span class="line">    stream_index = ret;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">583</span></pre></td><td class="code"><pre><span class="line">    st = fmt_ctx-&gt;streams[stream_index];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">584</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">585</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* find decoder for the stream */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">586</span></pre></td><td class="code"><pre><span class="line">    codec = avcodec_find_decoder(st-&gt;codecpar-&gt;codec_id);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">587</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!codec) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">588</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Failed to find %s codec\n"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">589</span></pre></td><td class="code"><pre><span class="line">                av_get_media_type_string(AVMEDIA_TYPE_VIDEO));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">590</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> AVERROR(EINVAL);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">591</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">592</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">593</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">594</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* find the MPEG-1 video decoder */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">595</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/*</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">596</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    codec = avcodec_find_decoder(AV_CODEC_ID_MPEG1VIDEO);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">597</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    if (!codec) &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">598</span></pre></td><td class="code"><pre><span class="line"><span class="comment">        fprintf(stderr, "Codec not found\n");</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">599</span></pre></td><td class="code"><pre><span class="line"><span class="comment">        exit(1);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">600</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    &#125;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">601</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">602</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">603</span></pre></td><td class="code"><pre><span class="line">    c = avcodec_alloc_context3(<span class="literal">NULL</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">604</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!c) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">605</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Could not allocate video codec context\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">606</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">607</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">608</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">609</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* Copy codec parameters from input stream to output codec context */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">610</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> ((ret = avcodec_parameters_to_context(c, st-&gt;codecpar)) &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">611</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Failed to copy %s codec parameters to decoder context\n"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">612</span></pre></td><td class="code"><pre><span class="line">                av_get_media_type_string(AVMEDIA_TYPE_VIDEO));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">613</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> ret;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">614</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">615</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">616</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">617</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/*</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">618</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    if (codec-&gt;capabilities &amp; AV_CODEC_CAP_TRUNCATED)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">619</span></pre></td><td class="code"><pre><span class="line"><span class="comment">        c-&gt;flags |= AV_CODEC_FLAG_TRUNCATED; // we do not send complete frames</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">620</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">621</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">622</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* For some codecs, such as msmpeg4 and mpeg4, width and height</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">623</span></pre></td><td class="code"><pre><span class="line"><span class="comment">       MUST be initialized there because this information is not</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">624</span></pre></td><td class="code"><pre><span class="line"><span class="comment">       available in the bitstream. */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">625</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">626</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* open it */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">627</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (avcodec_open2(c, codec, <span class="literal">NULL</span>) &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">628</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Could not open codec\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">629</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">630</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">631</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">632</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/*</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">633</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    f = fopen(filename, "rb");</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">634</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    if (!f) &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">635</span></pre></td><td class="code"><pre><span class="line"><span class="comment">        fprintf(stderr, "Could not open %s\n", filename);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">636</span></pre></td><td class="code"><pre><span class="line"><span class="comment">        exit(1);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">637</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    &#125;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">638</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">639</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">640</span></pre></td><td class="code"><pre><span class="line">    img_convert_ctx = sws_getContext(c-&gt;<span class="built_in">width</span>, c-&gt;<span class="built_in">height</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">641</span></pre></td><td class="code"><pre><span class="line">                                     c-&gt;pix_fmt,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">642</span></pre></td><td class="code"><pre><span class="line">                                     c-&gt;<span class="built_in">width</span>, c-&gt;<span class="built_in">height</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">643</span></pre></td><td class="code"><pre><span class="line">                                     AV_PIX_FMT_RGB24,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">644</span></pre></td><td class="code"><pre><span class="line">                                     SWS_BICUBIC, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">645</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">646</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (img_convert_ctx == <span class="literal">NULL</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">647</span></pre></td><td class="code"><pre><span class="line">    &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">648</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Cannot initialize the conversion context\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">649</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">650</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">651</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">652</span></pre></td><td class="code"><pre><span class="line">    frame = av_frame_alloc();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">653</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!frame) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">654</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Could not allocate video frame\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">655</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">656</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">657</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">658</span></pre></td><td class="code"><pre><span class="line">    frame_count = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">659</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">while</span> (av_read_frame(fmt_ctx, &amp;avpkt) &gt;= <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">660</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">/*</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">661</span></pre></td><td class="code"><pre><span class="line"><span class="comment">        avpkt.size = fread(inbuf, 1, INBUF_SIZE, f);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">662</span></pre></td><td class="code"><pre><span class="line"><span class="comment">        if (avpkt.size == 0)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">663</span></pre></td><td class="code"><pre><span class="line"><span class="comment">            break;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">664</span></pre></td><td class="code"><pre><span class="line"><span class="comment">        */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">665</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">666</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">/* NOTE1: some codecs are stream based (mpegvideo, mpegaudio)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">667</span></pre></td><td class="code"><pre><span class="line"><span class="comment">           and this is the only method to use them because you cannot</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">668</span></pre></td><td class="code"><pre><span class="line"><span class="comment">           know the compressed data size before analysing it.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">669</span></pre></td><td class="code"><pre><span class="line"><span class="comment"></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">670</span></pre></td><td class="code"><pre><span class="line"><span class="comment">           BUT some other codecs (msmpeg4, mpeg4) are inherently frame</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">671</span></pre></td><td class="code"><pre><span class="line"><span class="comment">           based, so you must call them with all the data for one</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">672</span></pre></td><td class="code"><pre><span class="line"><span class="comment">           frame exactly. You must also initialize 'width' and</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">673</span></pre></td><td class="code"><pre><span class="line"><span class="comment">           'height' before initializing them. */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">674</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">675</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">/* NOTE2: some codecs allow the raw parameters (frame size,</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">676</span></pre></td><td class="code"><pre><span class="line"><span class="comment">           sample rate) to be changed at any frame. We handle this, so</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">677</span></pre></td><td class="code"><pre><span class="line"><span class="comment">           you should also take care of it */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">678</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">679</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">/* here, we use a stream based decoder (mpeg1video), so we</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">680</span></pre></td><td class="code"><pre><span class="line"><span class="comment">           feed decoder and see if it could decode a frame */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">681</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">//avpkt.data = inbuf;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">682</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">//while (avpkt.size &gt; 0)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">683</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span>(avpkt.stream_index == stream_index)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">684</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">if</span> (decode_write_frame(outfilename, c, img_convert_ctx, frame, &amp;frame_count, &amp;avpkt, <span class="number">0</span>) &lt; <span class="number">0</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">685</span></pre></td><td class="code"><pre><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">686</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">687</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">688</span></pre></td><td class="code"><pre><span class="line">        av_packet_unref(&amp;avpkt);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">689</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">690</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">691</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* Some codecs, such as MPEG, transmit the I- and P-frame with a</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">692</span></pre></td><td class="code"><pre><span class="line"><span class="comment">       latency of one frame. You must do the following to have a</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">693</span></pre></td><td class="code"><pre><span class="line"><span class="comment">       chance to get the last frame of the video. */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">694</span></pre></td><td class="code"><pre><span class="line">    avpkt.data = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">695</span></pre></td><td class="code"><pre><span class="line">    avpkt.<span class="built_in">size</span> = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">696</span></pre></td><td class="code"><pre><span class="line">    decode_write_frame(outfilename, c, img_convert_ctx, frame, &amp;frame_count, &amp;avpkt, <span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">697</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">698</span></pre></td><td class="code"><pre><span class="line">    fclose(f);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">699</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">700</span></pre></td><td class="code"><pre><span class="line">    avformat_close_input(&amp;fmt_ctx);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">701</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">702</span></pre></td><td class="code"><pre><span class="line">    sws_freeContext(img_convert_ctx);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">703</span></pre></td><td class="code"><pre><span class="line">    avcodec_free_context(&amp;c);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">704</span></pre></td><td class="code"><pre><span class="line">    av_frame_free(&amp;frame);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">705</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">706</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">707</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">708</span></pre></td><td class="code"><pre><span class="line">```  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">709</span></pre></td><td class="code"><pre><span class="line">- 执行程序：clang -g -o encode_video encode_video.c `pkg-<span class="built_in">config</span> --libs libavcodec`</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">710</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">711</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">712</span></pre></td><td class="code"><pre><span class="line">#### <span class="number">38.</span>视频转图片</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">713</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">714</span></pre></td><td class="code"><pre><span class="line">```c</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">715</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">716</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">717</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">718</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">719</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavformat/avformat.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">720</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavcodec/avcodec.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">721</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libswscale/swscale.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">722</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">723</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INBUF_SIZE 4096</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">724</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">725</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WORD uint16_t</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">726</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DWORD uint32_t</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">727</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LONG int32_t</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">728</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">729</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> pack(2)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">730</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tagBITMAPFILEHEADER</span> &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">731</span></pre></td><td class="code"><pre><span class="line">  WORD  bfType;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">732</span></pre></td><td class="code"><pre><span class="line">  DWORD bfSize;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">733</span></pre></td><td class="code"><pre><span class="line">  WORD  bfReserved1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">734</span></pre></td><td class="code"><pre><span class="line">  WORD  bfReserved2;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">735</span></pre></td><td class="code"><pre><span class="line">  DWORD bfOffBits;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">736</span></pre></td><td class="code"><pre><span class="line">&#125; BITMAPFILEHEADER, *PBITMAPFILEHEADER;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">737</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">738</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">739</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tagBITMAPINFOHEADER</span> &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">740</span></pre></td><td class="code"><pre><span class="line">  DWORD biSize;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">741</span></pre></td><td class="code"><pre><span class="line">  LONG  biWidth;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">742</span></pre></td><td class="code"><pre><span class="line">  LONG  biHeight;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">743</span></pre></td><td class="code"><pre><span class="line">  WORD  biPlanes;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">744</span></pre></td><td class="code"><pre><span class="line">  WORD  biBitCount;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">745</span></pre></td><td class="code"><pre><span class="line">  DWORD biCompression;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">746</span></pre></td><td class="code"><pre><span class="line">  DWORD biSizeImage;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">747</span></pre></td><td class="code"><pre><span class="line">  LONG  biXPelsPerMeter;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">748</span></pre></td><td class="code"><pre><span class="line">  LONG  biYPelsPerMeter;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">749</span></pre></td><td class="code"><pre><span class="line">  DWORD biClrUsed;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">750</span></pre></td><td class="code"><pre><span class="line">  DWORD biClrImportant;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">751</span></pre></td><td class="code"><pre><span class="line">&#125; BITMAPINFOHEADER, *PBITMAPINFOHEADER;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">752</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">753</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveBMP</span><span class="params">(struct SwsContext *img_convert_ctx, AVFrame *frame, <span class="keyword">char</span> *filename)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">754</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">755</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//1 先进行转换,  YUV420=&gt;RGB24:</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">756</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> w = frame-&gt;<span class="built_in">width</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">757</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> h = frame-&gt;<span class="built_in">height</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">758</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">759</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">760</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> numBytes=avpicture_get_size(AV_PIX_FMT_BGR24, w, h);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">761</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">uint8_t</span> *<span class="built_in">buffer</span>=(<span class="keyword">uint8_t</span> *)av_malloc(numBytes*<span class="keyword">sizeof</span>(<span class="keyword">uint8_t</span>));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">762</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">763</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">764</span></pre></td><td class="code"><pre><span class="line">    AVFrame *pFrameRGB = av_frame_alloc();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">765</span></pre></td><td class="code"><pre><span class="line">     <span class="comment">/* buffer is going to be written to rawvideo file, no alignment */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">766</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/*</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">767</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    if (av_image_alloc(pFrameRGB-&gt;data, pFrameRGB-&gt;linesize,</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">768</span></pre></td><td class="code"><pre><span class="line"><span class="comment">                              w, h, AV_PIX_FMT_BGR24, pix_fmt, 1) &lt; 0) &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">769</span></pre></td><td class="code"><pre><span class="line"><span class="comment">        fprintf(stderr, "Could not allocate destination image\n");</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">770</span></pre></td><td class="code"><pre><span class="line"><span class="comment">        exit(1);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">771</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    &#125;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">772</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">773</span></pre></td><td class="code"><pre><span class="line">    avpicture_fill((AVPicture *)pFrameRGB, <span class="built_in">buffer</span>, AV_PIX_FMT_BGR24, w, h);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">774</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">775</span></pre></td><td class="code"><pre><span class="line">    sws_scale(img_convert_ctx, frame-&gt;data, frame-&gt;linesize,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">776</span></pre></td><td class="code"><pre><span class="line">              <span class="number">0</span>, h, pFrameRGB-&gt;data, pFrameRGB-&gt;linesize);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">777</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">778</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//2 构造 BITMAPINFOHEADER</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">779</span></pre></td><td class="code"><pre><span class="line">    BITMAPINFOHEADER header;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">780</span></pre></td><td class="code"><pre><span class="line">    header.biSize = <span class="keyword">sizeof</span>(BITMAPINFOHEADER);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">781</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">782</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">783</span></pre></td><td class="code"><pre><span class="line">    header.biWidth = w;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">784</span></pre></td><td class="code"><pre><span class="line">    header.biHeight = h*(<span class="number">-1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">785</span></pre></td><td class="code"><pre><span class="line">    header.biBitCount = <span class="number">24</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">786</span></pre></td><td class="code"><pre><span class="line">    header.biCompression = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">787</span></pre></td><td class="code"><pre><span class="line">    header.biSizeImage = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">788</span></pre></td><td class="code"><pre><span class="line">    header.biClrImportant = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">789</span></pre></td><td class="code"><pre><span class="line">    header.biClrUsed = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">790</span></pre></td><td class="code"><pre><span class="line">    header.biXPelsPerMeter = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">791</span></pre></td><td class="code"><pre><span class="line">    header.biYPelsPerMeter = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">792</span></pre></td><td class="code"><pre><span class="line">    header.biPlanes = <span class="number">1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">793</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">794</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//3 构造文件头</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">795</span></pre></td><td class="code"><pre><span class="line">    BITMAPFILEHEADER bmpFileHeader = &#123;<span class="number">0</span>,&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">796</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//HANDLE hFile = NULL;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">797</span></pre></td><td class="code"><pre><span class="line">    DWORD dwTotalWriten = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">798</span></pre></td><td class="code"><pre><span class="line">    DWORD dwWriten;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">799</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">800</span></pre></td><td class="code"><pre><span class="line">    bmpFileHeader.bfType = <span class="number">0x4d42</span>; <span class="comment">//'BM';</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">801</span></pre></td><td class="code"><pre><span class="line">    bmpFileHeader.bfSize = <span class="keyword">sizeof</span>(BITMAPFILEHEADER) + <span class="keyword">sizeof</span>(BITMAPINFOHEADER)+ numBytes;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">802</span></pre></td><td class="code"><pre><span class="line">    bmpFileHeader.bfOffBits=<span class="keyword">sizeof</span>(BITMAPFILEHEADER)+<span class="keyword">sizeof</span>(BITMAPINFOHEADER);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">803</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">804</span></pre></td><td class="code"><pre><span class="line">    FILE* pf = fopen(filename, <span class="string">"wb"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">805</span></pre></td><td class="code"><pre><span class="line">    fwrite(&amp;bmpFileHeader, <span class="keyword">sizeof</span>(BITMAPFILEHEADER), <span class="number">1</span>, pf);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">806</span></pre></td><td class="code"><pre><span class="line">    fwrite(&amp;header, <span class="keyword">sizeof</span>(BITMAPINFOHEADER), <span class="number">1</span>, pf);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">807</span></pre></td><td class="code"><pre><span class="line">    fwrite(pFrameRGB-&gt;data[<span class="number">0</span>], <span class="number">1</span>, numBytes, pf);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">808</span></pre></td><td class="code"><pre><span class="line">    fclose(pf);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">809</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">810</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">811</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//释放资源</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">812</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//av_free(buffer);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">813</span></pre></td><td class="code"><pre><span class="line">    av_freep(&amp;pFrameRGB[<span class="number">0</span>]);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">814</span></pre></td><td class="code"><pre><span class="line">    av_free(pFrameRGB);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">815</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">816</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">817</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">pgm_save</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">int</span> wrap, <span class="keyword">int</span> xsize, <span class="keyword">int</span> ysize,</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">818</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="params">                     <span class="keyword">char</span> *filename)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">819</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">820</span></pre></td><td class="code"><pre><span class="line">    FILE *f;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">821</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> i;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">822</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">823</span></pre></td><td class="code"><pre><span class="line">    f = fopen(filename,<span class="string">"w"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">824</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">fprintf</span>(f, <span class="string">"P5\n%d %d\n%d\n"</span>, xsize, ysize, <span class="number">255</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">825</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; ysize; i++)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">826</span></pre></td><td class="code"><pre><span class="line">        fwrite(buf + i * wrap, <span class="number">1</span>, xsize, f);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">827</span></pre></td><td class="code"><pre><span class="line">    fclose(f);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">828</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">829</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">830</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">decode_write_frame</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *outfilename, AVCodecContext *avctx,</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">831</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="params">                              struct SwsContext *img_convert_ctx, AVFrame *frame, <span class="keyword">int</span> *frame_count, AVPacket *pkt, <span class="keyword">int</span> last)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">832</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">833</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> len, got_frame;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">834</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">char</span> buf[<span class="number">1024</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">835</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">836</span></pre></td><td class="code"><pre><span class="line">    len = avcodec_decode_video2(avctx, frame, &amp;got_frame, pkt);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">837</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">838</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error while decoding frame %d\n"</span>, *frame_count);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">839</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> len;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">840</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">841</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (got_frame) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">842</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">printf</span>(<span class="string">"Saving %sframe %3d\n"</span>, last ? <span class="string">"last "</span> : <span class="string">""</span>, *frame_count);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">843</span></pre></td><td class="code"><pre><span class="line">        fflush(<span class="built_in">stdout</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">844</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">845</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">/* the picture is allocated by the decoder, no need to free it */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">846</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span>(buf), <span class="string">"%s-%d.bmp"</span>, outfilename, *frame_count);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">847</span></pre></td><td class="code"><pre><span class="line">        </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">848</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">/*</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">849</span></pre></td><td class="code"><pre><span class="line"><span class="comment">        pgm_save(frame-&gt;data[0], frame-&gt;linesize[0],</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">850</span></pre></td><td class="code"><pre><span class="line"><span class="comment">                 frame-&gt;width, frame-&gt;height, buf);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">851</span></pre></td><td class="code"><pre><span class="line"><span class="comment">        */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">852</span></pre></td><td class="code"><pre><span class="line">        </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">853</span></pre></td><td class="code"><pre><span class="line">        saveBMP(img_convert_ctx, frame, buf);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">854</span></pre></td><td class="code"><pre><span class="line">        </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">855</span></pre></td><td class="code"><pre><span class="line">        (*frame_count)++;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">856</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">857</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (pkt-&gt;data) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">858</span></pre></td><td class="code"><pre><span class="line">        pkt-&gt;<span class="built_in">size</span> -= len;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">859</span></pre></td><td class="code"><pre><span class="line">        pkt-&gt;data += len;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">860</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">861</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">862</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">863</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">864</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">865</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">866</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> ret;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">867</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">868</span></pre></td><td class="code"><pre><span class="line">    FILE *f;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">869</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">870</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *filename, *outfilename;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">871</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">872</span></pre></td><td class="code"><pre><span class="line">    AVFormatContext *fmt_ctx = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">873</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">874</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">const</span> AVCodec *codec;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">875</span></pre></td><td class="code"><pre><span class="line">    AVCodecContext *c= <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">876</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">877</span></pre></td><td class="code"><pre><span class="line">    AVStream *st = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">878</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> stream_index;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">879</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">880</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> frame_count;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">881</span></pre></td><td class="code"><pre><span class="line">    AVFrame *frame;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">882</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">883</span></pre></td><td class="code"><pre><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">SwsContext</span> *<span class="title">img_convert_ctx</span>;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">884</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">885</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//uint8_t inbuf[INBUF_SIZE + AV_INPUT_BUFFER_PADDING_SIZE];</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">886</span></pre></td><td class="code"><pre><span class="line">    AVPacket avpkt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">887</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">888</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (argc &lt;= <span class="number">2</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">889</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Usage: %s &lt;input file&gt; &lt;output file&gt;\n"</span>, argv[<span class="number">0</span>]);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">890</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">891</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">892</span></pre></td><td class="code"><pre><span class="line">    filename    = argv[<span class="number">1</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">893</span></pre></td><td class="code"><pre><span class="line">    outfilename = argv[<span class="number">2</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">894</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">895</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* register all formats and codecs */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">896</span></pre></td><td class="code"><pre><span class="line">    av_register_all();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">897</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">898</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* open input file, and allocate format context */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">899</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (avformat_open_input(&amp;fmt_ctx, filename, <span class="literal">NULL</span>, <span class="literal">NULL</span>) &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">900</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Could not open source file %s\n"</span>, filename);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">901</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">902</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">903</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">904</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* retrieve stream information */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">905</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (avformat_find_stream_info(fmt_ctx, <span class="literal">NULL</span>) &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">906</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Could not find stream information\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">907</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">908</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">909</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">910</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* dump input information to stderr */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">911</span></pre></td><td class="code"><pre><span class="line">    av_dump_format(fmt_ctx, <span class="number">0</span>, filename, <span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">912</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">913</span></pre></td><td class="code"><pre><span class="line">    av_init_packet(&amp;avpkt);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">914</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">915</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* set end of buffer to 0 (this ensures that no overreading happens for damaged MPEG streams) */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">916</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//memset(inbuf + INBUF_SIZE, 0, AV_INPUT_BUFFER_PADDING_SIZE);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">917</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">918</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">919</span></pre></td><td class="code"><pre><span class="line">    ret = av_find_best_stream(fmt_ctx, AVMEDIA_TYPE_VIDEO, <span class="number">-1</span>, <span class="number">-1</span>, <span class="literal">NULL</span>, <span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">920</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">921</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Could not find %s stream in input file '%s'\n"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">922</span></pre></td><td class="code"><pre><span class="line">                av_get_media_type_string(AVMEDIA_TYPE_VIDEO), filename);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">923</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> ret;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">924</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">925</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">926</span></pre></td><td class="code"><pre><span class="line">    stream_index = ret;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">927</span></pre></td><td class="code"><pre><span class="line">    st = fmt_ctx-&gt;streams[stream_index];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">928</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">929</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* find decoder for the stream */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">930</span></pre></td><td class="code"><pre><span class="line">    codec = avcodec_find_decoder(st-&gt;codecpar-&gt;codec_id);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">931</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!codec) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">932</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Failed to find %s codec\n"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">933</span></pre></td><td class="code"><pre><span class="line">                av_get_media_type_string(AVMEDIA_TYPE_VIDEO));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">934</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> AVERROR(EINVAL);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">935</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">936</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">937</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">938</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* find the MPEG-1 video decoder */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">939</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/*</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">940</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    codec = avcodec_find_decoder(AV_CODEC_ID_MPEG1VIDEO);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">941</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    if (!codec) &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">942</span></pre></td><td class="code"><pre><span class="line"><span class="comment">        fprintf(stderr, "Codec not found\n");</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">943</span></pre></td><td class="code"><pre><span class="line"><span class="comment">        exit(1);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">944</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    &#125;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">945</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">946</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">947</span></pre></td><td class="code"><pre><span class="line">    c = avcodec_alloc_context3(<span class="literal">NULL</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">948</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!c) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">949</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Could not allocate video codec context\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">950</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">951</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">952</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">953</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* Copy codec parameters from input stream to output codec context */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">954</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> ((ret = avcodec_parameters_to_context(c, st-&gt;codecpar)) &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">955</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Failed to copy %s codec parameters to decoder context\n"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">956</span></pre></td><td class="code"><pre><span class="line">                av_get_media_type_string(AVMEDIA_TYPE_VIDEO));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">957</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> ret;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">958</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">959</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">960</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">961</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/*</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">962</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    if (codec-&gt;capabilities &amp; AV_CODEC_CAP_TRUNCATED)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">963</span></pre></td><td class="code"><pre><span class="line"><span class="comment">        c-&gt;flags |= AV_CODEC_FLAG_TRUNCATED; // we do not send complete frames</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">964</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">965</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">966</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* For some codecs, such as msmpeg4 and mpeg4, width and height</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">967</span></pre></td><td class="code"><pre><span class="line"><span class="comment">       MUST be initialized there because this information is not</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">968</span></pre></td><td class="code"><pre><span class="line"><span class="comment">       available in the bitstream. */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">969</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">970</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* open it */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">971</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (avcodec_open2(c, codec, <span class="literal">NULL</span>) &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">972</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Could not open codec\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">973</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">974</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">975</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">976</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/*</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">977</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    f = fopen(filename, "rb");</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">978</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    if (!f) &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">979</span></pre></td><td class="code"><pre><span class="line"><span class="comment">        fprintf(stderr, "Could not open %s\n", filename);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">980</span></pre></td><td class="code"><pre><span class="line"><span class="comment">        exit(1);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">981</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    &#125;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">982</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">983</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">984</span></pre></td><td class="code"><pre><span class="line">    img_convert_ctx = sws_getContext(c-&gt;<span class="built_in">width</span>, c-&gt;<span class="built_in">height</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">985</span></pre></td><td class="code"><pre><span class="line">                                     c-&gt;pix_fmt,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">986</span></pre></td><td class="code"><pre><span class="line">                                     c-&gt;<span class="built_in">width</span>, c-&gt;<span class="built_in">height</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">987</span></pre></td><td class="code"><pre><span class="line">                                     AV_PIX_FMT_RGB24,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">988</span></pre></td><td class="code"><pre><span class="line">                                     SWS_BICUBIC, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">989</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">990</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (img_convert_ctx == <span class="literal">NULL</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">991</span></pre></td><td class="code"><pre><span class="line">    &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">992</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Cannot initialize the conversion context\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">993</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">994</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">995</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">996</span></pre></td><td class="code"><pre><span class="line">    frame = av_frame_alloc();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">997</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!frame) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">998</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Could not allocate video frame\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">999</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1000</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1001</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1002</span></pre></td><td class="code"><pre><span class="line">    frame_count = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1003</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">while</span> (av_read_frame(fmt_ctx, &amp;avpkt) &gt;= <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1004</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">/*</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1005</span></pre></td><td class="code"><pre><span class="line"><span class="comment">        avpkt.size = fread(inbuf, 1, INBUF_SIZE, f);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1006</span></pre></td><td class="code"><pre><span class="line"><span class="comment">        if (avpkt.size == 0)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1007</span></pre></td><td class="code"><pre><span class="line"><span class="comment">            break;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1008</span></pre></td><td class="code"><pre><span class="line"><span class="comment">        */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1009</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1010</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">/* NOTE1: some codecs are stream based (mpegvideo, mpegaudio)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1011</span></pre></td><td class="code"><pre><span class="line"><span class="comment">           and this is the only method to use them because you cannot</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1012</span></pre></td><td class="code"><pre><span class="line"><span class="comment">           know the compressed data size before analysing it.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1013</span></pre></td><td class="code"><pre><span class="line"><span class="comment"></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1014</span></pre></td><td class="code"><pre><span class="line"><span class="comment">           BUT some other codecs (msmpeg4, mpeg4) are inherently frame</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1015</span></pre></td><td class="code"><pre><span class="line"><span class="comment">           based, so you must call them with all the data for one</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1016</span></pre></td><td class="code"><pre><span class="line"><span class="comment">           frame exactly. You must also initialize 'width' and</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1017</span></pre></td><td class="code"><pre><span class="line"><span class="comment">           'height' before initializing them. */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1018</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1019</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">/* NOTE2: some codecs allow the raw parameters (frame size,</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1020</span></pre></td><td class="code"><pre><span class="line"><span class="comment">           sample rate) to be changed at any frame. We handle this, so</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1021</span></pre></td><td class="code"><pre><span class="line"><span class="comment">           you should also take care of it */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1022</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1023</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">/* here, we use a stream based decoder (mpeg1video), so we</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1024</span></pre></td><td class="code"><pre><span class="line"><span class="comment">           feed decoder and see if it could decode a frame */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1025</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">//avpkt.data = inbuf;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1026</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">//while (avpkt.size &gt; 0)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1027</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span>(avpkt.stream_index == stream_index)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1028</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">if</span> (decode_write_frame(outfilename, c, img_convert_ctx, frame, &amp;frame_count, &amp;avpkt, <span class="number">0</span>) &lt; <span class="number">0</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1029</span></pre></td><td class="code"><pre><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1030</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1031</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1032</span></pre></td><td class="code"><pre><span class="line">        av_packet_unref(&amp;avpkt);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1033</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1034</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1035</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* Some codecs, such as MPEG, transmit the I- and P-frame with a</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1036</span></pre></td><td class="code"><pre><span class="line"><span class="comment">       latency of one frame. You must do the following to have a</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1037</span></pre></td><td class="code"><pre><span class="line"><span class="comment">       chance to get the last frame of the video. */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1038</span></pre></td><td class="code"><pre><span class="line">    avpkt.data = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1039</span></pre></td><td class="code"><pre><span class="line">    avpkt.<span class="built_in">size</span> = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1040</span></pre></td><td class="code"><pre><span class="line">    decode_write_frame(outfilename, c, img_convert_ctx, frame, &amp;frame_count, &amp;avpkt, <span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1041</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1042</span></pre></td><td class="code"><pre><span class="line">    fclose(f);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1043</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1044</span></pre></td><td class="code"><pre><span class="line">    avformat_close_input(&amp;fmt_ctx);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1045</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1046</span></pre></td><td class="code"><pre><span class="line">    sws_freeContext(img_convert_ctx);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1047</span></pre></td><td class="code"><pre><span class="line">    avcodec_free_context(&amp;c);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1048</span></pre></td><td class="code"><pre><span class="line">    av_frame_free(&amp;frame);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1049</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1050</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1051</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1052</span></pre></td><td class="code"><pre><span class="line">``` </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1053</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1054</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1055</span></pre></td><td class="code"><pre><span class="line">#### <span class="number">39.</span>AAC编码</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1056</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1057</span></pre></td><td class="code"><pre><span class="line">- 编码流程与视频相同</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1058</span></pre></td><td class="code"><pre><span class="line">- 编码函数 avcodec_encodec_audio2</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1059</span></pre></td><td class="code"><pre><span class="line">    - <span class="number">1.</span> 添加头文件</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1060</span></pre></td><td class="code"><pre><span class="line">    - <span class="number">2.</span> 注册编解码器</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1061</span></pre></td><td class="code"><pre><span class="line">    - <span class="number">3.</span> 通过名字去找到编码器</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1062</span></pre></td><td class="code"><pre><span class="line">    - <span class="number">4.</span> 设置参数，打开编码器</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1063</span></pre></td><td class="code"><pre><span class="line">    - <span class="number">5.</span> 获取数据包，进行编码</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1064</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1065</span></pre></td><td class="code"><pre><span class="line">```c</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1066</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1067</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1068</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1069</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1070</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavcodec/avcodec.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1071</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1072</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavutil/channel_layout.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1073</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavutil/common.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1074</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavutil/frame.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1075</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavutil/samplefmt.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1076</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1077</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/* check that a given sample format is supported by the encoder */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1078</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">check_sample_fmt</span><span class="params">(<span class="keyword">const</span> AVCodec *codec, <span class="keyword">enum</span> AVSampleFormat sample_fmt)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1079</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1080</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">const</span> <span class="keyword">enum</span> AVSampleFormat *p = codec-&gt;sample_fmts;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1081</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1082</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">while</span> (*p != AV_SAMPLE_FMT_NONE) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1083</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (*p == sample_fmt)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1084</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1085</span></pre></td><td class="code"><pre><span class="line">        p++;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1086</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1087</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1088</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1089</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1090</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/* just pick the highest supported samplerate */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1091</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">select_sample_rate</span><span class="params">(<span class="keyword">const</span> AVCodec *codec)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1092</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1093</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> *p;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1094</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> best_samplerate = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1095</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1096</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!codec-&gt;supported_samplerates)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1097</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="number">44100</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1098</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1099</span></pre></td><td class="code"><pre><span class="line">    p = codec-&gt;supported_samplerates;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1100</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">while</span> (*p) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1101</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (!best_samplerate || <span class="built_in">abs</span>(<span class="number">44100</span> - *p) &lt; <span class="built_in">abs</span>(<span class="number">44100</span> - best_samplerate))</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1102</span></pre></td><td class="code"><pre><span class="line">            best_samplerate = *p;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1103</span></pre></td><td class="code"><pre><span class="line">        p++;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1104</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1105</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> best_samplerate;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1106</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1107</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1108</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/* select layout with the highest channel count */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1109</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">select_channel_layout</span><span class="params">(<span class="keyword">const</span> AVCodec *codec)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1110</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1111</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">const</span> <span class="keyword">uint64_t</span> *p;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1112</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">uint64_t</span> best_ch_layout = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1113</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> best_nb_channels   = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1114</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1115</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!codec-&gt;channel_layouts)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1116</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> AV_CH_LAYOUT_STEREO;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1117</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1118</span></pre></td><td class="code"><pre><span class="line">    p = codec-&gt;channel_layouts;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1119</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">while</span> (*p) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1120</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">int</span> nb_channels = av_get_channel_layout_nb_channels(*p);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1121</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1122</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (nb_channels &gt; best_nb_channels) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1123</span></pre></td><td class="code"><pre><span class="line">            best_ch_layout    = *p;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1124</span></pre></td><td class="code"><pre><span class="line">            best_nb_channels = nb_channels;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1125</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1126</span></pre></td><td class="code"><pre><span class="line">        p++;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1127</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1128</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> best_ch_layout;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1129</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1130</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1131</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1132</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1133</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *filename;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1134</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">const</span> AVCodec *codec;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1135</span></pre></td><td class="code"><pre><span class="line">    AVCodecContext *c= <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1136</span></pre></td><td class="code"><pre><span class="line">    AVFrame *frame;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1137</span></pre></td><td class="code"><pre><span class="line">    AVPacket pkt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1138</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> i, j, k, ret, got_output;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1139</span></pre></td><td class="code"><pre><span class="line">    FILE *f;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1140</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">uint16_t</span> *samples;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1141</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">float</span> t, tincr;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1142</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1143</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (argc &lt;= <span class="number">1</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1144</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Usage: %s &lt;output file&gt;\n"</span>, argv[<span class="number">0</span>]);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1145</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1146</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1147</span></pre></td><td class="code"><pre><span class="line">    filename = argv[<span class="number">1</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1148</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1149</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* register all the codecs */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1150</span></pre></td><td class="code"><pre><span class="line">    avcodec_register_all();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1151</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1152</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* find the MP2 encoder */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1153</span></pre></td><td class="code"><pre><span class="line">    codec = avcodec_find_encoder(AV_CODEC_ID_MP2);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1154</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!codec) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1155</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Codec not found\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1156</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1157</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1158</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1159</span></pre></td><td class="code"><pre><span class="line">    c = avcodec_alloc_context3(codec);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1160</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!c) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1161</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Could not allocate audio codec context\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1162</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1163</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1164</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1165</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* put sample parameters */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1166</span></pre></td><td class="code"><pre><span class="line">    c-&gt;bit_rate = <span class="number">64000</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1167</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1168</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* check that the encoder supports s16 pcm input */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1169</span></pre></td><td class="code"><pre><span class="line">    c-&gt;sample_fmt = AV_SAMPLE_FMT_S16;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1170</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!check_sample_fmt(codec, c-&gt;sample_fmt)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1171</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Encoder does not support sample format %s"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1172</span></pre></td><td class="code"><pre><span class="line">                av_get_sample_fmt_name(c-&gt;sample_fmt));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1173</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1174</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1175</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1176</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* select other audio parameters supported by the encoder */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1177</span></pre></td><td class="code"><pre><span class="line">    c-&gt;sample_rate    = select_sample_rate(codec);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1178</span></pre></td><td class="code"><pre><span class="line">    c-&gt;channel_layout = select_channel_layout(codec);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1179</span></pre></td><td class="code"><pre><span class="line">    c-&gt;channels       = av_get_channel_layout_nb_channels(c-&gt;channel_layout);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1180</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1181</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* open it */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1182</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (avcodec_open2(c, codec, <span class="literal">NULL</span>) &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1183</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Could not open codec\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1184</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1185</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1186</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1187</span></pre></td><td class="code"><pre><span class="line">    f = fopen(filename, <span class="string">"wb"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1188</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!f) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1189</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Could not open %s\n"</span>, filename);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1190</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1191</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1192</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1193</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* frame containing input raw audio */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1194</span></pre></td><td class="code"><pre><span class="line">    frame = av_frame_alloc();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1195</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!frame) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1196</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Could not allocate audio frame\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1197</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1198</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1199</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1200</span></pre></td><td class="code"><pre><span class="line">    frame-&gt;nb_samples     = c-&gt;frame_size;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1201</span></pre></td><td class="code"><pre><span class="line">    frame-&gt;format         = c-&gt;sample_fmt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1202</span></pre></td><td class="code"><pre><span class="line">    frame-&gt;channel_layout = c-&gt;channel_layout;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1203</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1204</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* allocate the data buffers */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1205</span></pre></td><td class="code"><pre><span class="line">    ret = av_frame_get_buffer(frame, <span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1206</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1207</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Could not allocate audio data buffers\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1208</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1209</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1210</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1211</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* encode a single tone sound */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1212</span></pre></td><td class="code"><pre><span class="line">    t = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1213</span></pre></td><td class="code"><pre><span class="line">    tincr = <span class="number">2</span> * M_PI * <span class="number">440.0</span> / c-&gt;sample_rate;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1214</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">200</span>; i++) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1215</span></pre></td><td class="code"><pre><span class="line">        av_init_packet(&amp;pkt);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1216</span></pre></td><td class="code"><pre><span class="line">        pkt.data = <span class="literal">NULL</span>; <span class="comment">// packet data will be allocated by the encoder</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1217</span></pre></td><td class="code"><pre><span class="line">        pkt.<span class="built_in">size</span> = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1218</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1219</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">/* make sure the frame is writable -- makes a copy if the encoder</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1220</span></pre></td><td class="code"><pre><span class="line"><span class="comment">         * kept a reference internally */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1221</span></pre></td><td class="code"><pre><span class="line">        ret = av_frame_make_writable(frame);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1222</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1223</span></pre></td><td class="code"><pre><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1224</span></pre></td><td class="code"><pre><span class="line">        samples = (<span class="keyword">uint16_t</span>*)frame-&gt;data[<span class="number">0</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1225</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1226</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; c-&gt;frame_size; j++) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1227</span></pre></td><td class="code"><pre><span class="line">            samples[<span class="number">2</span>*j] = (<span class="keyword">int</span>)(<span class="built_in">sin</span>(t) * <span class="number">10000</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1228</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1229</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">for</span> (k = <span class="number">1</span>; k &lt; c-&gt;channels; k++)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1230</span></pre></td><td class="code"><pre><span class="line">                samples[<span class="number">2</span>*j + k] = samples[<span class="number">2</span>*j];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1231</span></pre></td><td class="code"><pre><span class="line">            t += tincr;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1232</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1233</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">/* encode the samples */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1234</span></pre></td><td class="code"><pre><span class="line">        ret = avcodec_encode_audio2(c, &amp;pkt, frame, &amp;got_output);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1235</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1236</span></pre></td><td class="code"><pre><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error encoding audio frame\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1237</span></pre></td><td class="code"><pre><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1238</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1239</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (got_output) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1240</span></pre></td><td class="code"><pre><span class="line">            fwrite(pkt.data, <span class="number">1</span>, pkt.<span class="built_in">size</span>, f);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1241</span></pre></td><td class="code"><pre><span class="line">            av_packet_unref(&amp;pkt);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1242</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1243</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1244</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1245</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* get the delayed frames */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1246</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> (got_output = <span class="number">1</span>; got_output; i++) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1247</span></pre></td><td class="code"><pre><span class="line">        ret = avcodec_encode_audio2(c, &amp;pkt, <span class="literal">NULL</span>, &amp;got_output);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1248</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1249</span></pre></td><td class="code"><pre><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Error encoding frame\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1250</span></pre></td><td class="code"><pre><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1251</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1252</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1253</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span> (got_output) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1254</span></pre></td><td class="code"><pre><span class="line">            fwrite(pkt.data, <span class="number">1</span>, pkt.<span class="built_in">size</span>, f);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1255</span></pre></td><td class="code"><pre><span class="line">            av_packet_unref(&amp;pkt);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1256</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1257</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1258</span></pre></td><td class="code"><pre><span class="line">    fclose(f);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1259</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1260</span></pre></td><td class="code"><pre><span class="line">    av_frame_free(&amp;frame);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1261</span></pre></td><td class="code"><pre><span class="line">    avcodec_free_context(&amp;c);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1262</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1263</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1264</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1265</span></pre></td><td class="code"><pre><span class="line">```  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1266</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1267</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1268</span></pre></td><td class="code"><pre><span class="line">#### <span class="number">40.</span>SDL简介、编译与安装</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1269</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1270</span></pre></td><td class="code"><pre><span class="line">- SDL，全称：Simple DirectMedia Layer</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1271</span></pre></td><td class="code"><pre><span class="line">- 由C语言实现的跨平台的媒体开源库</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1272</span></pre></td><td class="code"><pre><span class="line">- 多用于开发游戏、模拟器、媒体播放器等多媒体应用领域</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1273</span></pre></td><td class="code"><pre><span class="line">- 官网：https:<span class="comment">//www.libsdl.org</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1274</span></pre></td><td class="code"><pre><span class="line">- 安装编译：</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1275</span></pre></td><td class="code"><pre><span class="line">    - <span class="number">1.</span> 下载SDL源码</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1276</span></pre></td><td class="code"><pre><span class="line">    - <span class="number">2.</span> 生成Makefile configure --prefix=/usr/local  （--prefix即为安装目录在哪儿）</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1277</span></pre></td><td class="code"><pre><span class="line">    - <span class="number">3.</span> 安装 sudo make -j <span class="number">8</span> &amp;&amp; make install (-j <span class="number">8</span> 的是意思是开<span class="number">8</span>个线程同时进行操作，即内核*<span class="number">2</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1278</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1279</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1280</span></pre></td><td class="code"><pre><span class="line">#### <span class="number">41.</span>SDL的使用步骤</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1281</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1282</span></pre></td><td class="code"><pre><span class="line">- 添加头文件 #include&lt;SDL.h&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1283</span></pre></td><td class="code"><pre><span class="line">- 初始化SDL</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1284</span></pre></td><td class="code"><pre><span class="line">- 退出SDL</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1285</span></pre></td><td class="code"><pre><span class="line">- SDL主要用来渲染窗口</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1286</span></pre></td><td class="code"><pre><span class="line">    - SDL_Init() / SDL——Quit()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1287</span></pre></td><td class="code"><pre><span class="line">    - SDL_CreateWindow() / SDL_DestroyWindow()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1288</span></pre></td><td class="code"><pre><span class="line">    - SDL_CreateRender() 创建渲染器，将图片渲染帧渲染到上边</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1289</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1290</span></pre></td><td class="code"><pre><span class="line">```c</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1291</span></pre></td><td class="code"><pre><span class="line">#include &lt;SDL.h&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1292</span></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1293</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1294</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[]) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1295</span></pre></td><td class="code"><pre><span class="line">    SDL_Window *window = <span class="literal">NULL</span>:];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1296</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 初始化</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1297</span></pre></td><td class="code"><pre><span class="line">    SDL_Init(SDL_INIT_VIDEO);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1298</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 创建窗口</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1299</span></pre></td><td class="code"><pre><span class="line">    window = SDL_CreateWindow(<span class="string">"SDL2 Window"</span>, <span class="number">200</span>, <span class="number">200</span>, <span class="number">640</span>, <span class="number">480</span>, SDL_WINDOW_SHOWN); <span class="comment">// name,x,y,height,width,option</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1300</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!window) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1301</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">printf</span>(<span class="string">"Failed to Create Window!"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1302</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">goto</span> __EXIT;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1303</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1304</span></pre></td><td class="code"><pre><span class="line">    SDL_DestroyWindow(window);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1305</span></pre></td><td class="code"><pre><span class="line">    __EXIT;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1306</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 退出</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1307</span></pre></td><td class="code"><pre><span class="line">    SDL_Quit();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1308</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1309</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1310</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建的窗口实际上是在内存上分配的空间，要显示的话需要将内容推动到显卡驱动上</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1311</span></pre></td><td class="code"><pre><span class="line">```  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1312</span></pre></td><td class="code"><pre><span class="line">- 执行：clang -g -o firstsdl firstsdl.c `pkg-<span class="built_in">config</span> --cflags --libs sdl2`</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1313</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1314</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1315</span></pre></td><td class="code"><pre><span class="line">#### <span class="number">42.</span>SDL渲染窗口</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1316</span></pre></td><td class="code"><pre><span class="line">- SDL_CreateRenderer / SDL_DestroyRenderer</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1317</span></pre></td><td class="code"><pre><span class="line">- SDL_RenderClear</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1318</span></pre></td><td class="code"><pre><span class="line">- SDL_RenderPresent 推送数据包</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1319</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1320</span></pre></td><td class="code"><pre><span class="line">```c</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1321</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;SDL.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1322</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1323</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1324</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1325</span></pre></td><td class="code"><pre><span class="line">    SDL_Window *window = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1326</span></pre></td><td class="code"><pre><span class="line">    SDL_Renderer *render = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1327</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 初始化</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1328</span></pre></td><td class="code"><pre><span class="line">    SDL_Init(SDL_INIT_VIDEO);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1329</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 创建窗口</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1330</span></pre></td><td class="code"><pre><span class="line">    window = SDL_CreateWindow(<span class="string">"SDL2 Window"</span>, <span class="number">200</span>, <span class="number">200</span>, <span class="number">640</span>, <span class="number">480</span>, SDL_WINDOW_SHOWN); <span class="comment">// name,x,y,height,width,option</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1331</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!window) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1332</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">printf</span>(<span class="string">"Failed to Create Window!"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1333</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">goto</span> __EXIT;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1334</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1335</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 创建渲染器</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1336</span></pre></td><td class="code"><pre><span class="line">    render = SDL_CreateRenderer(window, <span class="number">-1</span>, <span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1337</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!render) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1338</span></pre></td><td class="code"><pre><span class="line">        SDL_Log(<span class="string">"Faild to Create Render!"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1339</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">goto</span> __DWINDOW;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1340</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1341</span></pre></td><td class="code"><pre><span class="line">    SDL_SetRenderDrawColor(render, <span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>); <span class="comment">// rgba</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1342</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 清屏缓存</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1343</span></pre></td><td class="code"><pre><span class="line">    SDL_RenderClear(render);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1344</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 推送到显卡</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1345</span></pre></td><td class="code"><pre><span class="line">    SDL_RenderPresent(render);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1346</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 这里是延迟，为了看到效果</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1347</span></pre></td><td class="code"><pre><span class="line">    SDL_Delay(<span class="number">30000</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1348</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 销毁窗口</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1349</span></pre></td><td class="code"><pre><span class="line">__DWINDOW:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1350</span></pre></td><td class="code"><pre><span class="line">    SDL_DestroyWindow(window);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1351</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 退出</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1352</span></pre></td><td class="code"><pre><span class="line">__EXIT:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1353</span></pre></td><td class="code"><pre><span class="line">    SDL_Quit();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1354</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1355</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1356</span></pre></td><td class="code"><pre><span class="line">```  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1357</span></pre></td><td class="code"><pre><span class="line">- 执行：clang -g -o firstsdl firstsdl.c `pkg-<span class="built_in">config</span> --cflags --libs sdl2`</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1358</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1359</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1360</span></pre></td><td class="code"><pre><span class="line">#### <span class="number">43.</span>SDL处理事件基本原理</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1361</span></pre></td><td class="code"><pre><span class="line">- SDL将所有的事件都存放到一个队列中</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1362</span></pre></td><td class="code"><pre><span class="line">- 所有对事件的操作，其实就是对队列的操作</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1363</span></pre></td><td class="code"><pre><span class="line">- SDL事件分类</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1364</span></pre></td><td class="code"><pre><span class="line">    - SDL_WIndowEvent: 窗口事件</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1365</span></pre></td><td class="code"><pre><span class="line">    - SDL_KeyboardEvent: 键盘事件</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1366</span></pre></td><td class="code"><pre><span class="line">    - SDL_MouseMotionEvent: 鼠标事件</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1367</span></pre></td><td class="code"><pre><span class="line">- SDL事件处理</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1368</span></pre></td><td class="code"><pre><span class="line">    - SDL_PollEvent 轮循队列处理事件</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1369</span></pre></td><td class="code"><pre><span class="line">    - SDL_WaitEvent 事件触发机制</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1370</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1371</span></pre></td><td class="code"><pre><span class="line">```c</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1372</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;SDL.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1373</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1374</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1375</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1376</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> quit = <span class="number">1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1377</span></pre></td><td class="code"><pre><span class="line">    SDL_Event event;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1378</span></pre></td><td class="code"><pre><span class="line">    SDL_Window *window = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1379</span></pre></td><td class="code"><pre><span class="line">    SDL_Renderer *render = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1380</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 初始化</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1381</span></pre></td><td class="code"><pre><span class="line">    SDL_Init(SDL_INIT_VIDEO);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1382</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 创建窗口</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1383</span></pre></td><td class="code"><pre><span class="line">    window = SDL_CreateWindow(<span class="string">"SDL2 Window"</span>, <span class="number">200</span>, <span class="number">200</span>, <span class="number">640</span>, <span class="number">480</span>, SDL_WINDOW_SHOWN); <span class="comment">// name,x,y,height,width,option</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1384</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!window) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1385</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">printf</span>(<span class="string">"Failed to Create Window!"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1386</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">goto</span> __EXIT;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1387</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1388</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 创建渲染器</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1389</span></pre></td><td class="code"><pre><span class="line">    render = SDL_CreateRenderer(window, <span class="number">-1</span>, <span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1390</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!render) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1391</span></pre></td><td class="code"><pre><span class="line">        SDL_Log(<span class="string">"Faild to Create Render!"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1392</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">goto</span> __DWINDOW;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1393</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1394</span></pre></td><td class="code"><pre><span class="line">    SDL_SetRenderDrawColor(render, <span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>); <span class="comment">// rgba</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1395</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 清屏缓存</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1396</span></pre></td><td class="code"><pre><span class="line">    SDL_RenderClear(render);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1397</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 推送到显卡</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1398</span></pre></td><td class="code"><pre><span class="line">    SDL_RenderPresent(render);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1399</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">do</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1400</span></pre></td><td class="code"><pre><span class="line">        SDL_WaitEvent(&amp;event);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1401</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">switch</span>(event.type) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1402</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">case</span> SDL_QUIT:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1403</span></pre></td><td class="code"><pre><span class="line">                quit = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1404</span></pre></td><td class="code"><pre><span class="line">                <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1405</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">default</span>:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1406</span></pre></td><td class="code"><pre><span class="line">                SDL_Log(<span class="string">"event type is %d"</span>, event.type);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1407</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1408</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">while</span>(quit);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1409</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 销毁窗口</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1410</span></pre></td><td class="code"><pre><span class="line">__DWINDOW:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1411</span></pre></td><td class="code"><pre><span class="line">    SDL_DestroyWindow(window);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1412</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 退出</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1413</span></pre></td><td class="code"><pre><span class="line">__EXIT:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1414</span></pre></td><td class="code"><pre><span class="line">    SDL_Quit();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1415</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1416</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<ul>
<li>执行：clang -g -o eventsdl eventsdl.c <code>pkg-config --cflags --libs sdl2</code></li>
</ul>
<h4 id="44-纹理渲染"><a href="#44-纹理渲染" class="headerlink" title="44.纹理渲染"></a>44.纹理渲染</h4><ul>
<li>内存图像 –（渲染器）– 纹理 –（交换：显卡计算）– 窗口展示</li>
<li>纹理相关的API<ul>
<li>SDL_CreateTexture()<ul>
<li>format: YUV,GRB</li>
<li>access: Texture类型、Target，Stream</li>
</ul>
</li>
<li>SDL_DestroyTexture()</li>
</ul>
</li>
<li>渲染相关的API<ul>
<li>SDL_SetRenderTarget()  // 设置渲染目标</li>
<li>SDL_RenderClear()</li>
<li>SDL_RenderCopy()</li>
<li>SDL_RenderPresent() // 控制渲染</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;SDL.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> quit = <span class="number">1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    SDL_Rect <span class="built_in">rect</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">rect</span>.w = <span class="number">30</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">rect</span>.h = <span class="number">30</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    SDL_Event event;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    SDL_Texture *texture = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    SDL_Window *window = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    SDL_Renderer *render = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 初始化</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    SDL_Init(SDL_INIT_VIDEO);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 创建窗口</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    window = SDL_CreateWindow(<span class="string">"SDL2 Window"</span>, <span class="number">200</span>, <span class="number">200</span>, <span class="number">640</span>, <span class="number">480</span>, SDL_WINDOW_SHOWN); <span class="comment">// name,x,y,height,width,option</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!window) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">printf</span>(<span class="string">"Failed to Create Window!"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">goto</span> __EXIT;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 创建渲染器</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    render = SDL_CreateRenderer(window, <span class="number">-1</span>, <span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!render) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">        SDL_Log(<span class="string">"Faild to Create Render!"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">goto</span> __DWINDOW;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 创建纹理</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">    texture = SDL_CreateTexture(render, SDL_PIXELFORMAT_RGBA8888, SDL_TEXTUREACCESS_TARGET, <span class="number">640</span>, <span class="number">480</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!texture) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">        SDL_Log(<span class="string">"Failed to Create Texture!"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">goto</span> __RENDER;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">do</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">        SDL_PollEvent(&amp;event);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">switch</span>(event.type) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">case</span> SDL_QUIT:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">                quit = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">                <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">default</span>:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">                SDL_Log(<span class="string">"event type is %d"</span>, event.type);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 创建方块</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">rect</span>.x = rand() % <span class="number">600</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">rect</span>.y = rand() % <span class="number">450</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">        SDL_SetRenderTarget(render, texture);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">        SDL_SetRenderDrawColor(render, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">        SDL_RenderClear(render);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 绘制方块</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line">        SDL_RenderDrawRect(render, &amp;<span class="built_in">rect</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line">        SDL_SetRenderDrawColor(render, <span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">51</span></pre></td><td class="code"><pre><span class="line">        SDL_RenderFillRect(render, &amp;<span class="built_in">rect</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">52</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// 推送到显卡</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">53</span></pre></td><td class="code"><pre><span class="line">        SDL_SetRenderTarget(render, <span class="literal">NULL</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">54</span></pre></td><td class="code"><pre><span class="line">        SDL_RenderCopy(render, texture, <span class="literal">NULL</span>, <span class="literal">NULL</span>); <span class="comment">// 拷贝描述文件到显卡驱动</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">55</span></pre></td><td class="code"><pre><span class="line">        SDL_RenderPresent(render); <span class="comment">// 告诉显卡让其显示她已经按照描述文件绘制好的图像显示到屏幕上</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">56</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">while</span>(quit);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">57</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 销毁纹理</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">58</span></pre></td><td class="code"><pre><span class="line">__RENDER:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">59</span></pre></td><td class="code"><pre><span class="line">    SDL_DestroyTexture(texture);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">60</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 销毁窗口</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">61</span></pre></td><td class="code"><pre><span class="line">__DWINDOW:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">62</span></pre></td><td class="code"><pre><span class="line">    SDL_DestroyWindow(window);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">63</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 退出</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">64</span></pre></td><td class="code"><pre><span class="line">__EXIT:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">65</span></pre></td><td class="code"><pre><span class="line">    SDL_Quit();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">66</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">67</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<ul>
<li>执行：clang -g -o texturesdl texturesdl.c <code>pkg-config --cflags --libs sdl2</code></li>
</ul>
<h4 id="45-YUV播放器"><a href="#45-YUV播放器" class="headerlink" title="45.YUV播放器"></a>45.YUV播放器</h4><ul>
<li>创建线程<ul>
<li>SDL_CreateThread<ul>
<li>fn: 线程执行函数</li>
<li>name: 线程名</li>
<li>data: 执行函数参数</li>
</ul>
</li>
</ul>
</li>
<li>更新纹理<ul>
<li>SDL_UpdateTexture()</li>
<li>SDL_UpdateYUVTexture()  // 需要每一个分量的数据<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;SDL.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> bpp=<span class="number">12</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> screen_w=<span class="number">500</span>,screen_h=<span class="number">500</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLOCK_SIZE 4096000</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//event message</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REFRESH_EVENT  (SDL_USEREVENT + 1)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> QUIT_EVENT  (SDL_USEREVENT + 2)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> thread_exit=<span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">refresh_video_timer</span><span class="params">(<span class="keyword">void</span> *udata)</span></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    thread_exit=<span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">while</span> (!thread_exit) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">        SDL_Event event;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">        event.type = REFRESH_EVENT;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">        SDL_PushEvent(&amp;event);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">        SDL_Delay(<span class="number">40</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">    thread_exit=<span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//push quit event</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">    SDL_Event event;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">    event.type = QUIT_EVENT;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">    SDL_PushEvent(&amp;event);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">    FILE *video_fd = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">    SDL_Event event;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">    SDL_Rect <span class="built_in">rect</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">    Uint32 pixformat = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line">    SDL_Window *win = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line">    SDL_Renderer *renderer = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">51</span></pre></td><td class="code"><pre><span class="line">    SDL_Texture *texture = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">52</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">53</span></pre></td><td class="code"><pre><span class="line">    SDL_Thread *timer_thread = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">54</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">55</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> w_width = <span class="number">640</span>; w_height = <span class="number">480</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">56</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> video_width = <span class="number">320</span>, video_height = <span class="number">180</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">57</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">58</span></pre></td><td class="code"><pre><span class="line">    Uint8 *video_pos = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">59</span></pre></td><td class="code"><pre><span class="line">    Uint8 *video_end = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">60</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">61</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> remain_len = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">62</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> video_buff_len = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">63</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> blank space_len = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">64</span></pre></td><td class="code"><pre><span class="line">    Uint8 *video_buf[BLOCK_SIZE];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">65</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">66</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *path = <span class="string">"test_yuv420p_320x180.yuv"</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">67</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">68</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> yuv_frame_len = video_width * video_height * <span class="number">12</span> / <span class="number">8</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">69</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">70</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//initialize SDL</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">71</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(SDL_Init(SDL_INIT_VIDEO)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">72</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>( <span class="built_in">stderr</span>, <span class="string">"Could not initialize SDL - %s\n"</span>, SDL_GetError());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">73</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">74</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">75</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">76</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//creat window from SDL</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">77</span></pre></td><td class="code"><pre><span class="line">    win = SDL_CreateWindow(<span class="string">"YUV Player"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">78</span></pre></td><td class="code"><pre><span class="line">                           SDL_WINDOWPOS_UNDEFINED,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">79</span></pre></td><td class="code"><pre><span class="line">                           SDL_WINDOWPOS_UNDEFINED,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">80</span></pre></td><td class="code"><pre><span class="line">                           w_width, w_height,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">81</span></pre></td><td class="code"><pre><span class="line">                           SDL_WINDOW_OPENGL|SDL_WINDOW_RESIZABLE);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">82</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(!win) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">83</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Failed to create window, %s\n"</span>,SDL_GetError());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">84</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">goto</span> __FAIL;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">85</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">86</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">87</span></pre></td><td class="code"><pre><span class="line">    renderer = SDL_CreateRenderer(screen, <span class="number">-1</span>, <span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">88</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">89</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//IYUV: Y + U + V  (3 planes)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">90</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//YV12: Y + V + U  (3 planes)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">91</span></pre></td><td class="code"><pre><span class="line">    pixformat= SDL_PIXELFORMAT_IYUV;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">92</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">93</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//create texture for render</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">94</span></pre></td><td class="code"><pre><span class="line">    texture = SDL_CreateTexture(renderer,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">95</span></pre></td><td class="code"><pre><span class="line">                                pixformat,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">96</span></pre></td><td class="code"><pre><span class="line">                                SDL_TEXTUREACCESS_STREAMING,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">97</span></pre></td><td class="code"><pre><span class="line">                                video_width,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">98</span></pre></td><td class="code"><pre><span class="line">                                video_height);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">99</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">100</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//open yuv file</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">101</span></pre></td><td class="code"><pre><span class="line">    video_fd = fopen(path, <span class="string">"r"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">102</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>( !video_fd )&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">103</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Failed to open yuv file\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">104</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">goto</span> __FAIL;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">105</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">106</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">107</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//read block data</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">108</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(video_buff_len = fread(video_buf, <span class="number">1</span>, BLOCK_SIZE, video_fd) &lt;= <span class="number">0</span>)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">109</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Failed to read data from yuv file!\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">110</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">goto</span> __FAIL;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">111</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">112</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">113</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//set video positon</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">114</span></pre></td><td class="code"><pre><span class="line">    video_pos = video_buf;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">115</span></pre></td><td class="code"><pre><span class="line">    video_end = video_buf + video_buff_len;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">116</span></pre></td><td class="code"><pre><span class="line">    blank_space_len = BLOCK_SIZE - video_buff_len;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">117</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">118</span></pre></td><td class="code"><pre><span class="line">    timer_thread = SDL_CreateThread(refresh_video_timer,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">119</span></pre></td><td class="code"><pre><span class="line">                                    <span class="literal">NULL</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">120</span></pre></td><td class="code"><pre><span class="line">                                    <span class="literal">NULL</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">121</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">122</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">do</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">123</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">//Wait</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">124</span></pre></td><td class="code"><pre><span class="line">        SDL_WaitEvent(&amp;event);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">125</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span>(event.type==REFRESH_EVENT)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">126</span></pre></td><td class="code"><pre><span class="line">            <span class="comment">//not enought data to render</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">127</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">if</span>((video_pos + yuv_frame_len) &gt; video_end)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">128</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">129</span></pre></td><td class="code"><pre><span class="line">                <span class="comment">//have remain data, but there isn't space</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">130</span></pre></td><td class="code"><pre><span class="line">                remain_len = video_end - video_pos;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">131</span></pre></td><td class="code"><pre><span class="line">                <span class="keyword">if</span>(remain_len &amp;&amp; !black_space_len) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">132</span></pre></td><td class="code"><pre><span class="line">                    <span class="comment">//copy data to header of buffer</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">133</span></pre></td><td class="code"><pre><span class="line">                    <span class="built_in">memcpy</span>(video_buf, video_pos, remain_len);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">134</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">135</span></pre></td><td class="code"><pre><span class="line">                    blank_space_len = BLOCK_SIZE - remain_len;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">136</span></pre></td><td class="code"><pre><span class="line">                    video_pos = video_buf;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">137</span></pre></td><td class="code"><pre><span class="line">                    video_end = video_buf + remain_len;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">138</span></pre></td><td class="code"><pre><span class="line">                &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">139</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">140</span></pre></td><td class="code"><pre><span class="line">                <span class="comment">//at the end of buffer, so rotate to header of buffer</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">141</span></pre></td><td class="code"><pre><span class="line">                <span class="keyword">if</span>(video_end == (video_buf + BLOCK_SIZE))&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">142</span></pre></td><td class="code"><pre><span class="line">                    video_pos = video_buf;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">143</span></pre></td><td class="code"><pre><span class="line">                    video_end = video_buf;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">144</span></pre></td><td class="code"><pre><span class="line">                    blank_space_len = BLOCK_SIZE;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">145</span></pre></td><td class="code"><pre><span class="line">                &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">146</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">147</span></pre></td><td class="code"><pre><span class="line">                <span class="comment">//read data from yuv file to buffer</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">148</span></pre></td><td class="code"><pre><span class="line">                <span class="keyword">if</span>(video_buff_len = fread(video_end, <span class="number">1</span>, blank_space_len, video_fd) &lt;= <span class="number">0</span>)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">149</span></pre></td><td class="code"><pre><span class="line">                    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"eof, exit thread!"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">150</span></pre></td><td class="code"><pre><span class="line">                    thread_exit = <span class="number">1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">151</span></pre></td><td class="code"><pre><span class="line">                    <span class="keyword">continue</span>;<span class="comment">// to wait event for exiting</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">152</span></pre></td><td class="code"><pre><span class="line">                &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">153</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">154</span></pre></td><td class="code"><pre><span class="line">                <span class="comment">//reset video_end</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">155</span></pre></td><td class="code"><pre><span class="line">                video_end += video_buff_len;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">156</span></pre></td><td class="code"><pre><span class="line">            &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">157</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">158</span></pre></td><td class="code"><pre><span class="line">            SDL_UpdateTexture( texture, <span class="literal">NULL</span>, video_pos, video_width);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">159</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">160</span></pre></td><td class="code"><pre><span class="line">            <span class="comment">//FIX: If window is resize</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">161</span></pre></td><td class="code"><pre><span class="line">            <span class="built_in">rect</span>.x = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">162</span></pre></td><td class="code"><pre><span class="line">            <span class="built_in">rect</span>.y = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">163</span></pre></td><td class="code"><pre><span class="line">            <span class="built_in">rect</span>.w = w_width;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">164</span></pre></td><td class="code"><pre><span class="line">            <span class="built_in">rect</span>.h = w_height;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">165</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">166</span></pre></td><td class="code"><pre><span class="line">            SDL_RenderClear( renderer );</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">167</span></pre></td><td class="code"><pre><span class="line">            SDL_RenderCopy( renderer, texture, <span class="literal">NULL</span>, &amp;<span class="built_in">rect</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">168</span></pre></td><td class="code"><pre><span class="line">            SDL_RenderPresent( renderer );</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">169</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">170</span></pre></td><td class="code"><pre><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(event.type==SDL_WINDOWEVENT)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">171</span></pre></td><td class="code"><pre><span class="line">            <span class="comment">//If Resize</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">172</span></pre></td><td class="code"><pre><span class="line">            SDL_GetWindowSize(win, &amp;w_width, &amp;w_height);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">173</span></pre></td><td class="code"><pre><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(event.type==SDL_QUIT)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">174</span></pre></td><td class="code"><pre><span class="line">            thread_exit=<span class="number">1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">175</span></pre></td><td class="code"><pre><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(event.type==QUIT_EVENT)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">176</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">177</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">178</span></pre></td><td class="code"><pre><span class="line">    &#125;<span class="keyword">while</span> ( <span class="number">1</span> );</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">179</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">180</span></pre></td><td class="code"><pre><span class="line">__FAIL:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">181</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">182</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//close file</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">183</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(video_fd)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">184</span></pre></td><td class="code"><pre><span class="line">        fclose(video_fd);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">185</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">186</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">187</span></pre></td><td class="code"><pre><span class="line">    SDL_Quit();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">188</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">189</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">190</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">191</span></pre></td><td class="code"><pre><span class="line">```  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">192</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">193</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">194</span></pre></td><td class="code"><pre><span class="line">#### <span class="number">46.</span>SDL播放音频</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">195</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">196</span></pre></td><td class="code"><pre><span class="line">- 将多媒体文件分解成音频轨、视频轨、字幕轨等等（解复用）</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">197</span></pre></td><td class="code"><pre><span class="line">- 视频轨解码成yuv数据</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">198</span></pre></td><td class="code"><pre><span class="line">    - 将yuv数据输送给SDL</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">199</span></pre></td><td class="code"><pre><span class="line">    - SDL将yuv数据输送到显卡</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">200</span></pre></td><td class="code"><pre><span class="line">    - 显卡显示到屏幕</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">201</span></pre></td><td class="code"><pre><span class="line">- 音频轨解码成pcm数据</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">202</span></pre></td><td class="code"><pre><span class="line">    - 将pcm数据输送给SDL</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">203</span></pre></td><td class="code"><pre><span class="line">    - SDL驱动声卡将声音播放出来</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">204</span></pre></td><td class="code"><pre><span class="line">- 播放音频基本流程</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">205</span></pre></td><td class="code"><pre><span class="line">    - <span class="number">1.</span> 打开音频设备</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">206</span></pre></td><td class="code"><pre><span class="line">    - <span class="number">2.</span> 设置音频参数 <span class="comment">// 通道数、采样率、采样大小</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">207</span></pre></td><td class="code"><pre><span class="line">    - <span class="number">3.</span> 向声卡喂数据</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">208</span></pre></td><td class="code"><pre><span class="line">    - <span class="number">4.</span> 播放音频</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">209</span></pre></td><td class="code"><pre><span class="line">    - <span class="number">5.</span> 关闭设备</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">210</span></pre></td><td class="code"><pre><span class="line">- 播放音频的基本原则</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">211</span></pre></td><td class="code"><pre><span class="line">    - 声卡向你要数据而不是你主动推给声卡</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">212</span></pre></td><td class="code"><pre><span class="line">    - 数据的多少是由音频参数决定的</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">213</span></pre></td><td class="code"><pre><span class="line">- SDL音频API</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">214</span></pre></td><td class="code"><pre><span class="line">    - SDL_OpenAudio / SDL_CloseAudio</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">215</span></pre></td><td class="code"><pre><span class="line">    - SDL_PauseAudio 暂停播放</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">216</span></pre></td><td class="code"><pre><span class="line">    - SDL_MixAudio  混音</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">217</span></pre></td><td class="code"><pre><span class="line">```c</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">218</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavutil/log.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">219</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavformat/avformat.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">220</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">221</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">222</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">223</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">224</span></pre></td><td class="code"><pre><span class="line">```  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">225</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">226</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">227</span></pre></td><td class="code"><pre><span class="line">#### <span class="number">47.</span>PCM音频播放器</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">228</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">229</span></pre></td><td class="code"><pre><span class="line">```c</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">230</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;SDL.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">231</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLOCK_SIZE 4096000</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">232</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">size_t</span> buffer_len = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">233</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> Uint8 *audio_buf = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">234</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> Uint8 *audio_pos = <span class="literal">NULL</span>:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">235</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">236</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声卡主动读取数据的回调函数</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">237</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> read_audio_data(<span class="keyword">void</span> *udata, Uint8 *stream, <span class="keyword">int</span> len) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">238</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 判断当前文件数据是否读区完</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">239</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (buffer_len == <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">240</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">241</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">242</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 清空声卡SDL缓存数据，防止音质变差</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">243</span></pre></td><td class="code"><pre><span class="line">    SDL_memset(stream, <span class="number">0</span>, len);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">244</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 判断读取数据，如果需要的数据小于缓存数据，则取读取数据大小，反之取我们定义的缓冲大小</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">245</span></pre></td><td class="code"><pre><span class="line">    len = (len &lt; buffer_len) ? len : buffer_len;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">246</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 混音拷贝</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">247</span></pre></td><td class="code"><pre><span class="line">    SDL_MixAudio(stream, audio_pos, len, SDL_MIX_MAXVOLUME);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">248</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 修改读取之后的缓冲区的位置信息</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">249</span></pre></td><td class="code"><pre><span class="line">    audio_pos += len;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">250</span></pre></td><td class="code"><pre><span class="line">    buffer_len -= len;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">251</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">252</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">253</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">254</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> ret = <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">255</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">char</span> *path = <span class="string">"./1.pcm"</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">256</span></pre></td><td class="code"><pre><span class="line">    FILE* audio_fd = <span class="literal">NULL</span>:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">257</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">258</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 初始化SDL</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">259</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (SDL_Init(SDL_INIT_AUDIO | SDL_INIT_TIMER)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">260</span></pre></td><td class="code"><pre><span class="line">        SDL_Log(<span class="string">"Failed to initial!"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">261</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> ret;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">262</span></pre></td><td class="code"><pre><span class="line">    &#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">263</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">264</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 打开pcm文件</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">265</span></pre></td><td class="code"><pre><span class="line">    audio_fd = fopen(path, <span class="string">"r"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">266</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!audio_fd) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">267</span></pre></td><td class="code"><pre><span class="line">        SDL_Log(<span class="string">"Failed to open audio file!"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">268</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">goto</span> __FAIL;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">269</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">270</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">271</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 分配空间</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">272</span></pre></td><td class="code"><pre><span class="line">    audio_buf = (Uint8*)<span class="built_in">malloc</span>(BLOCK_SIZE);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">273</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!audio_buf) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">274</span></pre></td><td class="code"><pre><span class="line">        SDL_Log(<span class="string">"Failed to alloc memory!"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">275</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">goto</span> __FAIL;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">276</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">277</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">278</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 打开音频设备</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">279</span></pre></td><td class="code"><pre><span class="line">    SDL_AudioSpec spec;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">280</span></pre></td><td class="code"><pre><span class="line">    spec.freq = <span class="number">44100</span>; <span class="comment">// 采样率</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">281</span></pre></td><td class="code"><pre><span class="line">    spec.channels = <span class="number">2</span>; <span class="comment">// 通道数</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">282</span></pre></td><td class="code"><pre><span class="line">    spec.format = AUDIO_S16SYS; <span class="comment">// 采样大小</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">283</span></pre></td><td class="code"><pre><span class="line">    spec.silence = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">284</span></pre></td><td class="code"><pre><span class="line">    spec.callback = read_audio_data; <span class="comment">// 声卡要数据的回调函数</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">285</span></pre></td><td class="code"><pre><span class="line">    spec.userdata = <span class="literal">NULL</span>; <span class="comment">// 声卡回调参数</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">286</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(SDL_OpenAudio(&amp;spec, <span class="literal">NULL</span>)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">287</span></pre></td><td class="code"><pre><span class="line">        SDL_Log(<span class="string">"Failed to open audio device!"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">288</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">goto</span> __FAIL;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">289</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">290</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">291</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 启动播放</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">292</span></pre></td><td class="code"><pre><span class="line">    SDL_PauseAudio(<span class="number">0</span>); <span class="comment">// 0是播放，1是暂停</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">293</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">294</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 循环读取文件数据到缓冲区</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">295</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">do</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">296</span></pre></td><td class="code"><pre><span class="line">        buffer_len = fread(audio_buf, <span class="number">1</span>, BLOCK_SIZE, audio_fd);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">297</span></pre></td><td class="code"><pre><span class="line">        audio_pos = audio_buf;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">298</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">while</span> (audio_pos &lt; (audio_buf + buffer_len)) &#123; <span class="comment">// 判断buffer里是否还有数据</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">299</span></pre></td><td class="code"><pre><span class="line">            SDL_Delay(<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">300</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">301</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">while</span> (buffer_len != <span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">302</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">303</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 关闭音频设备</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">304</span></pre></td><td class="code"><pre><span class="line">    SDL_CloseAudio();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">305</span></pre></td><td class="code"><pre><span class="line">    ret = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">306</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">307</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 关闭SDL和pcm文件、释放空间</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">308</span></pre></td><td class="code"><pre><span class="line">__FAIL:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">309</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (audio_buf) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">310</span></pre></td><td class="code"><pre><span class="line">        <span class="built_in">free</span>(audio_buf);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">311</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">312</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (audio_fd) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">313</span></pre></td><td class="code"><pre><span class="line">        fclose(audio_fd);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">314</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">315</span></pre></td><td class="code"><pre><span class="line">    SDL_Quit();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">316</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> ret;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">317</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">318</span></pre></td><td class="code"><pre><span class="line">```  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">319</span></pre></td><td class="code"><pre><span class="line">- 执行：clang -g -o pcmplay pcmplay.c `pkg-<span class="built_in">config</span> --cflags --libs sdl2`</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">320</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">321</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">322</span></pre></td><td class="code"><pre><span class="line">#### <span class="number">48.</span>实现一个最简单的播放器</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">323</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">324</span></pre></td><td class="code"><pre><span class="line">- 只实现播放</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">325</span></pre></td><td class="code"><pre><span class="line">- 将ffmpeg与SDL结合</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">326</span></pre></td><td class="code"><pre><span class="line">- 通过ffmpeg解码视频数据</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">327</span></pre></td><td class="code"><pre><span class="line">- 通过SDL进行渲染</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">328</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">329</span></pre></td><td class="code"><pre><span class="line">```c</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">330</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">331</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;SDL.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">332</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">333</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavcodec/avcodec.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">334</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavformat/avformat.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">335</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libswscale/swscale.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">336</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">337</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// compatibility with newer API</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">338</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> LIBAVCODEC_VERSION_INT &lt; AV_VERSION_INT(55,28,1)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">339</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> av_frame_alloc avcodec_alloc_frame</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">340</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> av_frame_free avcodec_free_frame</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">341</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">342</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">343</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">344</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">345</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> ret = <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">346</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">347</span></pre></td><td class="code"><pre><span class="line">  AVFormatContext *pFormatCtx = <span class="literal">NULL</span>; <span class="comment">//for opening multi-media file</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">348</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">349</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span>             i, videoStream;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">350</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">351</span></pre></td><td class="code"><pre><span class="line">  AVCodecContext  *pCodecCtxOrig = <span class="literal">NULL</span>; <span class="comment">//codec context</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">352</span></pre></td><td class="code"><pre><span class="line">  AVCodecContext  *pCodecCtx = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">353</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">354</span></pre></td><td class="code"><pre><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">SwsContext</span> *<span class="title">sws_ctx</span> = <span class="title">NULL</span>;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">355</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">356</span></pre></td><td class="code"><pre><span class="line">  AVCodec         *pCodec = <span class="literal">NULL</span>; <span class="comment">// the codecer</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">357</span></pre></td><td class="code"><pre><span class="line">  AVFrame         *pFrame = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">358</span></pre></td><td class="code"><pre><span class="line">  AVPacket        packet;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">359</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">360</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span>             frameFinished;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">361</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">float</span>           aspect_ratio;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">362</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">363</span></pre></td><td class="code"><pre><span class="line">  AVPicture  	  *pict  = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">364</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">365</span></pre></td><td class="code"><pre><span class="line">  SDL_Rect        <span class="built_in">rect</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">366</span></pre></td><td class="code"><pre><span class="line">  Uint32 	  pixformat; </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">367</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">368</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">//for render</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">369</span></pre></td><td class="code"><pre><span class="line">  SDL_Window 	  *win = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">370</span></pre></td><td class="code"><pre><span class="line">  SDL_Renderer    *renderer = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">371</span></pre></td><td class="code"><pre><span class="line">  SDL_Texture     *texture = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">372</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">373</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">//set defualt size of window </span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">374</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> w_width = <span class="number">640</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">375</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> w_height = <span class="number">480</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">376</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">377</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(argc &lt; <span class="number">2</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">378</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//fprintf(stderr, "Usage: command &lt;file&gt;\n");</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">379</span></pre></td><td class="code"><pre><span class="line">    SDL_LogError(SDL_LOG_CATEGORY_APPLICATION, <span class="string">"Usage: command &lt;file&gt;"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">380</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> ret;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">381</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">382</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">383</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(SDL_Init(SDL_INIT_VIDEO | SDL_INIT_AUDIO | SDL_INIT_TIMER)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">384</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//fprintf(stderr, "Could not initialize SDL - %s\n", SDL_GetError());</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">385</span></pre></td><td class="code"><pre><span class="line">    SDL_LogError(SDL_LOG_CATEGORY_APPLICATION, <span class="string">"Could not initialize SDL - %s\n"</span>, SDL_GetError());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">386</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> ret;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">387</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">388</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">389</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">//Register all formats and codecs</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">390</span></pre></td><td class="code"><pre><span class="line">  av_register_all();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">391</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">392</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Open video file</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">393</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(avformat_open_input(&amp;pFormatCtx, argv[<span class="number">1</span>], <span class="literal">NULL</span>, <span class="literal">NULL</span>)!=<span class="number">0</span>)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">394</span></pre></td><td class="code"><pre><span class="line">    SDL_LogError(SDL_LOG_CATEGORY_APPLICATION, <span class="string">"Failed to open video file!"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">395</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">goto</span> __FAIL; <span class="comment">// Couldn't open file</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">396</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">397</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">398</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Retrieve stream information</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">399</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(avformat_find_stream_info(pFormatCtx, <span class="literal">NULL</span>)&lt;<span class="number">0</span>)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">400</span></pre></td><td class="code"><pre><span class="line">    SDL_LogError(SDL_LOG_CATEGORY_APPLICATION, <span class="string">"Failed to find stream infomation!"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">401</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">goto</span> __FAIL; <span class="comment">// Couldn't find stream information</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">402</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">403</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">404</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Dump information about file onto standard error</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">405</span></pre></td><td class="code"><pre><span class="line">  av_dump_format(pFormatCtx, <span class="number">0</span>, argv[<span class="number">1</span>], <span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">406</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">407</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Find the first video stream</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">408</span></pre></td><td class="code"><pre><span class="line">  videoStream=<span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">409</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;pFormatCtx-&gt;nb_streams; i++) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">410</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(pFormatCtx-&gt;streams[i]-&gt;codec-&gt;codec_type==AVMEDIA_TYPE_VIDEO) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">411</span></pre></td><td class="code"><pre><span class="line">      videoStream=i;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">412</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">413</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">414</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">415</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">416</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(videoStream==<span class="number">-1</span>)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">417</span></pre></td><td class="code"><pre><span class="line">    SDL_LogError(SDL_LOG_CATEGORY_APPLICATION, <span class="string">"Din't find a video stream!"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">418</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">goto</span> __FAIL;<span class="comment">// Didn't find a video stream</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">419</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">420</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">421</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Get a pointer to the codec context for the video stream</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">422</span></pre></td><td class="code"><pre><span class="line">  pCodecCtxOrig=pFormatCtx-&gt;streams[videoStream]-&gt;codec;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">423</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">424</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Find the decoder for the video stream</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">425</span></pre></td><td class="code"><pre><span class="line">  pCodec=avcodec_find_decoder(pCodecCtxOrig-&gt;codec_id);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">426</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(pCodec==<span class="literal">NULL</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">427</span></pre></td><td class="code"><pre><span class="line">    SDL_LogError(SDL_LOG_CATEGORY_APPLICATION, <span class="string">"Unsupported codec!\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">428</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">goto</span> __FAIL; <span class="comment">// Codec not found</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">429</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">430</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">431</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Copy context</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">432</span></pre></td><td class="code"><pre><span class="line">  pCodecCtx = avcodec_alloc_context3(pCodec);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">433</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(avcodec_copy_context(pCodecCtx, pCodecCtxOrig) != <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">434</span></pre></td><td class="code"><pre><span class="line">    SDL_LogError(SDL_LOG_CATEGORY_APPLICATION,  <span class="string">"Couldn't copy codec context"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">435</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">goto</span> __FAIL;<span class="comment">// Error copying codec context</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">436</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">437</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">438</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Open codec</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">439</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(avcodec_open2(pCodecCtx, pCodec, <span class="literal">NULL</span>)&lt;<span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">440</span></pre></td><td class="code"><pre><span class="line">    SDL_LogError(SDL_LOG_CATEGORY_APPLICATION, <span class="string">"Failed to open decoder!\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">441</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">goto</span> __FAIL; <span class="comment">// Could not open codec</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">442</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">443</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">444</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Allocate video frame</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">445</span></pre></td><td class="code"><pre><span class="line">  pFrame=av_frame_alloc();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">446</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">447</span></pre></td><td class="code"><pre><span class="line">  w_width = pCodecCtx-&gt;<span class="built_in">width</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">448</span></pre></td><td class="code"><pre><span class="line">  w_height = pCodecCtx-&gt;<span class="built_in">height</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">449</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">450</span></pre></td><td class="code"><pre><span class="line">  win = SDL_CreateWindow( <span class="string">"Media Player"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">451</span></pre></td><td class="code"><pre><span class="line">		          SDL_WINDOWPOS_UNDEFINED,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">452</span></pre></td><td class="code"><pre><span class="line">		  	  SDL_WINDOWPOS_UNDEFINED,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">453</span></pre></td><td class="code"><pre><span class="line">			  w_width, w_height,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">454</span></pre></td><td class="code"><pre><span class="line">			  SDL_WINDOW_OPENGL | SDL_WINDOW_RESIZABLE);	  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">455</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(!win)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">456</span></pre></td><td class="code"><pre><span class="line">    SDL_LogError(SDL_LOG_CATEGORY_APPLICATION, <span class="string">"Failed to create window by SDL"</span>);  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">457</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">goto</span> __FAIL;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">458</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">459</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">460</span></pre></td><td class="code"><pre><span class="line">  renderer = SDL_CreateRenderer(win, <span class="number">-1</span>, <span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">461</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(!renderer)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">462</span></pre></td><td class="code"><pre><span class="line">    SDL_LogError(SDL_LOG_CATEGORY_APPLICATION, <span class="string">"Failed to create Renderer by SDL"</span>);  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">463</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">goto</span> __FAIL;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">464</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">465</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">466</span></pre></td><td class="code"><pre><span class="line">  pixformat = SDL_PIXELFORMAT_IYUV;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">467</span></pre></td><td class="code"><pre><span class="line">  texture = SDL_CreateTexture(renderer,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">468</span></pre></td><td class="code"><pre><span class="line">		    pixformat, </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">469</span></pre></td><td class="code"><pre><span class="line">		    SDL_TEXTUREACCESS_STREAMING,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">470</span></pre></td><td class="code"><pre><span class="line">		    w_width, </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">471</span></pre></td><td class="code"><pre><span class="line">		    w_height);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">472</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">473</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// initialize SWS context for software scaling</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">474</span></pre></td><td class="code"><pre><span class="line">  sws_ctx = sws_getContext(pCodecCtx-&gt;<span class="built_in">width</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">475</span></pre></td><td class="code"><pre><span class="line">			   pCodecCtx-&gt;<span class="built_in">height</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">476</span></pre></td><td class="code"><pre><span class="line">			   pCodecCtx-&gt;pix_fmt,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">477</span></pre></td><td class="code"><pre><span class="line">			   pCodecCtx-&gt;<span class="built_in">width</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">478</span></pre></td><td class="code"><pre><span class="line">			   pCodecCtx-&gt;<span class="built_in">height</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">479</span></pre></td><td class="code"><pre><span class="line">			   AV_PIX_FMT_YUV420P,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">480</span></pre></td><td class="code"><pre><span class="line">			   SWS_BILINEAR,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">481</span></pre></td><td class="code"><pre><span class="line">			   <span class="literal">NULL</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">482</span></pre></td><td class="code"><pre><span class="line">			   <span class="literal">NULL</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">483</span></pre></td><td class="code"><pre><span class="line">			   <span class="literal">NULL</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">484</span></pre></td><td class="code"><pre><span class="line">			   );</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">485</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">486</span></pre></td><td class="code"><pre><span class="line">  pict = (AVPicture*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(AVPicture));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">487</span></pre></td><td class="code"><pre><span class="line">  avpicture_alloc(pict, </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">488</span></pre></td><td class="code"><pre><span class="line">		  AV_PIX_FMT_YUV420P, </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">489</span></pre></td><td class="code"><pre><span class="line">		  pCodecCtx-&gt;<span class="built_in">width</span>, </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">490</span></pre></td><td class="code"><pre><span class="line">		  pCodecCtx-&gt;<span class="built_in">height</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">491</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">492</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">493</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Read frames and save first five frames to disk</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">494</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">while</span>(av_read_frame(pFormatCtx, &amp;packet)&gt;=<span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">495</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// Is this a packet from the video stream?</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">496</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(packet.stream_index==videoStream) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">497</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">// Decode video frame</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">498</span></pre></td><td class="code"><pre><span class="line">      avcodec_decode_video2(pCodecCtx, pFrame, &amp;frameFinished, &amp;packet);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">499</span></pre></td><td class="code"><pre><span class="line">      </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">500</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">// Did we get a video frame?</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">501</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span>(frameFinished) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">502</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">503</span></pre></td><td class="code"><pre><span class="line">	<span class="comment">// Convert the image into YUV format that SDL uses</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">504</span></pre></td><td class="code"><pre><span class="line">	sws_scale(sws_ctx, (<span class="keyword">uint8_t</span> <span class="keyword">const</span> * <span class="keyword">const</span> *)pFrame-&gt;data,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">505</span></pre></td><td class="code"><pre><span class="line">		  pFrame-&gt;linesize, <span class="number">0</span>, pCodecCtx-&gt;<span class="built_in">height</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">506</span></pre></td><td class="code"><pre><span class="line">		  pict-&gt;data, pict-&gt;linesize);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">507</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">508</span></pre></td><td class="code"><pre><span class="line">	SDL_UpdateYUVTexture(texture, <span class="literal">NULL</span>, </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">509</span></pre></td><td class="code"><pre><span class="line">			     pict-&gt;data[<span class="number">0</span>], pict-&gt;linesize[<span class="number">0</span>],</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">510</span></pre></td><td class="code"><pre><span class="line">			     pict-&gt;data[<span class="number">1</span>], pict-&gt;linesize[<span class="number">1</span>],</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">511</span></pre></td><td class="code"><pre><span class="line">			     pict-&gt;data[<span class="number">2</span>], pict-&gt;linesize[<span class="number">2</span>]);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">512</span></pre></td><td class="code"><pre><span class="line">	</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">513</span></pre></td><td class="code"><pre><span class="line">	<span class="comment">// Set Size of Window</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">514</span></pre></td><td class="code"><pre><span class="line">	<span class="built_in">rect</span>.x = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">515</span></pre></td><td class="code"><pre><span class="line">	<span class="built_in">rect</span>.y = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">516</span></pre></td><td class="code"><pre><span class="line">	<span class="built_in">rect</span>.w = pCodecCtx-&gt;<span class="built_in">width</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">517</span></pre></td><td class="code"><pre><span class="line">	<span class="built_in">rect</span>.h = pCodecCtx-&gt;<span class="built_in">height</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">518</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">519</span></pre></td><td class="code"><pre><span class="line">	SDL_RenderClear(renderer);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">520</span></pre></td><td class="code"><pre><span class="line">	SDL_RenderCopy(renderer, texture, <span class="literal">NULL</span>, &amp;<span class="built_in">rect</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">521</span></pre></td><td class="code"><pre><span class="line">	SDL_RenderPresent(renderer);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">522</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">523</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">524</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">525</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">526</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// Free the packet that was allocated by av_read_frame</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">527</span></pre></td><td class="code"><pre><span class="line">    av_free_packet(&amp;packet);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">528</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">529</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/*</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">530</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    SDL_Event event;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">531</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    SDL_PollEvent(&amp;event);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">532</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    switch(event.type) &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">533</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    case SDL_QUIT:</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">534</span></pre></td><td class="code"><pre><span class="line"><span class="comment">      goto __QUIT;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">535</span></pre></td><td class="code"><pre><span class="line"><span class="comment">      break;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">536</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    default:</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">537</span></pre></td><td class="code"><pre><span class="line"><span class="comment">      break;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">538</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    &#125;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">539</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">540</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">541</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">542</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">543</span></pre></td><td class="code"><pre><span class="line">__QUIT:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">544</span></pre></td><td class="code"><pre><span class="line">  ret = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">545</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">546</span></pre></td><td class="code"><pre><span class="line">__FAIL:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">547</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Free the YUV frame</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">548</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(pFrame)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">549</span></pre></td><td class="code"><pre><span class="line">    av_frame_free(&amp;pFrame);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">550</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">551</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">552</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Close the codec</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">553</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(pCodecCtx)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">554</span></pre></td><td class="code"><pre><span class="line">    avcodec_close(pCodecCtx);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">555</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">556</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">557</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(pCodecCtxOrig)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">558</span></pre></td><td class="code"><pre><span class="line">    avcodec_close(pCodecCtxOrig);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">559</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">560</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">561</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Close the video file</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">562</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(pFormatCtx)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">563</span></pre></td><td class="code"><pre><span class="line">    avformat_close_input(&amp;pFormatCtx);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">564</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">565</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">566</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(pict)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">567</span></pre></td><td class="code"><pre><span class="line">    avpicture_free(pict);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">568</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">free</span>(pict);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">569</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">570</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">571</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(win)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">572</span></pre></td><td class="code"><pre><span class="line">    SDL_DestroyWindow(win);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">573</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">574</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">575</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(renderer)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">576</span></pre></td><td class="code"><pre><span class="line">    SDL_DestroyRenderer(renderer);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">577</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">578</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">579</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(texture)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">580</span></pre></td><td class="code"><pre><span class="line">    SDL_DestroyTexture(texture);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">581</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">582</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">583</span></pre></td><td class="code"><pre><span class="line">  SDL_Quit();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">584</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">585</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> ret;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">586</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure></li>
</ul>
</li>
<li>执行：clang -g -o player2va player2va.c <code>pkg-config --cflags --libs sdl2 libavutil libavformat libavcodec libswscale</code></li>
</ul>
<h4 id="49-实现一个最简单的播放器（支持视频和音频）"><a href="#49-实现一个最简单的播放器（支持视频和音频）" class="headerlink" title="49.实现一个最简单的播放器（支持视频和音频）"></a>49.实现一个最简单的播放器（支持视频和音频）</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;SDL.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavcodec/avcodec.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavformat/avformat.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libswscale/swscale.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libswresample/swresample.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// compatibility with newer API</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> LIBAVCODEC_VERSION_INT &lt; AV_VERSION_INT(55,28,1)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> av_frame_alloc avcodec_alloc_frame</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> av_frame_free avcodec_free_frame</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SDL_AUDIO_BUFFER_SIZE 1024</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_AUDIO_FRAME_SIZE 192000</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SwrContext</span> *<span class="title">audio_convert_ctx</span> = <span class="title">NULL</span>;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">PacketQueue</span> &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">  AVPacketList *first_pkt, *last_pkt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> nb_packets;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> <span class="built_in">size</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">  SDL_mutex *mutex;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">  SDL_cond *cond;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">&#125; PacketQueue;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">PacketQueue audioq;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> quit = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">packet_queue_init</span><span class="params">(PacketQueue *q)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">memset</span>(q, <span class="number">0</span>, <span class="keyword">sizeof</span>(PacketQueue));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">  q-&gt;mutex = SDL_CreateMutex();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">  q-&gt;cond = SDL_CreateCond();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">packet_queue_put</span><span class="params">(PacketQueue *q, AVPacket *pkt)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">  AVPacketList *pkt1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(av_dup_packet(pkt) &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">  pkt1 = av_malloc(<span class="keyword">sizeof</span>(AVPacketList));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span> (!pkt1)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line">  pkt1-&gt;pkt = *pkt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line">  pkt1-&gt;next = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">51</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">52</span></pre></td><td class="code"><pre><span class="line">  SDL_LockMutex(q-&gt;mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">53</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">54</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span> (!q-&gt;last_pkt) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">55</span></pre></td><td class="code"><pre><span class="line">    q-&gt;first_pkt = pkt1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">56</span></pre></td><td class="code"><pre><span class="line">  &#125;<span class="keyword">else</span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">57</span></pre></td><td class="code"><pre><span class="line">    q-&gt;last_pkt-&gt;next = pkt1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">58</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">59</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">60</span></pre></td><td class="code"><pre><span class="line">  q-&gt;last_pkt = pkt1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">61</span></pre></td><td class="code"><pre><span class="line">  q-&gt;nb_packets++;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">62</span></pre></td><td class="code"><pre><span class="line">  q-&gt;<span class="built_in">size</span> += pkt1-&gt;pkt.<span class="built_in">size</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">63</span></pre></td><td class="code"><pre><span class="line">  SDL_CondSignal(q-&gt;cond);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">64</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">65</span></pre></td><td class="code"><pre><span class="line">  SDL_UnlockMutex(q-&gt;mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">66</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">67</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">68</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">69</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">packet_queue_get</span><span class="params">(PacketQueue *q, AVPacket *pkt, <span class="keyword">int</span> block)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">70</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">71</span></pre></td><td class="code"><pre><span class="line">  AVPacketList *pkt1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">72</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> ret;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">73</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">74</span></pre></td><td class="code"><pre><span class="line">  SDL_LockMutex(q-&gt;mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">75</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">76</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span>(;;) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">77</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">78</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(quit) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">79</span></pre></td><td class="code"><pre><span class="line">      ret = <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">80</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">81</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">82</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">83</span></pre></td><td class="code"><pre><span class="line">    pkt1 = q-&gt;first_pkt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">84</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (pkt1) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">85</span></pre></td><td class="code"><pre><span class="line">      q-&gt;first_pkt = pkt1-&gt;next;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">86</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span> (!q-&gt;first_pkt)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">87</span></pre></td><td class="code"><pre><span class="line">	q-&gt;last_pkt = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">88</span></pre></td><td class="code"><pre><span class="line">      q-&gt;nb_packets--;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">89</span></pre></td><td class="code"><pre><span class="line">      q-&gt;<span class="built_in">size</span> -= pkt1-&gt;pkt.<span class="built_in">size</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">90</span></pre></td><td class="code"><pre><span class="line">      *pkt = pkt1-&gt;pkt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">91</span></pre></td><td class="code"><pre><span class="line">      av_free(pkt1);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">92</span></pre></td><td class="code"><pre><span class="line">      ret = <span class="number">1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">93</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">94</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!block) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">95</span></pre></td><td class="code"><pre><span class="line">      ret = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">96</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">97</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">98</span></pre></td><td class="code"><pre><span class="line">      SDL_CondWait(q-&gt;cond, q-&gt;mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">99</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">100</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">101</span></pre></td><td class="code"><pre><span class="line">  SDL_UnlockMutex(q-&gt;mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">102</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> ret;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">103</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">104</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">105</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">audio_decode_frame</span><span class="params">(AVCodecContext *aCodecCtx, <span class="keyword">uint8_t</span> *audio_buf, <span class="keyword">int</span> buf_size)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">106</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">107</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">static</span> AVPacket pkt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">108</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">static</span> <span class="keyword">uint8_t</span> *audio_pkt_data = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">109</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">static</span> <span class="keyword">int</span> audio_pkt_size = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">110</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">static</span> AVFrame frame;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">111</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">112</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> len1, data_size = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">113</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">114</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span>(;;) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">115</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">while</span>(audio_pkt_size &gt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">116</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">int</span> got_frame = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">117</span></pre></td><td class="code"><pre><span class="line">      len1 = avcodec_decode_audio4(aCodecCtx, &amp;frame, &amp;got_frame, &amp;pkt);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">118</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span>(len1 &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">119</span></pre></td><td class="code"><pre><span class="line">	<span class="comment">/* if error, skip frame */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">120</span></pre></td><td class="code"><pre><span class="line">	audio_pkt_size = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">121</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">122</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">123</span></pre></td><td class="code"><pre><span class="line">      audio_pkt_data += len1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">124</span></pre></td><td class="code"><pre><span class="line">      audio_pkt_size -= len1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">125</span></pre></td><td class="code"><pre><span class="line">      data_size = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">126</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span>(got_frame) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">127</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">//fprintf(stderr, "channels:%d, nb_samples:%d, sample_fmt:%d \n", aCodecCtx-&gt;channels, frame.nb_samples, aCodecCtx-&gt;sample_fmt);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">128</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">/*</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">129</span></pre></td><td class="code"><pre><span class="line"><span class="comment">	data_size = av_samples_get_buffer_size(NULL, </span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">130</span></pre></td><td class="code"><pre><span class="line"><span class="comment">					       aCodecCtx-&gt;channels,</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">131</span></pre></td><td class="code"><pre><span class="line"><span class="comment">					       frame.nb_samples,</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">132</span></pre></td><td class="code"><pre><span class="line"><span class="comment">					       aCodecCtx-&gt;sample_fmt,</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">133</span></pre></td><td class="code"><pre><span class="line"><span class="comment">					       1);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">134</span></pre></td><td class="code"><pre><span class="line"><span class="comment">        */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">135</span></pre></td><td class="code"><pre><span class="line">	data_size = <span class="number">2</span> * <span class="number">2</span> * frame.nb_samples;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">136</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">137</span></pre></td><td class="code"><pre><span class="line">	assert(data_size &lt;= buf_size);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">138</span></pre></td><td class="code"><pre><span class="line">	swr_convert(audio_convert_ctx,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">139</span></pre></td><td class="code"><pre><span class="line">		    &amp;audio_buf,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">140</span></pre></td><td class="code"><pre><span class="line">		    MAX_AUDIO_FRAME_SIZE*<span class="number">3</span>/<span class="number">2</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">141</span></pre></td><td class="code"><pre><span class="line">		    (<span class="keyword">const</span> <span class="keyword">uint8_t</span> **)frame.data,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">142</span></pre></td><td class="code"><pre><span class="line">		    frame.nb_samples);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">143</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">144</span></pre></td><td class="code"><pre><span class="line">	<span class="comment">//memcpy(audio_buf, frame.data[0], data_size);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">145</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">146</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span>(data_size &lt;= <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">147</span></pre></td><td class="code"><pre><span class="line">	<span class="comment">/* No data yet, get more frames */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">148</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">continue</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">149</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">150</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">/* We have data, return it and come back for more later */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">151</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">return</span> data_size;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">152</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">153</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(pkt.data)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">154</span></pre></td><td class="code"><pre><span class="line">      av_free_packet(&amp;pkt);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">155</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">156</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(quit) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">157</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">158</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">159</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">160</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(packet_queue_get(&amp;audioq, &amp;pkt, <span class="number">1</span>) &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">161</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">162</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">163</span></pre></td><td class="code"><pre><span class="line">    audio_pkt_data = pkt.data;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">164</span></pre></td><td class="code"><pre><span class="line">    audio_pkt_size = pkt.<span class="built_in">size</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">165</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">166</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">167</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">168</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">audio_callback</span><span class="params">(<span class="keyword">void</span> *userdata, Uint8 *stream, <span class="keyword">int</span> len)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">169</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">170</span></pre></td><td class="code"><pre><span class="line">  AVCodecContext *aCodecCtx = (AVCodecContext *)userdata;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">171</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> len1, audio_size;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">172</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">173</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">static</span> <span class="keyword">uint8_t</span> audio_buf[(MAX_AUDIO_FRAME_SIZE * <span class="number">3</span>) / <span class="number">2</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">174</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> audio_buf_size = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">175</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> audio_buf_index = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">176</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">177</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">while</span>(len &gt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">178</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(audio_buf_index &gt;= audio_buf_size) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">179</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">/* We have already sent all our data; get more */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">180</span></pre></td><td class="code"><pre><span class="line">      audio_size = audio_decode_frame(aCodecCtx, audio_buf, <span class="keyword">sizeof</span>(audio_buf));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">181</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span>(audio_size &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">182</span></pre></td><td class="code"><pre><span class="line">	<span class="comment">/* If error, output silence */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">183</span></pre></td><td class="code"><pre><span class="line">	audio_buf_size = <span class="number">1024</span>; <span class="comment">// arbitrary?</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">184</span></pre></td><td class="code"><pre><span class="line">	<span class="built_in">memset</span>(audio_buf, <span class="number">0</span>, audio_buf_size);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">185</span></pre></td><td class="code"><pre><span class="line">      &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">186</span></pre></td><td class="code"><pre><span class="line">	audio_buf_size = audio_size;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">187</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">188</span></pre></td><td class="code"><pre><span class="line">      audio_buf_index = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">189</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">190</span></pre></td><td class="code"><pre><span class="line">    len1 = audio_buf_size - audio_buf_index;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">191</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(len1 &gt; len)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">192</span></pre></td><td class="code"><pre><span class="line">      len1 = len;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">193</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"index=%d, len1=%d, len=%d\n"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">194</span></pre></td><td class="code"><pre><span class="line">		    audio_buf_index,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">195</span></pre></td><td class="code"><pre><span class="line">		    len,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">196</span></pre></td><td class="code"><pre><span class="line">                    len1);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">197</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">memcpy</span>(stream, (<span class="keyword">uint8_t</span> *)audio_buf + audio_buf_index, len1);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">198</span></pre></td><td class="code"><pre><span class="line">    len -= len1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">199</span></pre></td><td class="code"><pre><span class="line">    stream += len1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">200</span></pre></td><td class="code"><pre><span class="line">    audio_buf_index += len1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">201</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">202</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">203</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">204</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">205</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">206</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span>  		  ret = <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">207</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span>             i, videoStream, audioStream;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">208</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">209</span></pre></td><td class="code"><pre><span class="line">  AVFormatContext *pFormatCtx = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">210</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">211</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">//for video decode</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">212</span></pre></td><td class="code"><pre><span class="line">  AVCodecContext  *pCodecCtxOrig = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">213</span></pre></td><td class="code"><pre><span class="line">  AVCodecContext  *pCodecCtx = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">214</span></pre></td><td class="code"><pre><span class="line">  AVCodec         *pCodec = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">215</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">216</span></pre></td><td class="code"><pre><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">SwsContext</span> *<span class="title">sws_ctx</span> = <span class="title">NULL</span>;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">217</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">218</span></pre></td><td class="code"><pre><span class="line">  AVPicture	  *pict = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">219</span></pre></td><td class="code"><pre><span class="line">  AVFrame         *pFrame = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">220</span></pre></td><td class="code"><pre><span class="line">  AVPacket        packet;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">221</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span>             frameFinished;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">222</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">223</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">//for audio decode</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">224</span></pre></td><td class="code"><pre><span class="line">  AVCodecContext  *aCodecCtxOrig = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">225</span></pre></td><td class="code"><pre><span class="line">  AVCodecContext  *aCodecCtx = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">226</span></pre></td><td class="code"><pre><span class="line">  AVCodec         *aCodec = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">227</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">228</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">229</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int64_t</span> in_channel_layout;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">230</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int64_t</span> out_channel_layout;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">231</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">232</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">//for video render</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">233</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span>		  w_width = <span class="number">640</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">234</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> 		  w_height = <span class="number">480</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">235</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">236</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span>             pixformat;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">237</span></pre></td><td class="code"><pre><span class="line">  SDL_Rect        <span class="built_in">rect</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">238</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">239</span></pre></td><td class="code"><pre><span class="line">  SDL_Window      *win;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">240</span></pre></td><td class="code"><pre><span class="line">  SDL_Renderer    *renderer;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">241</span></pre></td><td class="code"><pre><span class="line">  SDL_Texture     *texture;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">242</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">243</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">//for event</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">244</span></pre></td><td class="code"><pre><span class="line">  SDL_Event       event;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">245</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">246</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">//for audio</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">247</span></pre></td><td class="code"><pre><span class="line">  SDL_AudioSpec   wanted_spec, spec;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">248</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">249</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(argc &lt; <span class="number">2</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">250</span></pre></td><td class="code"><pre><span class="line">    SDL_LogError(SDL_LOG_CATEGORY_APPLICATION, <span class="string">"Usage: command &lt;file&gt;"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">251</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> ret;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">252</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">253</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">254</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Register all formats and codecs</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">255</span></pre></td><td class="code"><pre><span class="line">  av_register_all();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">256</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">257</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(SDL_Init(SDL_INIT_VIDEO | SDL_INIT_AUDIO | SDL_INIT_TIMER)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">258</span></pre></td><td class="code"><pre><span class="line">    SDL_LogError(SDL_LOG_CATEGORY_APPLICATION, <span class="string">"Could not initialize SDL - %s\n"</span>, SDL_GetError());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">259</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> ret;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">260</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">261</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">262</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Open video file</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">263</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(avformat_open_input(&amp;pFormatCtx, argv[<span class="number">1</span>], <span class="literal">NULL</span>, <span class="literal">NULL</span>)!=<span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">264</span></pre></td><td class="code"><pre><span class="line">    SDL_LogError(SDL_LOG_CATEGORY_APPLICATION, <span class="string">"Failed to open multi-media file"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">265</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">goto</span> __FAIL; <span class="comment">// Couldn't open file</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">266</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">267</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">268</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Retrieve stream information</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">269</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(avformat_find_stream_info(pFormatCtx, <span class="literal">NULL</span>)&lt;<span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">270</span></pre></td><td class="code"><pre><span class="line">    SDL_LogError(SDL_LOG_CATEGORY_APPLICATION, <span class="string">"Couldn't find stream information "</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">271</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">goto</span> __FAIL;  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">272</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">273</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">274</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Dump information about file onto standard error</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">275</span></pre></td><td class="code"><pre><span class="line">  av_dump_format(pFormatCtx, <span class="number">0</span>, argv[<span class="number">1</span>], <span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">276</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">277</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Find the first video stream</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">278</span></pre></td><td class="code"><pre><span class="line">  videoStream=<span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">279</span></pre></td><td class="code"><pre><span class="line">  audioStream=<span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">280</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">281</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;pFormatCtx-&gt;nb_streams; i++) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">282</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(pFormatCtx-&gt;streams[i]-&gt;codec-&gt;codec_type==AVMEDIA_TYPE_VIDEO &amp;&amp;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">283</span></pre></td><td class="code"><pre><span class="line">       videoStream &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">284</span></pre></td><td class="code"><pre><span class="line">      videoStream=i;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">285</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">286</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(pFormatCtx-&gt;streams[i]-&gt;codec-&gt;codec_type==AVMEDIA_TYPE_AUDIO &amp;&amp;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">287</span></pre></td><td class="code"><pre><span class="line">       audioStream &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">288</span></pre></td><td class="code"><pre><span class="line">      audioStream=i;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">289</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">290</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">291</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">292</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(videoStream==<span class="number">-1</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">293</span></pre></td><td class="code"><pre><span class="line">    SDL_LogError(SDL_LOG_CATEGORY_APPLICATION, <span class="string">" Didn't find a video stream "</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">294</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">goto</span> __FAIL; <span class="comment">// Didn't find a video stream</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">295</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">296</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">297</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(audioStream==<span class="number">-1</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">298</span></pre></td><td class="code"><pre><span class="line">    SDL_LogError(SDL_LOG_CATEGORY_APPLICATION, <span class="string">" Didn't find a audio stream "</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">299</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">goto</span> __FAIL; <span class="comment">// Didn't find a video stream</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">300</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">301</span></pre></td><td class="code"><pre><span class="line">   </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">302</span></pre></td><td class="code"><pre><span class="line">  aCodecCtxOrig=pFormatCtx-&gt;streams[audioStream]-&gt;codec;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">303</span></pre></td><td class="code"><pre><span class="line">  aCodec = avcodec_find_decoder(aCodecCtxOrig-&gt;codec_id);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">304</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(!aCodec) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">305</span></pre></td><td class="code"><pre><span class="line">    SDL_LogError(SDL_LOG_CATEGORY_APPLICATION, <span class="string">"Unsupported codec! "</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">306</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">goto</span> __FAIL; <span class="comment">// Didn't find a video stream</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">307</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">308</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">309</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Copy context</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">310</span></pre></td><td class="code"><pre><span class="line">  aCodecCtx = avcodec_alloc_context3(aCodec);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">311</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(avcodec_copy_context(aCodecCtx, aCodecCtxOrig) != <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">312</span></pre></td><td class="code"><pre><span class="line">    SDL_LogError(SDL_LOG_CATEGORY_APPLICATION, <span class="string">"Couldn't copy codec context! "</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">313</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">goto</span> __FAIL; <span class="comment">// Didn't find a video stream</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">314</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">315</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">316</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Set audio settings from codec info</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">317</span></pre></td><td class="code"><pre><span class="line">  wanted_spec.freq = aCodecCtx-&gt;sample_rate;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">318</span></pre></td><td class="code"><pre><span class="line">  wanted_spec.format = AUDIO_S16SYS;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">319</span></pre></td><td class="code"><pre><span class="line">  wanted_spec.channels = aCodecCtx-&gt;channels;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">320</span></pre></td><td class="code"><pre><span class="line">  wanted_spec.silence = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">321</span></pre></td><td class="code"><pre><span class="line">  wanted_spec.samples = SDL_AUDIO_BUFFER_SIZE;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">322</span></pre></td><td class="code"><pre><span class="line">  wanted_spec.callback = audio_callback;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">323</span></pre></td><td class="code"><pre><span class="line">  wanted_spec.userdata = aCodecCtx;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">324</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">325</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(SDL_OpenAudio(&amp;wanted_spec, &amp;spec) &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">326</span></pre></td><td class="code"><pre><span class="line">    SDL_LogError(SDL_LOG_CATEGORY_APPLICATION, <span class="string">"Failed to open audio device - %s!"</span>, SDL_GetError());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">327</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">goto</span> __FAIL;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">328</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">329</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">330</span></pre></td><td class="code"><pre><span class="line">  avcodec_open2(aCodecCtx, aCodec, <span class="literal">NULL</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">331</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">332</span></pre></td><td class="code"><pre><span class="line">  packet_queue_init(&amp;audioq);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">333</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">334</span></pre></td><td class="code"><pre><span class="line">  in_channel_layout = av_get_default_channel_layout(aCodecCtx-&gt;channels);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">335</span></pre></td><td class="code"><pre><span class="line">  out_channel_layout = in_channel_layout; <span class="comment">//AV_CH_LAYOUT_STEREO;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">336</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"in layout:%lld, out layout:%lld \n"</span>, in_channel_layout, out_channel_layout);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">337</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">338</span></pre></td><td class="code"><pre><span class="line">  audio_convert_ctx = swr_alloc();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">339</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(audio_convert_ctx)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">340</span></pre></td><td class="code"><pre><span class="line">    swr_alloc_set_opts(audio_convert_ctx,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">341</span></pre></td><td class="code"><pre><span class="line">		       out_channel_layout,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">342</span></pre></td><td class="code"><pre><span class="line">		       AV_SAMPLE_FMT_S16,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">343</span></pre></td><td class="code"><pre><span class="line">		       aCodecCtx-&gt;sample_rate,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">344</span></pre></td><td class="code"><pre><span class="line">		       in_channel_layout,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">345</span></pre></td><td class="code"><pre><span class="line">		       aCodecCtx-&gt;sample_fmt,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">346</span></pre></td><td class="code"><pre><span class="line">		       aCodecCtx-&gt;sample_rate,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">347</span></pre></td><td class="code"><pre><span class="line">		       <span class="number">0</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">348</span></pre></td><td class="code"><pre><span class="line">		       <span class="literal">NULL</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">349</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">350</span></pre></td><td class="code"><pre><span class="line">  swr_init(audio_convert_ctx);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">351</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">352</span></pre></td><td class="code"><pre><span class="line">  SDL_PauseAudio(<span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">353</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">354</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Get a pointer to the codec context for the video stream</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">355</span></pre></td><td class="code"><pre><span class="line">  pCodecCtxOrig=pFormatCtx-&gt;streams[videoStream]-&gt;codec;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">356</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">357</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Find the decoder for the video stream</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">358</span></pre></td><td class="code"><pre><span class="line">  pCodec=avcodec_find_decoder(pCodecCtxOrig-&gt;codec_id);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">359</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(pCodec==<span class="literal">NULL</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">360</span></pre></td><td class="code"><pre><span class="line">    SDL_LogError(SDL_LOG_CATEGORY_APPLICATION, <span class="string">"Unsupported codec!"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">361</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">goto</span> __FAIL;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">362</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">363</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">364</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Copy context</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">365</span></pre></td><td class="code"><pre><span class="line">  pCodecCtx = avcodec_alloc_context3(pCodec);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">366</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(avcodec_copy_context(pCodecCtx, pCodecCtxOrig) != <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">367</span></pre></td><td class="code"><pre><span class="line">    SDL_LogError(SDL_LOG_CATEGORY_APPLICATION, <span class="string">"Failed to copy context of codec!"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">368</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">goto</span> __FAIL;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">369</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">370</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">371</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Open codec</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">372</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(avcodec_open2(pCodecCtx, pCodec, <span class="literal">NULL</span>)&lt;<span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">373</span></pre></td><td class="code"><pre><span class="line">    SDL_LogError(SDL_LOG_CATEGORY_APPLICATION, <span class="string">"Failed to open audio decoder!"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">374</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">goto</span> __FAIL;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">375</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">376</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">377</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Allocate video frame</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">378</span></pre></td><td class="code"><pre><span class="line">  pFrame=av_frame_alloc();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">379</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">380</span></pre></td><td class="code"><pre><span class="line">  w_width = pCodecCtx-&gt;<span class="built_in">width</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">381</span></pre></td><td class="code"><pre><span class="line">  w_height = pCodecCtx-&gt;<span class="built_in">height</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">382</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">383</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"width:%d, height:%d\n"</span>, w_width, w_height);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">384</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">385</span></pre></td><td class="code"><pre><span class="line">  win = SDL_CreateWindow(<span class="string">"Media Player"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">386</span></pre></td><td class="code"><pre><span class="line">			 SDL_WINDOWPOS_UNDEFINED,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">387</span></pre></td><td class="code"><pre><span class="line">			 SDL_WINDOWPOS_UNDEFINED,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">388</span></pre></td><td class="code"><pre><span class="line">			 w_width, w_height,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">389</span></pre></td><td class="code"><pre><span class="line">			 SDL_WINDOW_OPENGL | SDL_WINDOW_RESIZABLE);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">390</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(!win)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">391</span></pre></td><td class="code"><pre><span class="line">    SDL_LogError(SDL_LOG_CATEGORY_APPLICATION, <span class="string">"Failed to create window!"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">392</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">goto</span> __FAIL;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">393</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">394</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">395</span></pre></td><td class="code"><pre><span class="line">  renderer = SDL_CreateRenderer(win, <span class="number">-1</span>, <span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">396</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(!renderer)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">397</span></pre></td><td class="code"><pre><span class="line">    SDL_LogError(SDL_LOG_CATEGORY_APPLICATION, <span class="string">"Failed to create renderer!"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">398</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">goto</span> __FAIL;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">399</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">400</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">401</span></pre></td><td class="code"><pre><span class="line">  pixformat = SDL_PIXELFORMAT_IYUV;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">402</span></pre></td><td class="code"><pre><span class="line">  texture = SDL_CreateTexture(renderer, </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">403</span></pre></td><td class="code"><pre><span class="line">                              pixformat,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">404</span></pre></td><td class="code"><pre><span class="line">  			      SDL_TEXTUREACCESS_STREAMING,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">405</span></pre></td><td class="code"><pre><span class="line">			      w_width,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">406</span></pre></td><td class="code"><pre><span class="line">			      w_height);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">407</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(!texture)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">408</span></pre></td><td class="code"><pre><span class="line">    SDL_LogError(SDL_LOG_CATEGORY_APPLICATION, <span class="string">"Failed to create Texture!"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">409</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">goto</span> __FAIL;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">410</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">411</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">412</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// initialize SWS context for software scaling</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">413</span></pre></td><td class="code"><pre><span class="line">  sws_ctx = sws_getContext(pCodecCtx-&gt;<span class="built_in">width</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">414</span></pre></td><td class="code"><pre><span class="line">			   pCodecCtx-&gt;<span class="built_in">height</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">415</span></pre></td><td class="code"><pre><span class="line">			   pCodecCtx-&gt;pix_fmt,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">416</span></pre></td><td class="code"><pre><span class="line">			   pCodecCtx-&gt;<span class="built_in">width</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">417</span></pre></td><td class="code"><pre><span class="line">			   pCodecCtx-&gt;<span class="built_in">height</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">418</span></pre></td><td class="code"><pre><span class="line">			   AV_PIX_FMT_YUV420P,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">419</span></pre></td><td class="code"><pre><span class="line">			   SWS_BILINEAR,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">420</span></pre></td><td class="code"><pre><span class="line">			   <span class="literal">NULL</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">421</span></pre></td><td class="code"><pre><span class="line">			   <span class="literal">NULL</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">422</span></pre></td><td class="code"><pre><span class="line">			   <span class="literal">NULL</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">423</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">424</span></pre></td><td class="code"><pre><span class="line">  pict = (AVPicture*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(AVPicture));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">425</span></pre></td><td class="code"><pre><span class="line">  avpicture_alloc(pict,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">426</span></pre></td><td class="code"><pre><span class="line">                  AV_PIX_FMT_YUV420P,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">427</span></pre></td><td class="code"><pre><span class="line">                  pCodecCtx-&gt;<span class="built_in">width</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">428</span></pre></td><td class="code"><pre><span class="line">                  pCodecCtx-&gt;<span class="built_in">height</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">429</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">430</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Read frames and save first five frames to disk</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">431</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">while</span>(av_read_frame(pFormatCtx, &amp;packet)&gt;=<span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">432</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// Is this a packet from the video stream?</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">433</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(packet.stream_index==videoStream) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">434</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">// Decode video frame</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">435</span></pre></td><td class="code"><pre><span class="line">      avcodec_decode_video2(pCodecCtx, pFrame, &amp;frameFinished, &amp;packet);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">436</span></pre></td><td class="code"><pre><span class="line">      </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">437</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">// Did we get a video frame?</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">438</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span>(frameFinished) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">439</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">440</span></pre></td><td class="code"><pre><span class="line">	<span class="comment">// Convert the image into YUV format that SDL uses	</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">441</span></pre></td><td class="code"><pre><span class="line">	sws_scale(sws_ctx, (<span class="keyword">uint8_t</span> <span class="keyword">const</span> * <span class="keyword">const</span> *)pFrame-&gt;data,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">442</span></pre></td><td class="code"><pre><span class="line">		  pFrame-&gt;linesize, <span class="number">0</span>, pCodecCtx-&gt;<span class="built_in">height</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">443</span></pre></td><td class="code"><pre><span class="line">		  pict-&gt;data, pict-&gt;linesize);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">444</span></pre></td><td class="code"><pre><span class="line">	</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">445</span></pre></td><td class="code"><pre><span class="line">	SDL_UpdateYUVTexture(texture, <span class="literal">NULL</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">446</span></pre></td><td class="code"><pre><span class="line">                             pict-&gt;data[<span class="number">0</span>], pict-&gt;linesize[<span class="number">0</span>],</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">447</span></pre></td><td class="code"><pre><span class="line">			     pict-&gt;data[<span class="number">1</span>], pict-&gt;linesize[<span class="number">1</span>],</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">448</span></pre></td><td class="code"><pre><span class="line">			     pict-&gt;data[<span class="number">2</span>], pict-&gt;linesize[<span class="number">2</span>]);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">449</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">450</span></pre></td><td class="code"><pre><span class="line">	<span class="built_in">rect</span>.x = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">451</span></pre></td><td class="code"><pre><span class="line">	<span class="built_in">rect</span>.y = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">452</span></pre></td><td class="code"><pre><span class="line">	<span class="built_in">rect</span>.w = pCodecCtx-&gt;<span class="built_in">width</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">453</span></pre></td><td class="code"><pre><span class="line">	<span class="built_in">rect</span>.h = pCodecCtx-&gt;<span class="built_in">height</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">454</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">455</span></pre></td><td class="code"><pre><span class="line">	SDL_RenderClear(renderer);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">456</span></pre></td><td class="code"><pre><span class="line">	SDL_RenderCopy(renderer, texture, <span class="literal">NULL</span>, &amp;<span class="built_in">rect</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">457</span></pre></td><td class="code"><pre><span class="line">	SDL_RenderPresent(renderer);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">458</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">459</span></pre></td><td class="code"><pre><span class="line">	av_free_packet(&amp;packet);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">460</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">461</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(packet.stream_index==audioStream) &#123; <span class="comment">//for audio</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">462</span></pre></td><td class="code"><pre><span class="line">      packet_queue_put(&amp;audioq, &amp;packet);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">463</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">464</span></pre></td><td class="code"><pre><span class="line">      av_free_packet(&amp;packet);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">465</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">466</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">467</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// Free the packet that was allocated by av_read_frame</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">468</span></pre></td><td class="code"><pre><span class="line">    SDL_PollEvent(&amp;event);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">469</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">switch</span>(event.type) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">470</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">case</span> SDL_QUIT:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">471</span></pre></td><td class="code"><pre><span class="line">      quit = <span class="number">1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">472</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">goto</span> __QUIT; </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">473</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">474</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">default</span>:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">475</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">476</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">477</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">478</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">479</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">480</span></pre></td><td class="code"><pre><span class="line">__QUIT:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">481</span></pre></td><td class="code"><pre><span class="line">  ret = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">482</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">483</span></pre></td><td class="code"><pre><span class="line">__FAIL:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">484</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Free the YUV frame</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">485</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(pFrame)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">486</span></pre></td><td class="code"><pre><span class="line">    av_frame_free(&amp;pFrame);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">487</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">488</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">489</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Close the codecs</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">490</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(pCodecCtxOrig)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">491</span></pre></td><td class="code"><pre><span class="line">    avcodec_close(pCodecCtxOrig);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">492</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">493</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">494</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(pCodecCtx)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">495</span></pre></td><td class="code"><pre><span class="line">    avcodec_close(pCodecCtx);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">496</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">497</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">498</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(aCodecCtxOrig) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">499</span></pre></td><td class="code"><pre><span class="line">    avcodec_close(aCodecCtxOrig);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">500</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">501</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">502</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(aCodecCtx) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">503</span></pre></td><td class="code"><pre><span class="line">    avcodec_close(aCodecCtx);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">504</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">505</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">506</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Close the video file</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">507</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(pFormatCtx)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">508</span></pre></td><td class="code"><pre><span class="line">    avformat_close_input(&amp;pFormatCtx);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">509</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">510</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">511</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(pict)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">512</span></pre></td><td class="code"><pre><span class="line">    avpicture_free(pict);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">513</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">free</span>(pict);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">514</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">515</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">516</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(win)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">517</span></pre></td><td class="code"><pre><span class="line">    SDL_DestroyWindow(win);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">518</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">519</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">520</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(renderer)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">521</span></pre></td><td class="code"><pre><span class="line">    SDL_DestroyRenderer(renderer);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">522</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">523</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">524</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(texture)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">525</span></pre></td><td class="code"><pre><span class="line">    SDL_DestroyTexture(texture);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">526</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">527</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">528</span></pre></td><td class="code"><pre><span class="line">  SDL_Quit();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">529</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">530</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> ret;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">531</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">532</span></pre></td><td class="code"><pre><span class="line">``` </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">533</span></pre></td><td class="code"><pre><span class="line">- 执行：clang -g -o player2va player2va.c `pkg-<span class="built_in">config</span> --cflags --libs sdl2 libavutil libavformat libavcodec libswscale libswrsample`</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">534</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">535</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">536</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">537</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">538</span></pre></td><td class="code"><pre><span class="line">#### <span class="number">50.</span>多线程与锁</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">539</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">540</span></pre></td><td class="code"><pre><span class="line">- 多线程的好处</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">541</span></pre></td><td class="code"><pre><span class="line">    - 充分利用CPU资源【管理】 </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">542</span></pre></td><td class="code"><pre><span class="line">- 线程的互斥与同步</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">543</span></pre></td><td class="code"><pre><span class="line">    - 互斥（抢锁的钥匙）</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">544</span></pre></td><td class="code"><pre><span class="line">    - 同步（信号机制）</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">545</span></pre></td><td class="code"><pre><span class="line">- 锁与信号量</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">546</span></pre></td><td class="code"><pre><span class="line">    - 锁的种类</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">547</span></pre></td><td class="code"><pre><span class="line">        - <span class="number">1.</span> 读写锁</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">548</span></pre></td><td class="code"><pre><span class="line">        - <span class="number">2.</span> 自旋锁（等待，要短时间）</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">549</span></pre></td><td class="code"><pre><span class="line">        - <span class="number">3.</span> 可重入锁</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">550</span></pre></td><td class="code"><pre><span class="line">    - 通过信号进行同步</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">551</span></pre></td><td class="code"><pre><span class="line">- SDL创建/等待线程</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">552</span></pre></td><td class="code"><pre><span class="line">    - <span class="number">1.</span> SDL_CreateThread</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">553</span></pre></td><td class="code"><pre><span class="line">    - <span class="number">2.</span> SDL_WaitThread</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">554</span></pre></td><td class="code"><pre><span class="line">- SDL锁</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">555</span></pre></td><td class="code"><pre><span class="line">    - <span class="number">1.</span> SDL_CreateMutex / SDL_DestroyMutex</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">556</span></pre></td><td class="code"><pre><span class="line">    - <span class="number">2.</span> SDL_LockMutex / SDL_UnlockMutex</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">557</span></pre></td><td class="code"><pre><span class="line">- SDL条件变量（信号量）</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">558</span></pre></td><td class="code"><pre><span class="line">    - <span class="number">1.</span> SDL_CreateCond / SDL_DestroyCond</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">559</span></pre></td><td class="code"><pre><span class="line">    - <span class="number">2.</span> SDL_CondWait / SDL_CondSignal</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">560</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">561</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">562</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">563</span></pre></td><td class="code"><pre><span class="line">#### <span class="number">51.</span>锁与条件变量的使用</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">564</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">565</span></pre></td><td class="code"><pre><span class="line">```c</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">566</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FF_REFRESH_EVENT (SDL_USEREVENT)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">567</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FF_QUIT_EVENT (SDL_USEREVENT + 1)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">568</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">569</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VIDEO_PICTURE_QUEUE_SIZE 1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">570</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">571</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 队列的结构体</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">572</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">PacketQueue</span> &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">573</span></pre></td><td class="code"><pre><span class="line">  AVPacketList *first_pkt, *last_pkt; <span class="comment">// 队列的头和尾,ffmpeg提供的</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">574</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> nb_packets; <span class="comment">// 有多少个包</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">575</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> <span class="built_in">size</span>; <span class="comment">// 存储空间</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">576</span></pre></td><td class="code"><pre><span class="line">  SDL_mutex *mutex; <span class="comment">// 互斥</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">577</span></pre></td><td class="code"><pre><span class="line">  SDL_cond *cond; <span class="comment">// 同步，信号量</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">578</span></pre></td><td class="code"><pre><span class="line">&#125; PacketQueue;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">579</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">580</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">packet_queue_init</span><span class="params">(PacketQueue *q)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">581</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">memset</span>(q, <span class="number">0</span>, <span class="keyword">sizeof</span>(PacketQueue));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">582</span></pre></td><td class="code"><pre><span class="line">  q-&gt;mutex = SDL_CreateMutex();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">583</span></pre></td><td class="code"><pre><span class="line">  q-&gt;cond = SDL_CreateCond();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">584</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">585</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">586</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 入队函数</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">587</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">packet_queue_put</span><span class="params">(PacketQueue *q, AVPacket *pkt)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">588</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">589</span></pre></td><td class="code"><pre><span class="line">  AVPacketList *pkt1; <span class="comment">// 引用计数</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">590</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(av_dup_packet(pkt) &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">591</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">592</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">593</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// 分配内存空间，构造队列中的一个元素，然后将我们的元素插入</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">594</span></pre></td><td class="code"><pre><span class="line">  pkt1 = av_malloc(<span class="keyword">sizeof</span>(AVPacketList));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">595</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span> (!pkt1)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">596</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">597</span></pre></td><td class="code"><pre><span class="line">  pkt1-&gt;pkt = *pkt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">598</span></pre></td><td class="code"><pre><span class="line">  pkt1-&gt;next = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">599</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">600</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// 加锁</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">601</span></pre></td><td class="code"><pre><span class="line">  SDL_LockMutex(q-&gt;mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">602</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">603</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// 判读是不是第一个元素</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">604</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span> (!q-&gt;last_pkt)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">605</span></pre></td><td class="code"><pre><span class="line">    q-&gt;first_pkt = pkt1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">606</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">else</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">607</span></pre></td><td class="code"><pre><span class="line">    q-&gt;last_pkt-&gt;next = pkt1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">608</span></pre></td><td class="code"><pre><span class="line">  q-&gt;last_pkt = pkt1; <span class="comment">// 移动队尾指针</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">609</span></pre></td><td class="code"><pre><span class="line">  q-&gt;nb_packets++;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">610</span></pre></td><td class="code"><pre><span class="line">  q-&gt;<span class="built_in">size</span> += pkt1-&gt;pkt.<span class="built_in">size</span>; <span class="comment">// 统计包大小</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">611</span></pre></td><td class="code"><pre><span class="line">  SDL_CondSignal(q-&gt;cond); <span class="comment">// 发送信号，让等待的线程唤醒</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">612</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">613</span></pre></td><td class="code"><pre><span class="line">  SDL_UnlockMutex(q-&gt;mutex); <span class="comment">// 解锁</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">614</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">615</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">616</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">617</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// 出队函数</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">618</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">packet_queue_get</span><span class="params">(PacketQueue *q, AVPacket *pkt, <span class="keyword">int</span> block)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">619</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">620</span></pre></td><td class="code"><pre><span class="line">  AVPacketList *pkt1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">621</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> ret;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">622</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">623</span></pre></td><td class="code"><pre><span class="line">  SDL_LockMutex(q-&gt;mutex); <span class="comment">// 加锁</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">624</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">625</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span>(;;) &#123; <span class="comment">// 死循环等待</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">626</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">627</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(global_video_state-&gt;quit) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">628</span></pre></td><td class="code"><pre><span class="line">      ret = <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">629</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">630</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">631</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">632</span></pre></td><td class="code"><pre><span class="line">    pkt1 = q-&gt;first_pkt; <span class="comment">// 拿到队列头中取元素</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">633</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (pkt1) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">634</span></pre></td><td class="code"><pre><span class="line">      q-&gt;first_pkt = pkt1-&gt;next; <span class="comment">// 往后移动</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">635</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span> (!q-&gt;first_pkt) <span class="comment">// 队列为空</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">636</span></pre></td><td class="code"><pre><span class="line">	q-&gt;last_pkt = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">637</span></pre></td><td class="code"><pre><span class="line">      q-&gt;nb_packets--;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">638</span></pre></td><td class="code"><pre><span class="line">      q-&gt;<span class="built_in">size</span> -= pkt1-&gt;pkt.<span class="built_in">size</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">639</span></pre></td><td class="code"><pre><span class="line">      *pkt = pkt1-&gt;pkt; <span class="comment">// 取数据</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">640</span></pre></td><td class="code"><pre><span class="line">      av_free(pkt1); <span class="comment">// 释放资源</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">641</span></pre></td><td class="code"><pre><span class="line">      ret = <span class="number">1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">642</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">643</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!block) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">644</span></pre></td><td class="code"><pre><span class="line">      ret = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">645</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">646</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">647</span></pre></td><td class="code"><pre><span class="line">      SDL_CondWait(q-&gt;cond, q-&gt;mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">648</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">649</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">650</span></pre></td><td class="code"><pre><span class="line">  SDL_UnlockMutex(q-&gt;mutex); <span class="comment">// 解锁</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">651</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> ret;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">652</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">653</span></pre></td><td class="code"><pre><span class="line">``` </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">654</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">655</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">656</span></pre></td><td class="code"><pre><span class="line">#### <span class="number">52.</span>播放器线程模型</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">657</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">658</span></pre></td><td class="code"><pre><span class="line">- 主线程（对输入参数处理，对事件处理，对视频渲染），一般不做复杂逻辑</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">659</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">660</span></pre></td><td class="code"><pre><span class="line">```<span class="built_in">text</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">661</span></pre></td><td class="code"><pre><span class="line">                              ---------&gt;视频流队列&lt;----------</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">662</span></pre></td><td class="code"><pre><span class="line">                              ^                             |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">663</span></pre></td><td class="code"><pre><span class="line">                              |                             |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">664</span></pre></td><td class="code"><pre><span class="line">输入文件 --- [创建线程] --- 解复用 --- [创建线程] --- 视频解码线程</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">665</span></pre></td><td class="code"><pre><span class="line">                              |                             |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">666</span></pre></td><td class="code"><pre><span class="line">                              V                             |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">667</span></pre></td><td class="code"><pre><span class="line">                          音频流队列 --------------------------------------音频渲染(SDL)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">668</span></pre></td><td class="code"><pre><span class="line">                                                            |</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">669</span></pre></td><td class="code"><pre><span class="line">                                                            V</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">670</span></pre></td><td class="code"><pre><span class="line">视频渲染 --------------------------------------------&gt;解码视频队列</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">671</span></pre></td><td class="code"><pre><span class="line">```  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">672</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">673</span></pre></td><td class="code"><pre><span class="line">```c</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">674</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// tutorial04.c</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">675</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// A pedagogical video player that will stream through every video frame as fast as it can,</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">676</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// and play audio (out of sync).</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">677</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">678</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// Code based on FFplay, Copyright (c) 2003 Fabrice Bellard, </span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">679</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// and a tutorial by Martin Bohme (boehme@inb.uni-luebeckREMOVETHIS.de)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">680</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// Tested on Gentoo, CVS version 5/01/07 compiled with GCC 4.1.1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">681</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// With updates from https://github.com/chelyaev/ffmpeg-tutorial</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">682</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// Updates tested on:</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">683</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// LAVC 54.59.100, LAVF 54.29.104, LSWS 2.1.101, SDL 1.2.15</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">684</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// on GCC 4.7.2 in Debian February 2015</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">685</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// Use</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">686</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">687</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// gcc -o tutorial04 tutorial04.c -lavformat -lavcodec -lswscale -lz -lm `sdl-config --cflags --libs`</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">688</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// to build (assuming libavformat and libavcodec are correctly installed, </span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">689</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// and assuming you have sdl-config. Please refer to SDL docs for your installation.)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">690</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">691</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// Run using</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">692</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// tutorial04 myvideofile.mpg</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">693</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">694</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// to play the video stream on your screen.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">695</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">696</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">697</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">698</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">699</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">700</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;SDL.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">701</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">702</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavcodec/avcodec.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">703</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavformat/avformat.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">704</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libswscale/swscale.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">705</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libswresample/swresample.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">706</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">707</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// compatibility with newer API</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">708</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> LIBAVCODEC_VERSION_INT &lt; AV_VERSION_INT(55,28,1)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">709</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> av_frame_alloc avcodec_alloc_frame</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">710</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> av_frame_free avcodec_free_frame</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">711</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">712</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">713</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SDL_AUDIO_BUFFER_SIZE 1024</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">714</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_AUDIO_FRAME_SIZE 192000</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">715</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">716</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_AUDIOQ_SIZE (5 * 16 * 1024)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">717</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_VIDEOQ_SIZE (5 * 256 * 1024)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">718</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">719</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FF_REFRESH_EVENT (SDL_USEREVENT)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">720</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FF_QUIT_EVENT (SDL_USEREVENT + 1)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">721</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">722</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VIDEO_PICTURE_QUEUE_SIZE 1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">723</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">724</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">PacketQueue</span> &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">725</span></pre></td><td class="code"><pre><span class="line">  AVPacketList *first_pkt, *last_pkt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">726</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> nb_packets;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">727</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> <span class="built_in">size</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">728</span></pre></td><td class="code"><pre><span class="line">  SDL_mutex *mutex;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">729</span></pre></td><td class="code"><pre><span class="line">  SDL_cond *cond;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">730</span></pre></td><td class="code"><pre><span class="line">&#125; PacketQueue;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">731</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">732</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">733</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">VideoPicture</span> &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">734</span></pre></td><td class="code"><pre><span class="line">  AVPicture *pict;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">735</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> <span class="built_in">width</span>, <span class="built_in">height</span>; <span class="comment">/* source height &amp; width */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">736</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> allocated;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">737</span></pre></td><td class="code"><pre><span class="line">&#125; VideoPicture;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">738</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">739</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">VideoState</span> &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">740</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">741</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">//for multi-media file</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">742</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">char</span>            filename[<span class="number">1024</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">743</span></pre></td><td class="code"><pre><span class="line">  AVFormatContext *pFormatCtx;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">744</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">745</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span>             videoStream, audioStream;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">746</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">747</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">//for audio</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">748</span></pre></td><td class="code"><pre><span class="line">  AVStream        *audio_st;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">749</span></pre></td><td class="code"><pre><span class="line">  AVCodecContext  *audio_ctx;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">750</span></pre></td><td class="code"><pre><span class="line">  PacketQueue     audioq;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">751</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">uint8_t</span>         audio_buf[(MAX_AUDIO_FRAME_SIZE * <span class="number">3</span>) / <span class="number">2</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">752</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span>    audio_buf_size;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">753</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span>    audio_buf_index;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">754</span></pre></td><td class="code"><pre><span class="line">  AVFrame         audio_frame;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">755</span></pre></td><td class="code"><pre><span class="line">  AVPacket        audio_pkt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">756</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">uint8_t</span>         *audio_pkt_data;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">757</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span>             audio_pkt_size;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">758</span></pre></td><td class="code"><pre><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">SwrContext</span> *<span class="title">audio_swr_ctx</span>;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">759</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">760</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">//for video</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">761</span></pre></td><td class="code"><pre><span class="line">  AVStream        *video_st;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">762</span></pre></td><td class="code"><pre><span class="line">  AVCodecContext  *video_ctx;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">763</span></pre></td><td class="code"><pre><span class="line">  PacketQueue     videoq;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">764</span></pre></td><td class="code"><pre><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">SwsContext</span> *<span class="title">sws_ctx</span>;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">765</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">766</span></pre></td><td class="code"><pre><span class="line">  VideoPicture    pictq[VIDEO_PICTURE_QUEUE_SIZE];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">767</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span>             pictq_size, pictq_rindex, pictq_windex;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">768</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">769</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">//for thread</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">770</span></pre></td><td class="code"><pre><span class="line">  SDL_mutex       *pictq_mutex;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">771</span></pre></td><td class="code"><pre><span class="line">  SDL_cond        *pictq_cond;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">772</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">773</span></pre></td><td class="code"><pre><span class="line">  SDL_Thread      *parse_tid;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">774</span></pre></td><td class="code"><pre><span class="line">  SDL_Thread      *video_tid;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">775</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">776</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span>             quit;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">777</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">778</span></pre></td><td class="code"><pre><span class="line">&#125; VideoState;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">779</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">780</span></pre></td><td class="code"><pre><span class="line">SDL_mutex       *texture_mutex;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">781</span></pre></td><td class="code"><pre><span class="line">SDL_Window      *win;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">782</span></pre></td><td class="code"><pre><span class="line">SDL_Renderer    *renderer;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">783</span></pre></td><td class="code"><pre><span class="line">SDL_Texture     *texture;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">784</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">785</span></pre></td><td class="code"><pre><span class="line">FILE            *audiofd = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">786</span></pre></td><td class="code"><pre><span class="line">FILE            *audiofd1 = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">787</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">788</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Since we only have one decoding thread, the Big Struct</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">789</span></pre></td><td class="code"><pre><span class="line"><span class="comment">   can be global in case we need it. */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">790</span></pre></td><td class="code"><pre><span class="line">VideoState *global_video_state;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">791</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">792</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">packet_queue_init</span><span class="params">(PacketQueue *q)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">793</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">memset</span>(q, <span class="number">0</span>, <span class="keyword">sizeof</span>(PacketQueue));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">794</span></pre></td><td class="code"><pre><span class="line">  q-&gt;mutex = SDL_CreateMutex();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">795</span></pre></td><td class="code"><pre><span class="line">  q-&gt;cond = SDL_CreateCond();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">796</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">797</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">798</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">packet_queue_put</span><span class="params">(PacketQueue *q, AVPacket *pkt)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">799</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">800</span></pre></td><td class="code"><pre><span class="line">  AVPacketList *pkt1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">801</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(av_dup_packet(pkt) &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">802</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">803</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">804</span></pre></td><td class="code"><pre><span class="line">  pkt1 = av_malloc(<span class="keyword">sizeof</span>(AVPacketList));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">805</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span> (!pkt1)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">806</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">807</span></pre></td><td class="code"><pre><span class="line">  pkt1-&gt;pkt = *pkt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">808</span></pre></td><td class="code"><pre><span class="line">  pkt1-&gt;next = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">809</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">810</span></pre></td><td class="code"><pre><span class="line">  SDL_LockMutex(q-&gt;mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">811</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">812</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span> (!q-&gt;last_pkt)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">813</span></pre></td><td class="code"><pre><span class="line">    q-&gt;first_pkt = pkt1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">814</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">else</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">815</span></pre></td><td class="code"><pre><span class="line">    q-&gt;last_pkt-&gt;next = pkt1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">816</span></pre></td><td class="code"><pre><span class="line">  q-&gt;last_pkt = pkt1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">817</span></pre></td><td class="code"><pre><span class="line">  q-&gt;nb_packets++;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">818</span></pre></td><td class="code"><pre><span class="line">  q-&gt;<span class="built_in">size</span> += pkt1-&gt;pkt.<span class="built_in">size</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">819</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">//fprintf(stderr, "enqueue, packets:%d, send cond signal\n", q-&gt;nb_packets);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">820</span></pre></td><td class="code"><pre><span class="line">  SDL_CondSignal(q-&gt;cond);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">821</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">822</span></pre></td><td class="code"><pre><span class="line">  SDL_UnlockMutex(q-&gt;mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">823</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">824</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">825</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">826</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">packet_queue_get</span><span class="params">(PacketQueue *q, AVPacket *pkt, <span class="keyword">int</span> block)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">827</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">828</span></pre></td><td class="code"><pre><span class="line">  AVPacketList *pkt1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">829</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> ret;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">830</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">831</span></pre></td><td class="code"><pre><span class="line">  SDL_LockMutex(q-&gt;mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">832</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">833</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span>(;;) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">834</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">835</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(global_video_state-&gt;quit) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">836</span></pre></td><td class="code"><pre><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"quit from queue_get\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">837</span></pre></td><td class="code"><pre><span class="line">      ret = <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">838</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">839</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">840</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">841</span></pre></td><td class="code"><pre><span class="line">    pkt1 = q-&gt;first_pkt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">842</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (pkt1) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">843</span></pre></td><td class="code"><pre><span class="line">      q-&gt;first_pkt = pkt1-&gt;next;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">844</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span> (!q-&gt;first_pkt)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">845</span></pre></td><td class="code"><pre><span class="line">	q-&gt;last_pkt = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">846</span></pre></td><td class="code"><pre><span class="line">      q-&gt;nb_packets--;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">847</span></pre></td><td class="code"><pre><span class="line">      q-&gt;<span class="built_in">size</span> -= pkt1-&gt;pkt.<span class="built_in">size</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">848</span></pre></td><td class="code"><pre><span class="line">      *pkt = pkt1-&gt;pkt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">849</span></pre></td><td class="code"><pre><span class="line">      av_free(pkt1);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">850</span></pre></td><td class="code"><pre><span class="line">      ret = <span class="number">1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">851</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">852</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!block) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">853</span></pre></td><td class="code"><pre><span class="line">      ret = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">854</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">855</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">856</span></pre></td><td class="code"><pre><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"queue is empty, so wait a moment and wait a cond signal\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">857</span></pre></td><td class="code"><pre><span class="line">      SDL_CondWait(q-&gt;cond, q-&gt;mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">858</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">859</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">860</span></pre></td><td class="code"><pre><span class="line">  SDL_UnlockMutex(q-&gt;mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">861</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> ret;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">862</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">863</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">864</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">audio_decode_frame</span><span class="params">(VideoState *is, <span class="keyword">uint8_t</span> *audio_buf, <span class="keyword">int</span> buf_size)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">865</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">866</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> len1, data_size = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">867</span></pre></td><td class="code"><pre><span class="line">  AVPacket *pkt = &amp;is-&gt;audio_pkt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">868</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">869</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span>(;;) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">870</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">while</span>(is-&gt;audio_pkt_size &gt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">871</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">872</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">int</span> got_frame = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">873</span></pre></td><td class="code"><pre><span class="line">      len1 = avcodec_decode_audio4(is-&gt;audio_ctx, &amp;is-&gt;audio_frame, &amp;got_frame, pkt);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">874</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span>(len1 &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">875</span></pre></td><td class="code"><pre><span class="line">	<span class="comment">/* if error, skip frame */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">876</span></pre></td><td class="code"><pre><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Failed to decode audio ......\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">877</span></pre></td><td class="code"><pre><span class="line">	is-&gt;audio_pkt_size = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">878</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">879</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">880</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">881</span></pre></td><td class="code"><pre><span class="line">      data_size = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">882</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span>(got_frame) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">883</span></pre></td><td class="code"><pre><span class="line">	<span class="comment">/*</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">884</span></pre></td><td class="code"><pre><span class="line"><span class="comment">	fprintf(stderr, "auido: channels:%d, nb_samples:%d, sample_fmt:%d\n",</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">885</span></pre></td><td class="code"><pre><span class="line"><span class="comment">			is-&gt;audio_ctx-&gt;channels,</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">886</span></pre></td><td class="code"><pre><span class="line"><span class="comment">			is-&gt;audio_frame.nb_samples,</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">887</span></pre></td><td class="code"><pre><span class="line"><span class="comment">			is-&gt;audio_ctx-&gt;sample_fmt);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">888</span></pre></td><td class="code"><pre><span class="line"><span class="comment"></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">889</span></pre></td><td class="code"><pre><span class="line"><span class="comment">	data_size = av_samples_get_buffer_size(NULL, </span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">890</span></pre></td><td class="code"><pre><span class="line"><span class="comment">					       is-&gt;audio_ctx-&gt;channels,</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">891</span></pre></td><td class="code"><pre><span class="line"><span class="comment">					       is-&gt;audio_frame.nb_samples,</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">892</span></pre></td><td class="code"><pre><span class="line"><span class="comment">					       is-&gt;audio_ctx-&gt;sample_fmt,</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">893</span></pre></td><td class="code"><pre><span class="line"><span class="comment">					       1);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">894</span></pre></td><td class="code"><pre><span class="line"><span class="comment">	*/</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">895</span></pre></td><td class="code"><pre><span class="line">	data_size = <span class="number">2</span> * is-&gt;audio_frame.nb_samples * <span class="number">2</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">896</span></pre></td><td class="code"><pre><span class="line">	assert(data_size &lt;= buf_size);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">897</span></pre></td><td class="code"><pre><span class="line">	<span class="comment">//memcpy(audio_buf, is-&gt;audio_frame.data[0], data_size);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">898</span></pre></td><td class="code"><pre><span class="line">	</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">899</span></pre></td><td class="code"><pre><span class="line">	swr_convert(is-&gt;audio_swr_ctx,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">900</span></pre></td><td class="code"><pre><span class="line">                        &amp;audio_buf,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">901</span></pre></td><td class="code"><pre><span class="line">                        MAX_AUDIO_FRAME_SIZE*<span class="number">3</span>/<span class="number">2</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">902</span></pre></td><td class="code"><pre><span class="line">                        (<span class="keyword">const</span> <span class="keyword">uint8_t</span> **)is-&gt;audio_frame.data,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">903</span></pre></td><td class="code"><pre><span class="line">                        is-&gt;audio_frame.nb_samples);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">904</span></pre></td><td class="code"><pre><span class="line">	</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">905</span></pre></td><td class="code"><pre><span class="line">	</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">906</span></pre></td><td class="code"><pre><span class="line">	fwrite(audio_buf, <span class="number">1</span>, data_size, audiofd);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">907</span></pre></td><td class="code"><pre><span class="line">        fflush(audiofd);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">908</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">909</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">910</span></pre></td><td class="code"><pre><span class="line">      is-&gt;audio_pkt_data += len1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">911</span></pre></td><td class="code"><pre><span class="line">      is-&gt;audio_pkt_size -= len1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">912</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span>(data_size &lt;= <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">913</span></pre></td><td class="code"><pre><span class="line">	<span class="comment">/* No data yet, get more frames */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">914</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">continue</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">915</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">916</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">/* We have data, return it and come back for more later */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">917</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">return</span> data_size;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">918</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">919</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">920</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(pkt-&gt;data)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">921</span></pre></td><td class="code"><pre><span class="line">      av_free_packet(pkt);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">922</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">923</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(is-&gt;quit) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">924</span></pre></td><td class="code"><pre><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"will quit program......\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">925</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">926</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">927</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">928</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* next packet */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">929</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(packet_queue_get(&amp;is-&gt;audioq, pkt, <span class="number">1</span>) &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">930</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">931</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">932</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">933</span></pre></td><td class="code"><pre><span class="line">    is-&gt;audio_pkt_data = pkt-&gt;data;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">934</span></pre></td><td class="code"><pre><span class="line">    is-&gt;audio_pkt_size = pkt-&gt;<span class="built_in">size</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">935</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">936</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">937</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">938</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">audio_callback</span><span class="params">(<span class="keyword">void</span> *userdata, Uint8 *stream, <span class="keyword">int</span> len)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">939</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">940</span></pre></td><td class="code"><pre><span class="line">  VideoState *is = (VideoState *)userdata;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">941</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> len1, audio_size;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">942</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">943</span></pre></td><td class="code"><pre><span class="line">  SDL_memset(stream, <span class="number">0</span>, len);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">944</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">945</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">while</span>(len &gt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">946</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(is-&gt;audio_buf_index &gt;= is-&gt;audio_buf_size) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">947</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">/* We have already sent all our data; get more */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">948</span></pre></td><td class="code"><pre><span class="line">      audio_size = audio_decode_frame(is, is-&gt;audio_buf, <span class="keyword">sizeof</span>(is-&gt;audio_buf));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">949</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span>(audio_size &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">950</span></pre></td><td class="code"><pre><span class="line">	<span class="comment">/* If error, output silence */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">951</span></pre></td><td class="code"><pre><span class="line">	is-&gt;audio_buf_size = <span class="number">1024</span>*<span class="number">2</span>*<span class="number">2</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">952</span></pre></td><td class="code"><pre><span class="line">	<span class="built_in">memset</span>(is-&gt;audio_buf, <span class="number">0</span>, is-&gt;audio_buf_size);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">953</span></pre></td><td class="code"><pre><span class="line">      &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">954</span></pre></td><td class="code"><pre><span class="line">	is-&gt;audio_buf_size = audio_size;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">955</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">956</span></pre></td><td class="code"><pre><span class="line">      is-&gt;audio_buf_index = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">957</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">958</span></pre></td><td class="code"><pre><span class="line">    len1 = is-&gt;audio_buf_size - is-&gt;audio_buf_index;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">959</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"stream addr:%p, audio_buf_index:%d, len1:%d, len:%d\n"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">960</span></pre></td><td class="code"><pre><span class="line">		    stream,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">961</span></pre></td><td class="code"><pre><span class="line">	  	    is-&gt;audio_buf_index, </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">962</span></pre></td><td class="code"><pre><span class="line">		    len1, </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">963</span></pre></td><td class="code"><pre><span class="line">		    len);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">964</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(len1 &gt; len)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">965</span></pre></td><td class="code"><pre><span class="line">      len1 = len;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">966</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//memcpy(stream, (uint8_t *)is-&gt;audio_buf + is-&gt;audio_buf_index, len1);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">967</span></pre></td><td class="code"><pre><span class="line">    fwrite(is-&gt;audio_buf, <span class="number">1</span>, len1, audiofd1);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">968</span></pre></td><td class="code"><pre><span class="line">    fflush(audiofd1);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">969</span></pre></td><td class="code"><pre><span class="line">    SDL_MixAudio(stream,(<span class="keyword">uint8_t</span> *)is-&gt;audio_buf, len1, SDL_MIX_MAXVOLUME);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">970</span></pre></td><td class="code"><pre><span class="line">    len -= len1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">971</span></pre></td><td class="code"><pre><span class="line">    stream += len1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">972</span></pre></td><td class="code"><pre><span class="line">    is-&gt;audio_buf_index += len1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">973</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">974</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">975</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">976</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> Uint32 <span class="title">sdl_refresh_timer_cb</span><span class="params">(Uint32 interval, <span class="keyword">void</span> *opaque)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">977</span></pre></td><td class="code"><pre><span class="line">  SDL_Event event;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">978</span></pre></td><td class="code"><pre><span class="line">  event.type = FF_REFRESH_EVENT;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">979</span></pre></td><td class="code"><pre><span class="line">  event.user.data1 = opaque;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">980</span></pre></td><td class="code"><pre><span class="line">  SDL_PushEvent(&amp;event);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">981</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">/* 0 means stop timer */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">982</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">983</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">984</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/* schedule a video refresh in 'delay' ms */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">985</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">schedule_refresh</span><span class="params">(VideoState *is, <span class="keyword">int</span> <span class="built_in">delay</span>)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">986</span></pre></td><td class="code"><pre><span class="line">  SDL_AddTimer(<span class="built_in">delay</span>, sdl_refresh_timer_cb, is);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">987</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">988</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">989</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">video_display</span><span class="params">(VideoState *is)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">990</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">991</span></pre></td><td class="code"><pre><span class="line">  SDL_Rect <span class="built_in">rect</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">992</span></pre></td><td class="code"><pre><span class="line">  VideoPicture *vp;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">993</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">float</span> aspect_ratio;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">994</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> w, h, x, y;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">995</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> i;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">996</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">997</span></pre></td><td class="code"><pre><span class="line">  vp = &amp;is-&gt;pictq[is-&gt;pictq_rindex];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">998</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(vp-&gt;pict) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">999</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1000</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(is-&gt;video_ctx-&gt;sample_aspect_ratio.num == <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1001</span></pre></td><td class="code"><pre><span class="line">      aspect_ratio = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1002</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1003</span></pre></td><td class="code"><pre><span class="line">      aspect_ratio = av_q2d(is-&gt;video_ctx-&gt;sample_aspect_ratio) *</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1004</span></pre></td><td class="code"><pre><span class="line">	is-&gt;video_ctx-&gt;<span class="built_in">width</span> / is-&gt;video_ctx-&gt;<span class="built_in">height</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1005</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1006</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1007</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(aspect_ratio &lt;= <span class="number">0.0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1008</span></pre></td><td class="code"><pre><span class="line">      aspect_ratio = (<span class="keyword">float</span>)is-&gt;video_ctx-&gt;<span class="built_in">width</span> /</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1009</span></pre></td><td class="code"><pre><span class="line">	(<span class="keyword">float</span>)is-&gt;video_ctx-&gt;<span class="built_in">height</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1010</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1011</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1012</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/*</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1013</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    h = screen-&gt;h;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1014</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    w = ((int)rint(h * aspect_ratio)) &amp; -3;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1015</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    if(w &gt; screen-&gt;w) &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1016</span></pre></td><td class="code"><pre><span class="line"><span class="comment">      w = screen-&gt;w;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1017</span></pre></td><td class="code"><pre><span class="line"><span class="comment">      h = ((int)rint(w / aspect_ratio)) &amp; -3;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1018</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    &#125;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1019</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    x = (screen-&gt;w - w) / 2;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1020</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    y = (screen-&gt;h - h) / 2;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1021</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1022</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1023</span></pre></td><td class="code"><pre><span class="line">    SDL_UpdateYUVTexture( texture, <span class="literal">NULL</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1024</span></pre></td><td class="code"><pre><span class="line">                          vp-&gt;pict-&gt;data[<span class="number">0</span>], vp-&gt;pict-&gt;linesize[<span class="number">0</span>],</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1025</span></pre></td><td class="code"><pre><span class="line">                          vp-&gt;pict-&gt;data[<span class="number">1</span>], vp-&gt;pict-&gt;linesize[<span class="number">1</span>],</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1026</span></pre></td><td class="code"><pre><span class="line">                          vp-&gt;pict-&gt;data[<span class="number">2</span>], vp-&gt;pict-&gt;linesize[<span class="number">2</span>]);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1027</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1028</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">rect</span>.x = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1029</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">rect</span>.y = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1030</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">rect</span>.w = is-&gt;video_ctx-&gt;<span class="built_in">width</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1031</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">rect</span>.h = is-&gt;video_ctx-&gt;<span class="built_in">height</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1032</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1033</span></pre></td><td class="code"><pre><span class="line">    SDL_LockMutex(texture_mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1034</span></pre></td><td class="code"><pre><span class="line">    SDL_RenderClear(renderer);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1035</span></pre></td><td class="code"><pre><span class="line">    SDL_RenderCopy(renderer, texture, <span class="literal">NULL</span>, &amp;<span class="built_in">rect</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1036</span></pre></td><td class="code"><pre><span class="line">    SDL_RenderPresent(renderer);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1037</span></pre></td><td class="code"><pre><span class="line">    SDL_UnlockMutex(texture_mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1038</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1039</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1040</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1041</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1042</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">video_refresh_timer</span><span class="params">(<span class="keyword">void</span> *userdata)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1043</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1044</span></pre></td><td class="code"><pre><span class="line">  VideoState *is = (VideoState *)userdata;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1045</span></pre></td><td class="code"><pre><span class="line">  VideoPicture *vp;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1046</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1047</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(is-&gt;video_st) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1048</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(is-&gt;pictq_size == <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1049</span></pre></td><td class="code"><pre><span class="line">      schedule_refresh(is, <span class="number">1</span>); <span class="comment">//if the queue is empty, so we shoud be as fast as checking queue of picture</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1050</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1051</span></pre></td><td class="code"><pre><span class="line">      vp = &amp;is-&gt;pictq[is-&gt;pictq_rindex];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1052</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">/* Now, normally here goes a ton of code</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1053</span></pre></td><td class="code"><pre><span class="line"><span class="comment">	 about timing, etc. we're just going to</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1054</span></pre></td><td class="code"><pre><span class="line"><span class="comment">	 guess at a delay for now. You can</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1055</span></pre></td><td class="code"><pre><span class="line"><span class="comment">	 increase and decrease this value and hard code</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1056</span></pre></td><td class="code"><pre><span class="line"><span class="comment">	 the timing - but I don't suggest that ;)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1057</span></pre></td><td class="code"><pre><span class="line"><span class="comment">	 We'll learn how to do it for real later.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1058</span></pre></td><td class="code"><pre><span class="line"><span class="comment">      */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1059</span></pre></td><td class="code"><pre><span class="line">      schedule_refresh(is, <span class="number">40</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1060</span></pre></td><td class="code"><pre><span class="line">      </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1061</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">/* show the picture! */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1062</span></pre></td><td class="code"><pre><span class="line">      video_display(is);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1063</span></pre></td><td class="code"><pre><span class="line">      </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1064</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">/* update queue for next picture! */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1065</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span>(++is-&gt;pictq_rindex == VIDEO_PICTURE_QUEUE_SIZE) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1066</span></pre></td><td class="code"><pre><span class="line">	is-&gt;pictq_rindex = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1067</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1068</span></pre></td><td class="code"><pre><span class="line">      SDL_LockMutex(is-&gt;pictq_mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1069</span></pre></td><td class="code"><pre><span class="line">      is-&gt;pictq_size--;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1070</span></pre></td><td class="code"><pre><span class="line">      SDL_CondSignal(is-&gt;pictq_cond);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1071</span></pre></td><td class="code"><pre><span class="line">      SDL_UnlockMutex(is-&gt;pictq_mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1072</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1073</span></pre></td><td class="code"><pre><span class="line">  &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1074</span></pre></td><td class="code"><pre><span class="line">    schedule_refresh(is, <span class="number">100</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1075</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1076</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1077</span></pre></td><td class="code"><pre><span class="line">      </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1078</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">alloc_picture</span><span class="params">(<span class="keyword">void</span> *userdata)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1079</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1080</span></pre></td><td class="code"><pre><span class="line">  VideoState *is = (VideoState *)userdata;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1081</span></pre></td><td class="code"><pre><span class="line">  VideoPicture *vp;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1082</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1083</span></pre></td><td class="code"><pre><span class="line">  vp = &amp;is-&gt;pictq[is-&gt;pictq_windex];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1084</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(vp-&gt;pict) &#123;<span class="comment">//free space if vp-&gt;pict is not NULL</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1085</span></pre></td><td class="code"><pre><span class="line">    avpicture_free(vp-&gt;pict);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1086</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">free</span>(vp-&gt;pict);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1087</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1088</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1089</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Allocate a place to put our YUV image on that screen</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1090</span></pre></td><td class="code"><pre><span class="line">  SDL_LockMutex(texture_mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1091</span></pre></td><td class="code"><pre><span class="line">  vp-&gt;pict = (AVPicture*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(AVPicture));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1092</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(vp-&gt;pict)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1093</span></pre></td><td class="code"><pre><span class="line">    avpicture_alloc(vp-&gt;pict,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1094</span></pre></td><td class="code"><pre><span class="line">		    AV_PIX_FMT_YUV420P, </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1095</span></pre></td><td class="code"><pre><span class="line">		    is-&gt;video_ctx-&gt;<span class="built_in">width</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1096</span></pre></td><td class="code"><pre><span class="line">		    is-&gt;video_ctx-&gt;<span class="built_in">height</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1097</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1098</span></pre></td><td class="code"><pre><span class="line">  SDL_UnlockMutex(texture_mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1099</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1100</span></pre></td><td class="code"><pre><span class="line">  vp-&gt;<span class="built_in">width</span> = is-&gt;video_ctx-&gt;<span class="built_in">width</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1101</span></pre></td><td class="code"><pre><span class="line">  vp-&gt;<span class="built_in">height</span> = is-&gt;video_ctx-&gt;<span class="built_in">height</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1102</span></pre></td><td class="code"><pre><span class="line">  vp-&gt;allocated = <span class="number">1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1103</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1104</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1105</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1106</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">queue_picture</span><span class="params">(VideoState *is, AVFrame *pFrame)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1107</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1108</span></pre></td><td class="code"><pre><span class="line">  VideoPicture *vp;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1109</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> dst_pix_fmt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1110</span></pre></td><td class="code"><pre><span class="line">  AVPicture pict;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1111</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1112</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">/* wait until we have space for a new pic */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1113</span></pre></td><td class="code"><pre><span class="line">  SDL_LockMutex(is-&gt;pictq_mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1114</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">while</span>(is-&gt;pictq_size &gt;= VIDEO_PICTURE_QUEUE_SIZE &amp;&amp;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1115</span></pre></td><td class="code"><pre><span class="line">	!is-&gt;quit) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1116</span></pre></td><td class="code"><pre><span class="line">    SDL_CondWait(is-&gt;pictq_cond, is-&gt;pictq_mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1117</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1118</span></pre></td><td class="code"><pre><span class="line">  SDL_UnlockMutex(is-&gt;pictq_mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1119</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1120</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(is-&gt;quit)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1121</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"quit from queue_picture....\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1122</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1123</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1124</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1125</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// windex is set to 0 initially</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1126</span></pre></td><td class="code"><pre><span class="line">  vp = &amp;is-&gt;pictq[is-&gt;pictq_windex];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1127</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1128</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">/*</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1129</span></pre></td><td class="code"><pre><span class="line"><span class="comment">  fprintf(stderr, "vp.width=%d, vp.height=%d, video_ctx.width=%d, video_ctx.height=%d\n", </span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1130</span></pre></td><td class="code"><pre><span class="line"><span class="comment">		  vp-&gt;width, </span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1131</span></pre></td><td class="code"><pre><span class="line"><span class="comment">		  vp-&gt;height, </span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1132</span></pre></td><td class="code"><pre><span class="line"><span class="comment">		  is-&gt;video_ctx-&gt;width,</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1133</span></pre></td><td class="code"><pre><span class="line"><span class="comment">		  is-&gt;video_ctx-&gt;height);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1134</span></pre></td><td class="code"><pre><span class="line"><span class="comment">  */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1135</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1136</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">/* allocate or resize the buffer! */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1137</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(!vp-&gt;pict ||</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1138</span></pre></td><td class="code"><pre><span class="line">     vp-&gt;<span class="built_in">width</span> != is-&gt;video_ctx-&gt;<span class="built_in">width</span> ||</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1139</span></pre></td><td class="code"><pre><span class="line">     vp-&gt;<span class="built_in">height</span> != is-&gt;video_ctx-&gt;<span class="built_in">height</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1140</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1141</span></pre></td><td class="code"><pre><span class="line">    vp-&gt;allocated = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1142</span></pre></td><td class="code"><pre><span class="line">    alloc_picture(is);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1143</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(is-&gt;quit) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1144</span></pre></td><td class="code"><pre><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"quit from queue_picture2....\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1145</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1146</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1147</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1148</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1149</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">/* We have a place to put our picture on the queue */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1150</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1151</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(vp-&gt;pict) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1152</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1153</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// Convert the image into YUV format that SDL uses</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1154</span></pre></td><td class="code"><pre><span class="line">    sws_scale(is-&gt;sws_ctx, (<span class="keyword">uint8_t</span> <span class="keyword">const</span> * <span class="keyword">const</span> *)pFrame-&gt;data,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1155</span></pre></td><td class="code"><pre><span class="line">	      pFrame-&gt;linesize, <span class="number">0</span>, is-&gt;video_ctx-&gt;<span class="built_in">height</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1156</span></pre></td><td class="code"><pre><span class="line">	      vp-&gt;pict-&gt;data, vp-&gt;pict-&gt;linesize);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1157</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1158</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* now we inform our display thread that we have a pic ready */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1159</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(++is-&gt;pictq_windex == VIDEO_PICTURE_QUEUE_SIZE) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1160</span></pre></td><td class="code"><pre><span class="line">      is-&gt;pictq_windex = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1161</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1162</span></pre></td><td class="code"><pre><span class="line">    SDL_LockMutex(is-&gt;pictq_mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1163</span></pre></td><td class="code"><pre><span class="line">    is-&gt;pictq_size++;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1164</span></pre></td><td class="code"><pre><span class="line">    SDL_UnlockMutex(is-&gt;pictq_mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1165</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1166</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1167</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1168</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1169</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">video_thread</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1170</span></pre></td><td class="code"><pre><span class="line">  VideoState *is = (VideoState *)arg;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1171</span></pre></td><td class="code"><pre><span class="line">  AVPacket pkt1, *packet = &amp;pkt1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1172</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> frameFinished;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1173</span></pre></td><td class="code"><pre><span class="line">  AVFrame *pFrame;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1174</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1175</span></pre></td><td class="code"><pre><span class="line">  pFrame = av_frame_alloc();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1176</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1177</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span>(;;) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1178</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(packet_queue_get(&amp;is-&gt;videoq, packet, <span class="number">1</span>) &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1179</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">// means we quit getting packets</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1180</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1181</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1182</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1183</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// Decode video frame</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1184</span></pre></td><td class="code"><pre><span class="line">    avcodec_decode_video2(is-&gt;video_ctx, pFrame, &amp;frameFinished, packet);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1185</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1186</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// Did we get a video frame?</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1187</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(frameFinished) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1188</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span>(queue_picture(is, pFrame) &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1189</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1190</span></pre></td><td class="code"><pre><span class="line">      &#125;      </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1191</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1192</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1193</span></pre></td><td class="code"><pre><span class="line">    av_free_packet(packet);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1194</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1195</span></pre></td><td class="code"><pre><span class="line">  av_frame_free(&amp;pFrame);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1196</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1197</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1198</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1199</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">stream_component_open</span><span class="params">(VideoState *is, <span class="keyword">int</span> stream_index)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1200</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1201</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int64_t</span> in_channel_layout, out_channel_layout;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1202</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1203</span></pre></td><td class="code"><pre><span class="line">  AVFormatContext *pFormatCtx = is-&gt;pFormatCtx;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1204</span></pre></td><td class="code"><pre><span class="line">  AVCodecContext *codecCtx = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1205</span></pre></td><td class="code"><pre><span class="line">  AVCodec *codec = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1206</span></pre></td><td class="code"><pre><span class="line">  SDL_AudioSpec wanted_spec, spec;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1207</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1208</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(stream_index &lt; <span class="number">0</span> || stream_index &gt;= pFormatCtx-&gt;nb_streams) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1209</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1210</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1211</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1212</span></pre></td><td class="code"><pre><span class="line">  codec = avcodec_find_decoder(pFormatCtx-&gt;streams[stream_index]-&gt;codec-&gt;codec_id);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1213</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(!codec) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1214</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Unsupported codec!\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1215</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1216</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1217</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1218</span></pre></td><td class="code"><pre><span class="line">  codecCtx = avcodec_alloc_context3(codec);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1219</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(avcodec_copy_context(codecCtx, pFormatCtx-&gt;streams[stream_index]-&gt;codec) != <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1220</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Couldn't copy codec context"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1221</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">// Error copying codec context</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1222</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1223</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1224</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1225</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(codecCtx-&gt;codec_type == AVMEDIA_TYPE_AUDIO) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1226</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// Set audio settings from codec info</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1227</span></pre></td><td class="code"><pre><span class="line">    wanted_spec.freq = codecCtx-&gt;sample_rate;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1228</span></pre></td><td class="code"><pre><span class="line">    wanted_spec.format = AUDIO_S16SYS;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1229</span></pre></td><td class="code"><pre><span class="line">    wanted_spec.channels = codecCtx-&gt;channels;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1230</span></pre></td><td class="code"><pre><span class="line">    wanted_spec.silence = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1231</span></pre></td><td class="code"><pre><span class="line">    wanted_spec.samples = SDL_AUDIO_BUFFER_SIZE;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1232</span></pre></td><td class="code"><pre><span class="line">    wanted_spec.callback = audio_callback;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1233</span></pre></td><td class="code"><pre><span class="line">    wanted_spec.userdata = is;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1234</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1235</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(SDL_OpenAudio(&amp;wanted_spec, &amp;spec) &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1236</span></pre></td><td class="code"><pre><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"SDL_OpenAudio: %s\n"</span>, SDL_GetError());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1237</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1238</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1239</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1240</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1241</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(avcodec_open2(codecCtx, codec, <span class="literal">NULL</span>) &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1242</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Unsupported codec!\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1243</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1244</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1245</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1246</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">switch</span>(codecCtx-&gt;codec_type) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1247</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">case</span> AVMEDIA_TYPE_AUDIO:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1248</span></pre></td><td class="code"><pre><span class="line">    is-&gt;audioStream = stream_index;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1249</span></pre></td><td class="code"><pre><span class="line">    is-&gt;audio_st = pFormatCtx-&gt;streams[stream_index];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1250</span></pre></td><td class="code"><pre><span class="line">    is-&gt;audio_ctx = codecCtx;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1251</span></pre></td><td class="code"><pre><span class="line">    is-&gt;audio_buf_size = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1252</span></pre></td><td class="code"><pre><span class="line">    is-&gt;audio_buf_index = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1253</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">memset</span>(&amp;is-&gt;audio_pkt, <span class="number">0</span>, <span class="keyword">sizeof</span>(is-&gt;audio_pkt));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1254</span></pre></td><td class="code"><pre><span class="line">    packet_queue_init(&amp;is-&gt;audioq);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1255</span></pre></td><td class="code"><pre><span class="line">    SDL_PauseAudio(<span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1256</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1257</span></pre></td><td class="code"><pre><span class="line">    in_channel_layout=av_get_default_channel_layout(is-&gt;audio_ctx-&gt;channels);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1258</span></pre></td><td class="code"><pre><span class="line">    out_channel_layout = in_channel_layout;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1259</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1260</span></pre></td><td class="code"><pre><span class="line">    is-&gt;audio_swr_ctx = swr_alloc();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1261</span></pre></td><td class="code"><pre><span class="line">    swr_alloc_set_opts(is-&gt;audio_swr_ctx,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1262</span></pre></td><td class="code"><pre><span class="line">                       out_channel_layout,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1263</span></pre></td><td class="code"><pre><span class="line">                       AV_SAMPLE_FMT_S16,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1264</span></pre></td><td class="code"><pre><span class="line">                       is-&gt;audio_ctx-&gt;sample_rate,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1265</span></pre></td><td class="code"><pre><span class="line">                       in_channel_layout,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1266</span></pre></td><td class="code"><pre><span class="line">                       is-&gt;audio_ctx-&gt;sample_fmt,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1267</span></pre></td><td class="code"><pre><span class="line">                       is-&gt;audio_ctx-&gt;sample_rate,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1268</span></pre></td><td class="code"><pre><span class="line">                       <span class="number">0</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1269</span></pre></td><td class="code"><pre><span class="line">                       <span class="literal">NULL</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1270</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1271</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"swr opts: out_channel_layout:%lld, out_sample_fmt:%d, out_sample_rate:%d, in_channel_layout:%lld, in_sample_fmt:%d, in_sample_rate:%d"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1272</span></pre></td><td class="code"><pre><span class="line">                    out_channel_layout, </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1273</span></pre></td><td class="code"><pre><span class="line">		    AV_SAMPLE_FMT_S16, </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1274</span></pre></td><td class="code"><pre><span class="line">		    is-&gt;audio_ctx-&gt;sample_rate, </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1275</span></pre></td><td class="code"><pre><span class="line">		    in_channel_layout, </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1276</span></pre></td><td class="code"><pre><span class="line">		    is-&gt;audio_ctx-&gt;sample_fmt, </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1277</span></pre></td><td class="code"><pre><span class="line">		    is-&gt;audio_ctx-&gt;sample_rate);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1278</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1279</span></pre></td><td class="code"><pre><span class="line">    swr_init(is-&gt;audio_swr_ctx);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1280</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1281</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1282</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1283</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">case</span> AVMEDIA_TYPE_VIDEO:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1284</span></pre></td><td class="code"><pre><span class="line">    is-&gt;videoStream = stream_index;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1285</span></pre></td><td class="code"><pre><span class="line">    is-&gt;video_st = pFormatCtx-&gt;streams[stream_index];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1286</span></pre></td><td class="code"><pre><span class="line">    is-&gt;video_ctx = codecCtx;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1287</span></pre></td><td class="code"><pre><span class="line">    packet_queue_init(&amp;is-&gt;videoq);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1288</span></pre></td><td class="code"><pre><span class="line">    is-&gt;video_tid = SDL_CreateThread(video_thread, <span class="string">"video_thread"</span>, is);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1289</span></pre></td><td class="code"><pre><span class="line">    is-&gt;sws_ctx = sws_getContext(is-&gt;video_ctx-&gt;<span class="built_in">width</span>, </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1290</span></pre></td><td class="code"><pre><span class="line">				 is-&gt;video_ctx-&gt;<span class="built_in">height</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1291</span></pre></td><td class="code"><pre><span class="line">				 is-&gt;video_ctx-&gt;pix_fmt, </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1292</span></pre></td><td class="code"><pre><span class="line">				 is-&gt;video_ctx-&gt;<span class="built_in">width</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1293</span></pre></td><td class="code"><pre><span class="line">				 is-&gt;video_ctx-&gt;<span class="built_in">height</span>, </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1294</span></pre></td><td class="code"><pre><span class="line">				 AV_PIX_FMT_YUV420P,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1295</span></pre></td><td class="code"><pre><span class="line">				 SWS_BILINEAR, </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1296</span></pre></td><td class="code"><pre><span class="line">				 <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1297</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1298</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">default</span>:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1299</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1300</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1301</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1302</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1303</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1304</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1305</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">decode_thread</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1306</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1307</span></pre></td><td class="code"><pre><span class="line">  Uint32 pixformat;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1308</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1309</span></pre></td><td class="code"><pre><span class="line">  VideoState *is = (VideoState *)arg;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1310</span></pre></td><td class="code"><pre><span class="line">  AVFormatContext *pFormatCtx;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1311</span></pre></td><td class="code"><pre><span class="line">  AVPacket pkt1, *packet = &amp;pkt1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1312</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1313</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> i;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1314</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> video_index = <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1315</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> audio_index = <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1316</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1317</span></pre></td><td class="code"><pre><span class="line">  is-&gt;videoStream = <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1318</span></pre></td><td class="code"><pre><span class="line">  is-&gt;audioStream = <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1319</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1320</span></pre></td><td class="code"><pre><span class="line">  global_video_state = is;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1321</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1322</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Open video file</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1323</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(avformat_open_input(&amp;pFormatCtx, is-&gt;filename, <span class="literal">NULL</span>, <span class="literal">NULL</span>)!=<span class="number">0</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1324</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">// Couldn't open file</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1325</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1326</span></pre></td><td class="code"><pre><span class="line">  is-&gt;pFormatCtx = pFormatCtx;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1327</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1328</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Retrieve stream information</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1329</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(avformat_find_stream_info(pFormatCtx, <span class="literal">NULL</span>)&lt;<span class="number">0</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1330</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">// Couldn't find stream information</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1331</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1332</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Dump information about file onto standard error</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1333</span></pre></td><td class="code"><pre><span class="line">  av_dump_format(pFormatCtx, <span class="number">0</span>, is-&gt;filename, <span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1334</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1335</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Find the first video stream</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1336</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;pFormatCtx-&gt;nb_streams; i++) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1337</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(pFormatCtx-&gt;streams[i]-&gt;codec-&gt;codec_type==AVMEDIA_TYPE_VIDEO &amp;&amp;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1338</span></pre></td><td class="code"><pre><span class="line">       video_index &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1339</span></pre></td><td class="code"><pre><span class="line">      video_index=i;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1340</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1341</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(pFormatCtx-&gt;streams[i]-&gt;codec-&gt;codec_type==AVMEDIA_TYPE_AUDIO &amp;&amp;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1342</span></pre></td><td class="code"><pre><span class="line">       audio_index &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1343</span></pre></td><td class="code"><pre><span class="line">      audio_index=i;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1344</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1345</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1346</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1347</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(audio_index &gt;= <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1348</span></pre></td><td class="code"><pre><span class="line">    stream_component_open(is, audio_index);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1349</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1350</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(video_index &gt;= <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1351</span></pre></td><td class="code"><pre><span class="line">    stream_component_open(is, video_index);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1352</span></pre></td><td class="code"><pre><span class="line">  &#125;   </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1353</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1354</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(is-&gt;videoStream &lt; <span class="number">0</span> || is-&gt;audioStream &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1355</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"%s: could not open codecs\n"</span>, is-&gt;filename);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1356</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">goto</span> fail;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1357</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1358</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1359</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"video context: width=%d, height=%d\n"</span>, is-&gt;video_ctx-&gt;<span class="built_in">width</span>, is-&gt;video_ctx-&gt;<span class="built_in">height</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1360</span></pre></td><td class="code"><pre><span class="line">  win = SDL_CreateWindow(<span class="string">"Media Player"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1361</span></pre></td><td class="code"><pre><span class="line">     		   SDL_WINDOWPOS_UNDEFINED,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1362</span></pre></td><td class="code"><pre><span class="line">		   SDL_WINDOWPOS_UNDEFINED,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1363</span></pre></td><td class="code"><pre><span class="line">		   is-&gt;video_ctx-&gt;<span class="built_in">width</span>, is-&gt;video_ctx-&gt;<span class="built_in">height</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1364</span></pre></td><td class="code"><pre><span class="line">		   SDL_WINDOW_OPENGL | SDL_WINDOW_RESIZABLE);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1365</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1366</span></pre></td><td class="code"><pre><span class="line">  renderer = SDL_CreateRenderer(win, <span class="number">-1</span>, <span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1367</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1368</span></pre></td><td class="code"><pre><span class="line">  pixformat = SDL_PIXELFORMAT_IYUV;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1369</span></pre></td><td class="code"><pre><span class="line">  texture = SDL_CreateTexture(renderer,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1370</span></pre></td><td class="code"><pre><span class="line">			      pixformat, </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1371</span></pre></td><td class="code"><pre><span class="line">			      SDL_TEXTUREACCESS_STREAMING,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1372</span></pre></td><td class="code"><pre><span class="line">			      is-&gt;video_ctx-&gt;<span class="built_in">width</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1373</span></pre></td><td class="code"><pre><span class="line">			      is-&gt;video_ctx-&gt;<span class="built_in">height</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1374</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1375</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// main decode loop</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1376</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span>(;;) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1377</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1378</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(is-&gt;quit) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1379</span></pre></td><td class="code"><pre><span class="line">      SDL_CondSignal(is-&gt;videoq.cond);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1380</span></pre></td><td class="code"><pre><span class="line">      SDL_CondSignal(is-&gt;audioq.cond);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1381</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1382</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1383</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1384</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// seek stuff goes here</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1385</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(is-&gt;audioq.<span class="built_in">size</span> &gt; MAX_AUDIOQ_SIZE ||</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1386</span></pre></td><td class="code"><pre><span class="line">       is-&gt;videoq.<span class="built_in">size</span> &gt; MAX_VIDEOQ_SIZE) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1387</span></pre></td><td class="code"><pre><span class="line">      SDL_Delay(<span class="number">10</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1388</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">continue</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1389</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1390</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1391</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(av_read_frame(is-&gt;pFormatCtx, packet) &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1392</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span>(is-&gt;pFormatCtx-&gt;pb-&gt;error == <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1393</span></pre></td><td class="code"><pre><span class="line">	SDL_Delay(<span class="number">100</span>); <span class="comment">/* no error; wait for user input */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1394</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">continue</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1395</span></pre></td><td class="code"><pre><span class="line">      &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1396</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1397</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1398</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1399</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1400</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// Is this a packet from the video stream?</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1401</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(packet-&gt;stream_index == is-&gt;videoStream) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1402</span></pre></td><td class="code"><pre><span class="line">      packet_queue_put(&amp;is-&gt;videoq, packet);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1403</span></pre></td><td class="code"><pre><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"put video queue, size :%d\n"</span>, is-&gt;videoq.nb_packets);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1404</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(packet-&gt;stream_index == is-&gt;audioStream) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1405</span></pre></td><td class="code"><pre><span class="line">      packet_queue_put(&amp;is-&gt;audioq, packet);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1406</span></pre></td><td class="code"><pre><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"put audio queue, size :%d\n"</span>, is-&gt;audioq.nb_packets);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1407</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1408</span></pre></td><td class="code"><pre><span class="line">      av_free_packet(packet);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1409</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1410</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1411</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1412</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1413</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">/* all done - wait for it */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1414</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">while</span>(!is-&gt;quit) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1415</span></pre></td><td class="code"><pre><span class="line">    SDL_Delay(<span class="number">100</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1416</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1417</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1418</span></pre></td><td class="code"><pre><span class="line"> fail:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1419</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(<span class="number">1</span>)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1420</span></pre></td><td class="code"><pre><span class="line">    SDL_Event event;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1421</span></pre></td><td class="code"><pre><span class="line">    event.type = FF_QUIT_EVENT;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1422</span></pre></td><td class="code"><pre><span class="line">    event.user.data1 = is;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1423</span></pre></td><td class="code"><pre><span class="line">    SDL_PushEvent(&amp;event);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1424</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1425</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1426</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1427</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1428</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1429</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1430</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1431</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> 		  ret = <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1432</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1433</span></pre></td><td class="code"><pre><span class="line">  SDL_Event       event;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1434</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1435</span></pre></td><td class="code"><pre><span class="line">  VideoState      *is;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1436</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1437</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(argc &lt; <span class="number">2</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1438</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Usage: test &lt;file&gt;\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1439</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1440</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1441</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1442</span></pre></td><td class="code"><pre><span class="line">  audiofd = fopen(<span class="string">"testout.pcm"</span>, <span class="string">"wb+"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1443</span></pre></td><td class="code"><pre><span class="line">  audiofd1 = fopen(<span class="string">"testout1.pcm"</span>, <span class="string">"wb+"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1444</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1445</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">//big struct, it's core</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1446</span></pre></td><td class="code"><pre><span class="line">  is = av_mallocz(<span class="keyword">sizeof</span>(VideoState));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1447</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1448</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Register all formats and codecs</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1449</span></pre></td><td class="code"><pre><span class="line">  av_register_all();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1450</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1451</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(SDL_Init(SDL_INIT_VIDEO | SDL_INIT_AUDIO | SDL_INIT_TIMER)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1452</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Could not initialize SDL - %s\n"</span>, SDL_GetError());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1453</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1454</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1455</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1456</span></pre></td><td class="code"><pre><span class="line">  texture_mutex = SDL_CreateMutex();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1457</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1458</span></pre></td><td class="code"><pre><span class="line">  av_strlcpy(is-&gt;filename, argv[<span class="number">1</span>], <span class="keyword">sizeof</span>(is-&gt;filename));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1459</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1460</span></pre></td><td class="code"><pre><span class="line">  is-&gt;pictq_mutex = SDL_CreateMutex();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1461</span></pre></td><td class="code"><pre><span class="line">  is-&gt;pictq_cond = SDL_CreateCond();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1462</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1463</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">//set timer</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1464</span></pre></td><td class="code"><pre><span class="line">  schedule_refresh(is, <span class="number">40</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1465</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1466</span></pre></td><td class="code"><pre><span class="line">  is-&gt;parse_tid = SDL_CreateThread(decode_thread, <span class="string">"decode_thread"</span>, is);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1467</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(!is-&gt;parse_tid) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1468</span></pre></td><td class="code"><pre><span class="line">    av_free(is);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1469</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">goto</span> __FAIL;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1470</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1471</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1472</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span>(;;) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1473</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1474</span></pre></td><td class="code"><pre><span class="line">    SDL_WaitEvent(&amp;event);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1475</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">switch</span>(event.type) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1476</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">case</span> FF_QUIT_EVENT:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1477</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">case</span> SDL_QUIT:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1478</span></pre></td><td class="code"><pre><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"receive a QUIT event: %d\n"</span>, event.type);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1479</span></pre></td><td class="code"><pre><span class="line">      is-&gt;quit = <span class="number">1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1480</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">//SDL_Quit();</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1481</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">//return 0;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1482</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">goto</span> __QUIT;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1483</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1484</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">case</span> FF_REFRESH_EVENT:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1485</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">//fprintf(stderr, "receive a refresh event: %d\n", event.type);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1486</span></pre></td><td class="code"><pre><span class="line">      video_refresh_timer(event.user.data1);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1487</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1488</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">default</span>:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1489</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1490</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1491</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1492</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1493</span></pre></td><td class="code"><pre><span class="line">__QUIT:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1494</span></pre></td><td class="code"><pre><span class="line">  ret = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1495</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1496</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1497</span></pre></td><td class="code"><pre><span class="line">__FAIL:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1498</span></pre></td><td class="code"><pre><span class="line">  SDL_Quit();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1499</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(audiofd)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1500</span></pre></td><td class="code"><pre><span class="line">    fclose(audiofd);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1501</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1502</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(audiofd1)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1503</span></pre></td><td class="code"><pre><span class="line">    fclose(audiofd1);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1504</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1505</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> ret;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1506</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1507</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1508</span></pre></td><td class="code"><pre><span class="line">```  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1509</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1510</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1511</span></pre></td><td class="code"><pre><span class="line">#### <span class="number">53.</span>线程的退出机制</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1512</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1513</span></pre></td><td class="code"><pre><span class="line">- 主线程接收到退出事件</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1514</span></pre></td><td class="code"><pre><span class="line">- 解复用线程在循环分流时对quit进行判断</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1515</span></pre></td><td class="code"><pre><span class="line">- 视频解码线程从视频流队列中取包时对quit进行判断</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1516</span></pre></td><td class="code"><pre><span class="line">- 音频解码从音频流队列中取包时对quit进行判断</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1517</span></pre></td><td class="code"><pre><span class="line">- 音视频循环解码时对quit进行判断</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1518</span></pre></td><td class="code"><pre><span class="line">- 在收到信号变量消息时对quit进行判断</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1519</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1520</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1521</span></pre></td><td class="code"><pre><span class="line">#### <span class="number">54.</span>音视频同步</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1522</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1523</span></pre></td><td class="code"><pre><span class="line">- 时间戳</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1524</span></pre></td><td class="code"><pre><span class="line">    - PTS: Presentation timestamp 用于最终渲染用的</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1525</span></pre></td><td class="code"><pre><span class="line">    - DTS: Decoding timestamp 用于视频解码</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1526</span></pre></td><td class="code"><pre><span class="line">    - I(intra) / B(bidirectional) / P(predicted) 帧</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1527</span></pre></td><td class="code"><pre><span class="line">        - I 关键帧，帧内压缩</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1528</span></pre></td><td class="code"><pre><span class="line">        - B 向前向后参考<span class="number">3</span>帧，可多帧</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1529</span></pre></td><td class="code"><pre><span class="line">        - P 向前参考帧，<span class="number">1</span>帧</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1530</span></pre></td><td class="code"><pre><span class="line">- 时间戳顺序</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1531</span></pre></td><td class="code"><pre><span class="line">    - 实际帧顺序：I B B P</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1532</span></pre></td><td class="code"><pre><span class="line">    - 存放帧顺序：I P B B</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1533</span></pre></td><td class="code"><pre><span class="line">    - 解码时间戳：<span class="number">1</span> <span class="number">4</span> <span class="number">2</span> <span class="number">3</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1534</span></pre></td><td class="code"><pre><span class="line">    - 展示时间戳：<span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1535</span></pre></td><td class="code"><pre><span class="line">- 从哪儿获取PTS</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1536</span></pre></td><td class="code"><pre><span class="line">    - AVPacket中的PTS【解复用的数据包里】</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1537</span></pre></td><td class="code"><pre><span class="line">    - AvFrame中的PTS【解码数据帧里】</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1538</span></pre></td><td class="code"><pre><span class="line">    - av_frame_get_best_effort_timestamp()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1539</span></pre></td><td class="code"><pre><span class="line">- 时间基</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1540</span></pre></td><td class="code"><pre><span class="line">    - 不同的时间的基数</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1541</span></pre></td><td class="code"><pre><span class="line">    - tbr: 帧率 【<span class="number">1</span>/<span class="number">25</span>】</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1542</span></pre></td><td class="code"><pre><span class="line">    - tbn: time base of stream</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1543</span></pre></td><td class="code"><pre><span class="line">    - tbc: time base of codec</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1544</span></pre></td><td class="code"><pre><span class="line">- 计算当前帧的PTS</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1545</span></pre></td><td class="code"><pre><span class="line">    - PTS = PTS * av_q2d(video_stream-&gt;time_base) </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1546</span></pre></td><td class="code"><pre><span class="line">    - av_q2d(AVRotional a) &#123; <span class="keyword">return</span> a.num / (<span class="keyword">double</span>)a.den; &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1547</span></pre></td><td class="code"><pre><span class="line">- 计算下一帧的PTS</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1548</span></pre></td><td class="code"><pre><span class="line">    - video_clock: 预测的下一帧视频的PTS</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1549</span></pre></td><td class="code"><pre><span class="line">    - frame_delay: <span class="number">1</span>/tbr</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1550</span></pre></td><td class="code"><pre><span class="line">    - audio_clokc: 音频当前播放的时间戳</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1551</span></pre></td><td class="code"><pre><span class="line">- 音视频同步的方式</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1552</span></pre></td><td class="code"><pre><span class="line">    - 视频同步到音频（易）</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1553</span></pre></td><td class="code"><pre><span class="line">    - 音频同步到视频（难）</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1554</span></pre></td><td class="code"><pre><span class="line">    - 音频和视频都同步到系统时钟</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1555</span></pre></td><td class="code"><pre><span class="line">- 视频播放的基本思路</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1556</span></pre></td><td class="code"><pre><span class="line">    - 一般的做法，展示第一帧视频帧后，获得要显示的下一个帧视频的PTS，然后设置一个定时器，当定时器超时后，刷新新的视频帧，如此反复操作。 </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1557</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1558</span></pre></td><td class="code"><pre><span class="line">```c</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1559</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1560</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1561</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1562</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1563</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;SDL.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1564</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1565</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavcodec/avcodec.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1566</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libavformat/avformat.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1567</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libswscale/swscale.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1568</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;libswresample/swresample.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1569</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1570</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// compatibility with newer API</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1571</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> LIBAVCODEC_VERSION_INT &lt; AV_VERSION_INT(55,28,1)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1572</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> av_frame_alloc avcodec_alloc_frame</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1573</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> av_frame_free avcodec_free_frame</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1574</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1575</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1576</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SDL_AUDIO_BUFFER_SIZE 1024</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1577</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_AUDIO_FRAME_SIZE 192000</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1578</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1579</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_AUDIOQ_SIZE (5 * 16 * 1024)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1580</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_VIDEOQ_SIZE (5 * 256 * 1024)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1581</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1582</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AV_SYNC_THRESHOLD 0.01</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1583</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AV_NOSYNC_THRESHOLD 10.0</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1584</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1585</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FF_REFRESH_EVENT (SDL_USEREVENT)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1586</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FF_QUIT_EVENT (SDL_USEREVENT + 1)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1587</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1588</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VIDEO_PICTURE_QUEUE_SIZE 1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1589</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1590</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">PacketQueue</span> &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1591</span></pre></td><td class="code"><pre><span class="line">  AVPacketList *first_pkt, *last_pkt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1592</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> nb_packets;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1593</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> <span class="built_in">size</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1594</span></pre></td><td class="code"><pre><span class="line">  SDL_mutex *mutex;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1595</span></pre></td><td class="code"><pre><span class="line">  SDL_cond *cond;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1596</span></pre></td><td class="code"><pre><span class="line">&#125; PacketQueue;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1597</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1598</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1599</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">VideoPicture</span> &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1600</span></pre></td><td class="code"><pre><span class="line">  AVPicture *bmp;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1601</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> <span class="built_in">width</span>, <span class="built_in">height</span>; <span class="comment">/* source height &amp; width */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1602</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> allocated;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1603</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span> pts;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1604</span></pre></td><td class="code"><pre><span class="line">&#125; VideoPicture;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1605</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1606</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">VideoState</span> &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1607</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1608</span></pre></td><td class="code"><pre><span class="line">  AVFormatContext *pFormatCtx;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1609</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span>             videoStream, audioStream;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1610</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1611</span></pre></td><td class="code"><pre><span class="line">  AVStream        *audio_st;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1612</span></pre></td><td class="code"><pre><span class="line">  AVCodecContext  *audio_ctx;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1613</span></pre></td><td class="code"><pre><span class="line">  PacketQueue     audioq;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1614</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">uint8_t</span>         audio_buf[(MAX_AUDIO_FRAME_SIZE * <span class="number">3</span>) / <span class="number">2</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1615</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span>    audio_buf_size;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1616</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span>    audio_buf_index;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1617</span></pre></td><td class="code"><pre><span class="line">  AVFrame         audio_frame;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1618</span></pre></td><td class="code"><pre><span class="line">  AVPacket        audio_pkt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1619</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">uint8_t</span>         *audio_pkt_data;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1620</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span>             audio_pkt_size;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1621</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span>             audio_hw_buf_size;  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1622</span></pre></td><td class="code"><pre><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">SwrContext</span> *<span class="title">audio_swr_ctx</span>;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1623</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1624</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span>          audio_clock;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1625</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span>          video_clock; <span class="comment">///&lt;pts of last decoded frame / predicted pts of next decoded frame</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1626</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1627</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span>          frame_timer;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1628</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span>          frame_last_pts;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1629</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span>          frame_last_delay;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1630</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1631</span></pre></td><td class="code"><pre><span class="line">  AVStream        *video_st;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1632</span></pre></td><td class="code"><pre><span class="line">  AVCodecContext  *video_ctx;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1633</span></pre></td><td class="code"><pre><span class="line">  PacketQueue     videoq;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1634</span></pre></td><td class="code"><pre><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">SwsContext</span> *<span class="title">video_sws_ctx</span>;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1635</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1636</span></pre></td><td class="code"><pre><span class="line">  VideoPicture    pictq[VIDEO_PICTURE_QUEUE_SIZE];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1637</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span>             pictq_size, pictq_rindex, pictq_windex;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1638</span></pre></td><td class="code"><pre><span class="line">  SDL_mutex       *pictq_mutex;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1639</span></pre></td><td class="code"><pre><span class="line">  SDL_cond        *pictq_cond;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1640</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1641</span></pre></td><td class="code"><pre><span class="line">  SDL_Thread      *parse_tid;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1642</span></pre></td><td class="code"><pre><span class="line">  SDL_Thread      *video_tid;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1643</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1644</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">char</span>            filename[<span class="number">1024</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1645</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span>             quit;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1646</span></pre></td><td class="code"><pre><span class="line">&#125; VideoState;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1647</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1648</span></pre></td><td class="code"><pre><span class="line">SDL_mutex       *text_mutex;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1649</span></pre></td><td class="code"><pre><span class="line">SDL_Window	*win;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1650</span></pre></td><td class="code"><pre><span class="line">SDL_Renderer 	*renderer;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1651</span></pre></td><td class="code"><pre><span class="line">SDL_Texture  	*texture;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1652</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1653</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Since we only have one decoding thread, the Big Struct</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1654</span></pre></td><td class="code"><pre><span class="line"><span class="comment">   can be global in case we need it. */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1655</span></pre></td><td class="code"><pre><span class="line">VideoState *global_video_state;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1656</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1657</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">packet_queue_init</span><span class="params">(PacketQueue *q)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1658</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">memset</span>(q, <span class="number">0</span>, <span class="keyword">sizeof</span>(PacketQueue));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1659</span></pre></td><td class="code"><pre><span class="line">  q-&gt;mutex = SDL_CreateMutex();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1660</span></pre></td><td class="code"><pre><span class="line">  q-&gt;cond = SDL_CreateCond();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1661</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1662</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">packet_queue_put</span><span class="params">(PacketQueue *q, AVPacket *pkt)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1663</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1664</span></pre></td><td class="code"><pre><span class="line">  AVPacketList *pkt1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1665</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(av_dup_packet(pkt) &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1666</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1667</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1668</span></pre></td><td class="code"><pre><span class="line">  pkt1 = av_malloc(<span class="keyword">sizeof</span>(AVPacketList));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1669</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span> (!pkt1)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1670</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1671</span></pre></td><td class="code"><pre><span class="line">  pkt1-&gt;pkt = *pkt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1672</span></pre></td><td class="code"><pre><span class="line">  pkt1-&gt;next = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1673</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1674</span></pre></td><td class="code"><pre><span class="line">  SDL_LockMutex(q-&gt;mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1675</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1676</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span> (!q-&gt;last_pkt)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1677</span></pre></td><td class="code"><pre><span class="line">    q-&gt;first_pkt = pkt1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1678</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">else</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1679</span></pre></td><td class="code"><pre><span class="line">    q-&gt;last_pkt-&gt;next = pkt1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1680</span></pre></td><td class="code"><pre><span class="line">  q-&gt;last_pkt = pkt1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1681</span></pre></td><td class="code"><pre><span class="line">  q-&gt;nb_packets++;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1682</span></pre></td><td class="code"><pre><span class="line">  q-&gt;<span class="built_in">size</span> += pkt1-&gt;pkt.<span class="built_in">size</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1683</span></pre></td><td class="code"><pre><span class="line">  SDL_CondSignal(q-&gt;cond);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1684</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1685</span></pre></td><td class="code"><pre><span class="line">  SDL_UnlockMutex(q-&gt;mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1686</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1687</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1688</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1689</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">packet_queue_get</span><span class="params">(PacketQueue *q, AVPacket *pkt, <span class="keyword">int</span> block)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1690</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1691</span></pre></td><td class="code"><pre><span class="line">  AVPacketList *pkt1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1692</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> ret;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1693</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1694</span></pre></td><td class="code"><pre><span class="line">  SDL_LockMutex(q-&gt;mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1695</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1696</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span>(;;) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1697</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1698</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(global_video_state-&gt;quit) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1699</span></pre></td><td class="code"><pre><span class="line">      ret = <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1700</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1701</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1702</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1703</span></pre></td><td class="code"><pre><span class="line">    pkt1 = q-&gt;first_pkt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1704</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (pkt1) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1705</span></pre></td><td class="code"><pre><span class="line">      q-&gt;first_pkt = pkt1-&gt;next;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1706</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span> (!q-&gt;first_pkt)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1707</span></pre></td><td class="code"><pre><span class="line">	q-&gt;last_pkt = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1708</span></pre></td><td class="code"><pre><span class="line">      q-&gt;nb_packets--;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1709</span></pre></td><td class="code"><pre><span class="line">      q-&gt;<span class="built_in">size</span> -= pkt1-&gt;pkt.<span class="built_in">size</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1710</span></pre></td><td class="code"><pre><span class="line">      *pkt = pkt1-&gt;pkt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1711</span></pre></td><td class="code"><pre><span class="line">      av_free(pkt1);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1712</span></pre></td><td class="code"><pre><span class="line">      ret = <span class="number">1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1713</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1714</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!block) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1715</span></pre></td><td class="code"><pre><span class="line">      ret = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1716</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1717</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1718</span></pre></td><td class="code"><pre><span class="line">      SDL_CondWait(q-&gt;cond, q-&gt;mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1719</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1720</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1721</span></pre></td><td class="code"><pre><span class="line">  SDL_UnlockMutex(q-&gt;mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1722</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> ret;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1723</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1724</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1725</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">get_audio_clock</span><span class="params">(VideoState *is)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1726</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span> pts;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1727</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> hw_buf_size, bytes_per_sec, n;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1728</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1729</span></pre></td><td class="code"><pre><span class="line">  pts = is-&gt;audio_clock; <span class="comment">/* maintained in the audio thread */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1730</span></pre></td><td class="code"><pre><span class="line">  hw_buf_size = is-&gt;audio_buf_size - is-&gt;audio_buf_index;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1731</span></pre></td><td class="code"><pre><span class="line">  bytes_per_sec = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1732</span></pre></td><td class="code"><pre><span class="line">  n = is-&gt;audio_ctx-&gt;channels * <span class="number">2</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1733</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(is-&gt;audio_st) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1734</span></pre></td><td class="code"><pre><span class="line">    bytes_per_sec = is-&gt;audio_ctx-&gt;sample_rate * n;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1735</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1736</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(bytes_per_sec) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1737</span></pre></td><td class="code"><pre><span class="line">    pts -= (<span class="keyword">double</span>)hw_buf_size / bytes_per_sec;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1738</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1739</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> pts;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1740</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1741</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1742</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">audio_decode_frame</span><span class="params">(VideoState *is, <span class="keyword">uint8_t</span> *audio_buf, <span class="keyword">int</span> buf_size, <span class="keyword">double</span> *pts_ptr)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1743</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1744</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> len1, data_size = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1745</span></pre></td><td class="code"><pre><span class="line">  AVPacket *pkt = &amp;is-&gt;audio_pkt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1746</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span> pts;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1747</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> n;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1748</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1749</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span>(;;) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1750</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">while</span>(is-&gt;audio_pkt_size &gt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1751</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">int</span> got_frame = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1752</span></pre></td><td class="code"><pre><span class="line">      len1 = avcodec_decode_audio4(is-&gt;audio_ctx, &amp;is-&gt;audio_frame, &amp;got_frame, pkt);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1753</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span>(len1 &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1754</span></pre></td><td class="code"><pre><span class="line">	<span class="comment">/* if error, skip frame */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1755</span></pre></td><td class="code"><pre><span class="line">	is-&gt;audio_pkt_size = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1756</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1757</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1758</span></pre></td><td class="code"><pre><span class="line">      data_size = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1759</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span>(got_frame) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1760</span></pre></td><td class="code"><pre><span class="line">	<span class="comment">/*</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1761</span></pre></td><td class="code"><pre><span class="line"><span class="comment">	data_size = av_samples_get_buffer_size(NULL, </span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1762</span></pre></td><td class="code"><pre><span class="line"><span class="comment">					       is-&gt;audio_ctx-&gt;channels,</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1763</span></pre></td><td class="code"><pre><span class="line"><span class="comment">					       is-&gt;audio_frame.nb_samples,</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1764</span></pre></td><td class="code"><pre><span class="line"><span class="comment">					       is-&gt;audio_ctx-&gt;sample_fmt,</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1765</span></pre></td><td class="code"><pre><span class="line"><span class="comment">					       1);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1766</span></pre></td><td class="code"><pre><span class="line"><span class="comment">	*/</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1767</span></pre></td><td class="code"><pre><span class="line">	data_size = <span class="number">2</span> * is-&gt;audio_frame.nb_samples * <span class="number">2</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1768</span></pre></td><td class="code"><pre><span class="line">	assert(data_size &lt;= buf_size);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1769</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1770</span></pre></td><td class="code"><pre><span class="line">        swr_convert(is-&gt;audio_swr_ctx,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1771</span></pre></td><td class="code"><pre><span class="line">                        &amp;audio_buf,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1772</span></pre></td><td class="code"><pre><span class="line">                        MAX_AUDIO_FRAME_SIZE*<span class="number">3</span>/<span class="number">2</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1773</span></pre></td><td class="code"><pre><span class="line">                        (<span class="keyword">const</span> <span class="keyword">uint8_t</span> **)is-&gt;audio_frame.data,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1774</span></pre></td><td class="code"><pre><span class="line">                        is-&gt;audio_frame.nb_samples);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1775</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1776</span></pre></td><td class="code"><pre><span class="line">	<span class="comment">//memcpy(audio_buf, is-&gt;audio_frame.data[0], data_size);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1777</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1778</span></pre></td><td class="code"><pre><span class="line">      is-&gt;audio_pkt_data += len1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1779</span></pre></td><td class="code"><pre><span class="line">      is-&gt;audio_pkt_size -= len1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1780</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span>(data_size &lt;= <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1781</span></pre></td><td class="code"><pre><span class="line">	<span class="comment">/* No data yet, get more frames */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1782</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">continue</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1783</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1784</span></pre></td><td class="code"><pre><span class="line">      pts = is-&gt;audio_clock;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1785</span></pre></td><td class="code"><pre><span class="line">      *pts_ptr = pts;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1786</span></pre></td><td class="code"><pre><span class="line">      n = <span class="number">2</span> * is-&gt;audio_ctx-&gt;channels;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1787</span></pre></td><td class="code"><pre><span class="line">      is-&gt;audio_clock += (<span class="keyword">double</span>)data_size /</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1788</span></pre></td><td class="code"><pre><span class="line">	(<span class="keyword">double</span>)(n * is-&gt;audio_ctx-&gt;sample_rate);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1789</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">/* We have data, return it and come back for more later */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1790</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">return</span> data_size;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1791</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1792</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(pkt-&gt;data)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1793</span></pre></td><td class="code"><pre><span class="line">      av_free_packet(pkt);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1794</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1795</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(is-&gt;quit) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1796</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1797</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1798</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* next packet */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1799</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(packet_queue_get(&amp;is-&gt;audioq, pkt, <span class="number">1</span>) &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1800</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1801</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1802</span></pre></td><td class="code"><pre><span class="line">    is-&gt;audio_pkt_data = pkt-&gt;data;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1803</span></pre></td><td class="code"><pre><span class="line">    is-&gt;audio_pkt_size = pkt-&gt;<span class="built_in">size</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1804</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* if update, update the audio clock w/pts */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1805</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(pkt-&gt;pts != AV_NOPTS_VALUE) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1806</span></pre></td><td class="code"><pre><span class="line">      is-&gt;audio_clock = av_q2d(is-&gt;audio_st-&gt;time_base)*pkt-&gt;pts;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1807</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1808</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1809</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1810</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1811</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">audio_callback</span><span class="params">(<span class="keyword">void</span> *userdata, Uint8 *stream, <span class="keyword">int</span> len)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1812</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1813</span></pre></td><td class="code"><pre><span class="line">  VideoState *is = (VideoState *)userdata;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1814</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> len1, audio_size;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1815</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span> pts;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1816</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1817</span></pre></td><td class="code"><pre><span class="line">  SDL_memset(stream, <span class="number">0</span>, len);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1818</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1819</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">while</span>(len &gt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1820</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(is-&gt;audio_buf_index &gt;= is-&gt;audio_buf_size) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1821</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">/* We have already sent all our data; get more */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1822</span></pre></td><td class="code"><pre><span class="line">      audio_size = audio_decode_frame(is, is-&gt;audio_buf, <span class="keyword">sizeof</span>(is-&gt;audio_buf), &amp;pts);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1823</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span>(audio_size &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1824</span></pre></td><td class="code"><pre><span class="line">	<span class="comment">/* If error, output silence */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1825</span></pre></td><td class="code"><pre><span class="line">	is-&gt;audio_buf_size = <span class="number">1024</span> * <span class="number">2</span> * <span class="number">2</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1826</span></pre></td><td class="code"><pre><span class="line">	<span class="built_in">memset</span>(is-&gt;audio_buf, <span class="number">0</span>, is-&gt;audio_buf_size);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1827</span></pre></td><td class="code"><pre><span class="line">      &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1828</span></pre></td><td class="code"><pre><span class="line">	is-&gt;audio_buf_size = audio_size;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1829</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1830</span></pre></td><td class="code"><pre><span class="line">      is-&gt;audio_buf_index = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1831</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1832</span></pre></td><td class="code"><pre><span class="line">    len1 = is-&gt;audio_buf_size - is-&gt;audio_buf_index;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1833</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(len1 &gt; len)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1834</span></pre></td><td class="code"><pre><span class="line">      len1 = len;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1835</span></pre></td><td class="code"><pre><span class="line">    SDL_MixAudio(stream,(<span class="keyword">uint8_t</span> *)is-&gt;audio_buf + is-&gt;audio_buf_index, len1, SDL_MIX_MAXVOLUME);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1836</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//memcpy(stream, (uint8_t *)is-&gt;audio_buf + is-&gt;audio_buf_index, len1);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1837</span></pre></td><td class="code"><pre><span class="line">    len -= len1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1838</span></pre></td><td class="code"><pre><span class="line">    stream += len1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1839</span></pre></td><td class="code"><pre><span class="line">    is-&gt;audio_buf_index += len1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1840</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1841</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1842</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1843</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> Uint32 <span class="title">sdl_refresh_timer_cb</span><span class="params">(Uint32 interval, <span class="keyword">void</span> *opaque)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1844</span></pre></td><td class="code"><pre><span class="line">  SDL_Event event;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1845</span></pre></td><td class="code"><pre><span class="line">  event.type = FF_REFRESH_EVENT;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1846</span></pre></td><td class="code"><pre><span class="line">  event.user.data1 = opaque;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1847</span></pre></td><td class="code"><pre><span class="line">  SDL_PushEvent(&amp;event);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1848</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">/* 0 means stop timer */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1849</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1850</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1851</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/* schedule a video refresh in 'delay' ms */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1852</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">schedule_refresh</span><span class="params">(VideoState *is, <span class="keyword">int</span> <span class="built_in">delay</span>)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1853</span></pre></td><td class="code"><pre><span class="line">  SDL_AddTimer(<span class="built_in">delay</span>, sdl_refresh_timer_cb, is);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1854</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1855</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1856</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">video_display</span><span class="params">(VideoState *is)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1857</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1858</span></pre></td><td class="code"><pre><span class="line">  SDL_Rect <span class="built_in">rect</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1859</span></pre></td><td class="code"><pre><span class="line">  VideoPicture *vp;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1860</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">float</span> aspect_ratio;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1861</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> w, h, x, y;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1862</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> i;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1863</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1864</span></pre></td><td class="code"><pre><span class="line">  vp = &amp;is-&gt;pictq[is-&gt;pictq_rindex];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1865</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(vp-&gt;bmp) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1866</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1867</span></pre></td><td class="code"><pre><span class="line">    SDL_UpdateYUVTexture( texture, <span class="literal">NULL</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1868</span></pre></td><td class="code"><pre><span class="line">                          vp-&gt;bmp-&gt;data[<span class="number">0</span>], vp-&gt;bmp-&gt;linesize[<span class="number">0</span>],</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1869</span></pre></td><td class="code"><pre><span class="line">                          vp-&gt;bmp-&gt;data[<span class="number">1</span>], vp-&gt;bmp-&gt;linesize[<span class="number">1</span>],</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1870</span></pre></td><td class="code"><pre><span class="line">                          vp-&gt;bmp-&gt;data[<span class="number">2</span>], vp-&gt;bmp-&gt;linesize[<span class="number">2</span>]);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1871</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1872</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">rect</span>.x = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1873</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">rect</span>.y = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1874</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">rect</span>.w = is-&gt;video_ctx-&gt;<span class="built_in">width</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1875</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">rect</span>.h = is-&gt;video_ctx-&gt;<span class="built_in">height</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1876</span></pre></td><td class="code"><pre><span class="line">    SDL_LockMutex(text_mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1877</span></pre></td><td class="code"><pre><span class="line">    SDL_RenderClear( renderer );</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1878</span></pre></td><td class="code"><pre><span class="line">    SDL_RenderCopy( renderer, texture, <span class="literal">NULL</span>, &amp;<span class="built_in">rect</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1879</span></pre></td><td class="code"><pre><span class="line">    SDL_RenderPresent( renderer );</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1880</span></pre></td><td class="code"><pre><span class="line">    SDL_UnlockMutex(text_mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1881</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1882</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1883</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1884</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1885</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">video_refresh_timer</span><span class="params">(<span class="keyword">void</span> *userdata)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1886</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1887</span></pre></td><td class="code"><pre><span class="line">  VideoState *is = (VideoState *)userdata;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1888</span></pre></td><td class="code"><pre><span class="line">  VideoPicture *vp;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1889</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span> actual_delay, <span class="built_in">delay</span>, sync_threshold, ref_clock, diff;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1890</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1891</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(is-&gt;video_st) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1892</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(is-&gt;pictq_size == <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1893</span></pre></td><td class="code"><pre><span class="line">      schedule_refresh(is, <span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1894</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1895</span></pre></td><td class="code"><pre><span class="line">      vp = &amp;is-&gt;pictq[is-&gt;pictq_rindex];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1896</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1897</span></pre></td><td class="code"><pre><span class="line">      <span class="built_in">delay</span> = vp-&gt;pts - is-&gt;frame_last_pts; <span class="comment">/* the pts from last time */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1898</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span>(<span class="built_in">delay</span> &lt;= <span class="number">0</span> || <span class="built_in">delay</span> &gt;= <span class="number">1.0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1899</span></pre></td><td class="code"><pre><span class="line">	<span class="comment">/* if incorrect delay, use previous one */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1900</span></pre></td><td class="code"><pre><span class="line">	<span class="built_in">delay</span> = is-&gt;frame_last_delay;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1901</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1902</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">/* save for next time */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1903</span></pre></td><td class="code"><pre><span class="line">      is-&gt;frame_last_delay = <span class="built_in">delay</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1904</span></pre></td><td class="code"><pre><span class="line">      is-&gt;frame_last_pts = vp-&gt;pts;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1905</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1906</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">/* update delay to sync to audio */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1907</span></pre></td><td class="code"><pre><span class="line">      ref_clock = get_audio_clock(is);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1908</span></pre></td><td class="code"><pre><span class="line">      diff = vp-&gt;pts - ref_clock;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1909</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1910</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">/* Skip or repeat the frame. Take delay into account</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1911</span></pre></td><td class="code"><pre><span class="line"><span class="comment">	 FFPlay still doesn't "know if this is the best guess." */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1912</span></pre></td><td class="code"><pre><span class="line">      sync_threshold = (<span class="built_in">delay</span> &gt; AV_SYNC_THRESHOLD) ? <span class="built_in">delay</span> : AV_SYNC_THRESHOLD;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1913</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span>(<span class="built_in">fabs</span>(diff) &lt; AV_NOSYNC_THRESHOLD) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1914</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">if</span>(diff &lt;= -sync_threshold) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1915</span></pre></td><td class="code"><pre><span class="line">	  <span class="built_in">delay</span> = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1916</span></pre></td><td class="code"><pre><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span>(diff &gt;= sync_threshold) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1917</span></pre></td><td class="code"><pre><span class="line">	  <span class="built_in">delay</span> = <span class="number">2</span> * <span class="built_in">delay</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1918</span></pre></td><td class="code"><pre><span class="line">	&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1919</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1920</span></pre></td><td class="code"><pre><span class="line">      is-&gt;frame_timer += <span class="built_in">delay</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1921</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">/* computer the REAL delay */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1922</span></pre></td><td class="code"><pre><span class="line">      actual_delay = is-&gt;frame_timer - (av_gettime() / <span class="number">1000000.0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1923</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span>(actual_delay &lt; <span class="number">0.010</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1924</span></pre></td><td class="code"><pre><span class="line">	<span class="comment">/* Really it should skip the picture instead */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1925</span></pre></td><td class="code"><pre><span class="line">	actual_delay = <span class="number">0.010</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1926</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1927</span></pre></td><td class="code"><pre><span class="line">      schedule_refresh(is, (<span class="keyword">int</span>)(actual_delay * <span class="number">1000</span> + <span class="number">0.5</span>));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1928</span></pre></td><td class="code"><pre><span class="line">      </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1929</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">/* show the picture! */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1930</span></pre></td><td class="code"><pre><span class="line">      video_display(is);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1931</span></pre></td><td class="code"><pre><span class="line">      </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1932</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">/* update queue for next picture! */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1933</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span>(++is-&gt;pictq_rindex == VIDEO_PICTURE_QUEUE_SIZE) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1934</span></pre></td><td class="code"><pre><span class="line">	is-&gt;pictq_rindex = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1935</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1936</span></pre></td><td class="code"><pre><span class="line">      SDL_LockMutex(is-&gt;pictq_mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1937</span></pre></td><td class="code"><pre><span class="line">      is-&gt;pictq_size--;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1938</span></pre></td><td class="code"><pre><span class="line">      SDL_CondSignal(is-&gt;pictq_cond);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1939</span></pre></td><td class="code"><pre><span class="line">      SDL_UnlockMutex(is-&gt;pictq_mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1940</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1941</span></pre></td><td class="code"><pre><span class="line">  &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1942</span></pre></td><td class="code"><pre><span class="line">    schedule_refresh(is, <span class="number">100</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1943</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1944</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1945</span></pre></td><td class="code"><pre><span class="line">      </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1946</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">alloc_picture</span><span class="params">(<span class="keyword">void</span> *userdata)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1947</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1948</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> ret = <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1949</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1950</span></pre></td><td class="code"><pre><span class="line">  VideoState *is = (VideoState *)userdata;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1951</span></pre></td><td class="code"><pre><span class="line">  VideoPicture *vp;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1952</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1953</span></pre></td><td class="code"><pre><span class="line">  vp = &amp;is-&gt;pictq[is-&gt;pictq_windex];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1954</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(vp-&gt;bmp) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1955</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1956</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// we already have one make another, bigger/smaller</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1957</span></pre></td><td class="code"><pre><span class="line">    avpicture_free(vp-&gt;bmp);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1958</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">free</span>(vp-&gt;bmp);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1959</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1960</span></pre></td><td class="code"><pre><span class="line">    vp-&gt;bmp = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1961</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1962</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1963</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Allocate a place to put our YUV image on that screen</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1964</span></pre></td><td class="code"><pre><span class="line">  SDL_LockMutex(text_mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1965</span></pre></td><td class="code"><pre><span class="line">  vp-&gt;bmp = (AVPicture*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(AVPicture));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1966</span></pre></td><td class="code"><pre><span class="line">  ret = avpicture_alloc(vp-&gt;bmp, AV_PIX_FMT_YUV420P, is-&gt;video_ctx-&gt;<span class="built_in">width</span>, is-&gt;video_ctx-&gt;<span class="built_in">height</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1967</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1968</span></pre></td><td class="code"><pre><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Could not allocate temporary picture: %s\n"</span>, av_err2str(ret));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1969</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1970</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1971</span></pre></td><td class="code"><pre><span class="line">  SDL_UnlockMutex(text_mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1972</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1973</span></pre></td><td class="code"><pre><span class="line">  vp-&gt;<span class="built_in">width</span> = is-&gt;video_ctx-&gt;<span class="built_in">width</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1974</span></pre></td><td class="code"><pre><span class="line">  vp-&gt;<span class="built_in">height</span> = is-&gt;video_ctx-&gt;<span class="built_in">height</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1975</span></pre></td><td class="code"><pre><span class="line">  vp-&gt;allocated = <span class="number">1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1976</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1977</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1978</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1979</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">queue_picture</span><span class="params">(VideoState *is, AVFrame *pFrame, <span class="keyword">double</span> pts)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1980</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1981</span></pre></td><td class="code"><pre><span class="line">  VideoPicture *vp;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1982</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1983</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">/* wait until we have space for a new pic */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1984</span></pre></td><td class="code"><pre><span class="line">  SDL_LockMutex(is-&gt;pictq_mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1985</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">while</span>(is-&gt;pictq_size &gt;= VIDEO_PICTURE_QUEUE_SIZE &amp;&amp;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1986</span></pre></td><td class="code"><pre><span class="line">	!is-&gt;quit) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1987</span></pre></td><td class="code"><pre><span class="line">    SDL_CondWait(is-&gt;pictq_cond, is-&gt;pictq_mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1988</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1989</span></pre></td><td class="code"><pre><span class="line">  SDL_UnlockMutex(is-&gt;pictq_mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1990</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1991</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(is-&gt;quit)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1992</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1993</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1994</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// windex is set to 0 initially</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1995</span></pre></td><td class="code"><pre><span class="line">  vp = &amp;is-&gt;pictq[is-&gt;pictq_windex];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1996</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1997</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">/* allocate or resize the buffer! */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1998</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(!vp-&gt;bmp ||</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">1999</span></pre></td><td class="code"><pre><span class="line">     vp-&gt;<span class="built_in">width</span> != is-&gt;video_ctx-&gt;<span class="built_in">width</span> ||</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2000</span></pre></td><td class="code"><pre><span class="line">     vp-&gt;<span class="built_in">height</span> != is-&gt;video_ctx-&gt;<span class="built_in">height</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2001</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2002</span></pre></td><td class="code"><pre><span class="line">    vp-&gt;allocated = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2003</span></pre></td><td class="code"><pre><span class="line">    alloc_picture(is);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2004</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(is-&gt;quit) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2005</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2006</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2007</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2008</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2009</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">/* We have a place to put our picture on the queue */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2010</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(vp-&gt;bmp) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2011</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2012</span></pre></td><td class="code"><pre><span class="line">    vp-&gt;pts = pts;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2013</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2014</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// Convert the image into YUV format that SDL uses</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2015</span></pre></td><td class="code"><pre><span class="line">    sws_scale(is-&gt;video_sws_ctx, (<span class="keyword">uint8_t</span> <span class="keyword">const</span> * <span class="keyword">const</span> *)pFrame-&gt;data,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2016</span></pre></td><td class="code"><pre><span class="line">	      pFrame-&gt;linesize, <span class="number">0</span>, is-&gt;video_ctx-&gt;<span class="built_in">height</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2017</span></pre></td><td class="code"><pre><span class="line">	      vp-&gt;bmp-&gt;data, vp-&gt;bmp-&gt;linesize);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2018</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2019</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* now we inform our display thread that we have a pic ready */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2020</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(++is-&gt;pictq_windex == VIDEO_PICTURE_QUEUE_SIZE) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2021</span></pre></td><td class="code"><pre><span class="line">      is-&gt;pictq_windex = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2022</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2023</span></pre></td><td class="code"><pre><span class="line">    SDL_LockMutex(is-&gt;pictq_mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2024</span></pre></td><td class="code"><pre><span class="line">    is-&gt;pictq_size++;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2025</span></pre></td><td class="code"><pre><span class="line">    SDL_UnlockMutex(is-&gt;pictq_mutex);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2026</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2027</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2028</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2029</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2030</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">synchronize_video</span><span class="params">(VideoState *is, AVFrame *src_frame, <span class="keyword">double</span> pts)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2031</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2032</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span> frame_delay;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2033</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2034</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(pts != <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2035</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* if we have pts, set video clock to it */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2036</span></pre></td><td class="code"><pre><span class="line">    is-&gt;video_clock = pts;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2037</span></pre></td><td class="code"><pre><span class="line">  &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2038</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/* if we aren't given a pts, set it to the clock */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2039</span></pre></td><td class="code"><pre><span class="line">    pts = is-&gt;video_clock;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2040</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2041</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">/* update the video clock */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2042</span></pre></td><td class="code"><pre><span class="line">  frame_delay = av_q2d(is-&gt;video_ctx-&gt;time_base);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2043</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">/* if we are repeating a frame, adjust clock accordingly */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2044</span></pre></td><td class="code"><pre><span class="line">  frame_delay += src_frame-&gt;repeat_pict * (frame_delay * <span class="number">0.5</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2045</span></pre></td><td class="code"><pre><span class="line">  is-&gt;video_clock += frame_delay;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2046</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> pts;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2047</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2048</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2049</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">decode_video_thread</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2050</span></pre></td><td class="code"><pre><span class="line">  VideoState *is = (VideoState *)arg;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2051</span></pre></td><td class="code"><pre><span class="line">  AVPacket pkt1, *packet = &amp;pkt1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2052</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> frameFinished;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2053</span></pre></td><td class="code"><pre><span class="line">  AVFrame *pFrame;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2054</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span> pts;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2055</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2056</span></pre></td><td class="code"><pre><span class="line">  pFrame = av_frame_alloc();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2057</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2058</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span>(;;) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2059</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(packet_queue_get(&amp;is-&gt;videoq, packet, <span class="number">1</span>) &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2060</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">// means we quit getting packets</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2061</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2062</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2063</span></pre></td><td class="code"><pre><span class="line">    pts = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2064</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2065</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// Decode video frame</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2066</span></pre></td><td class="code"><pre><span class="line">    avcodec_decode_video2(is-&gt;video_ctx, pFrame, &amp;frameFinished, packet);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2067</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2068</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>((pts = av_frame_get_best_effort_timestamp(pFrame)) == AV_NOPTS_VALUE) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2069</span></pre></td><td class="code"><pre><span class="line">      pts = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2070</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2071</span></pre></td><td class="code"><pre><span class="line">    pts *= av_q2d(is-&gt;video_st-&gt;time_base);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2072</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2073</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// Did we get a video frame?</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2074</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(frameFinished) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2075</span></pre></td><td class="code"><pre><span class="line">      pts = synchronize_video(is, pFrame, pts);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2076</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span>(queue_picture(is, pFrame, pts) &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2077</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2078</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2079</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2080</span></pre></td><td class="code"><pre><span class="line">    av_free_packet(packet);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2081</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2082</span></pre></td><td class="code"><pre><span class="line">  av_frame_free(&amp;pFrame);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2083</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2084</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2085</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2086</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">stream_component_open</span><span class="params">(VideoState *is, <span class="keyword">int</span> stream_index)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2087</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2088</span></pre></td><td class="code"><pre><span class="line">  AVFormatContext *pFormatCtx = is-&gt;pFormatCtx;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2089</span></pre></td><td class="code"><pre><span class="line">  AVCodecContext *codecCtx = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2090</span></pre></td><td class="code"><pre><span class="line">  AVCodec *codec = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2091</span></pre></td><td class="code"><pre><span class="line">  SDL_AudioSpec wanted_spec, spec;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2092</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2093</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(stream_index &lt; <span class="number">0</span> || stream_index &gt;= pFormatCtx-&gt;nb_streams) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2094</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2095</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2096</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2097</span></pre></td><td class="code"><pre><span class="line">  codecCtx = avcodec_alloc_context3(<span class="literal">NULL</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2098</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2099</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> ret = avcodec_parameters_to_context(codecCtx, pFormatCtx-&gt;streams[stream_index]-&gt;codecpar);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2100</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span> (ret &lt; <span class="number">0</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2101</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2102</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2103</span></pre></td><td class="code"><pre><span class="line">  codec = avcodec_find_decoder(codecCtx-&gt;codec_id);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2104</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(!codec) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2105</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Unsupported codec!\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2106</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2107</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2108</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2109</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2110</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(codecCtx-&gt;codec_type == AVMEDIA_TYPE_AUDIO) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2111</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2112</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// Set audio settings from codec info</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2113</span></pre></td><td class="code"><pre><span class="line">    wanted_spec.freq = codecCtx-&gt;sample_rate;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2114</span></pre></td><td class="code"><pre><span class="line">    wanted_spec.format = AUDIO_S16SYS;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2115</span></pre></td><td class="code"><pre><span class="line">    wanted_spec.channels = <span class="number">2</span>;<span class="comment">//codecCtx-&gt;channels;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2116</span></pre></td><td class="code"><pre><span class="line">    wanted_spec.silence = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2117</span></pre></td><td class="code"><pre><span class="line">    wanted_spec.samples = SDL_AUDIO_BUFFER_SIZE;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2118</span></pre></td><td class="code"><pre><span class="line">    wanted_spec.callback = audio_callback;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2119</span></pre></td><td class="code"><pre><span class="line">    wanted_spec.userdata = is;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2120</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2121</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(SDL_OpenAudio(&amp;wanted_spec, &amp;spec) &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2122</span></pre></td><td class="code"><pre><span class="line">      <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"SDL_OpenAudio: %s\n"</span>, SDL_GetError());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2123</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2124</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2125</span></pre></td><td class="code"><pre><span class="line">    is-&gt;audio_hw_buf_size = spec.<span class="built_in">size</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2126</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2127</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(avcodec_open2(codecCtx, codec, <span class="literal">NULL</span>) &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2128</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Unsupported codec!\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2129</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2130</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2131</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2132</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">switch</span>(codecCtx-&gt;codec_type) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2133</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">case</span> AVMEDIA_TYPE_AUDIO:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2134</span></pre></td><td class="code"><pre><span class="line">    is-&gt;audioStream = stream_index;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2135</span></pre></td><td class="code"><pre><span class="line">    is-&gt;audio_st = pFormatCtx-&gt;streams[stream_index];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2136</span></pre></td><td class="code"><pre><span class="line">    is-&gt;audio_ctx = codecCtx;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2137</span></pre></td><td class="code"><pre><span class="line">    is-&gt;audio_buf_size = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2138</span></pre></td><td class="code"><pre><span class="line">    is-&gt;audio_buf_index = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2139</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">memset</span>(&amp;is-&gt;audio_pkt, <span class="number">0</span>, <span class="keyword">sizeof</span>(is-&gt;audio_pkt));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2140</span></pre></td><td class="code"><pre><span class="line">    packet_queue_init(&amp;is-&gt;audioq);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2141</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2142</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//Out Audio Param</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2143</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">uint64_t</span> out_channel_layout=AV_CH_LAYOUT_STEREO;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2144</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2145</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//AAC:1024  MP3:1152</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2146</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> out_nb_samples= is-&gt;audio_ctx-&gt;frame_size;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2147</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//AVSampleFormat out_sample_fmt = AV_SAMPLE_FMT_S16;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2148</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2149</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> out_sample_rate=is-&gt;audio_ctx-&gt;sample_rate;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2150</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> out_channels=av_get_channel_layout_nb_channels(out_channel_layout);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2151</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//Out Buffer Size</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2152</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/*</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2153</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    int out_buffer_size=av_samples_get_buffer_size(NULL,</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2154</span></pre></td><td class="code"><pre><span class="line"><span class="comment">                                                   out_channels,</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2155</span></pre></td><td class="code"><pre><span class="line"><span class="comment">                                                   out_nb_samples,</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2156</span></pre></td><td class="code"><pre><span class="line"><span class="comment">                                                   AV_SAMPLE_FMT_S16,</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2157</span></pre></td><td class="code"><pre><span class="line"><span class="comment">                                                   1);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2158</span></pre></td><td class="code"><pre><span class="line"><span class="comment">                                                   */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2159</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2160</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//uint8_t *out_buffer=(uint8_t *)av_malloc(MAX_AUDIO_FRAME_SIZE*2);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2161</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int64_t</span> in_channel_layout=av_get_default_channel_layout(is-&gt;audio_ctx-&gt;channels);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2162</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2163</span></pre></td><td class="code"><pre><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">SwrContext</span> *<span class="title">audio_convert_ctx</span>;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2164</span></pre></td><td class="code"><pre><span class="line">    audio_convert_ctx = swr_alloc();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2165</span></pre></td><td class="code"><pre><span class="line">    swr_alloc_set_opts(audio_convert_ctx,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2166</span></pre></td><td class="code"><pre><span class="line">                       out_channel_layout,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2167</span></pre></td><td class="code"><pre><span class="line">                       AV_SAMPLE_FMT_S16,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2168</span></pre></td><td class="code"><pre><span class="line">                       out_sample_rate,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2169</span></pre></td><td class="code"><pre><span class="line">                       in_channel_layout,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2170</span></pre></td><td class="code"><pre><span class="line">                       is-&gt;audio_ctx-&gt;sample_fmt,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2171</span></pre></td><td class="code"><pre><span class="line">                       is-&gt;audio_ctx-&gt;sample_rate,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2172</span></pre></td><td class="code"><pre><span class="line">                       <span class="number">0</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2173</span></pre></td><td class="code"><pre><span class="line">                       <span class="literal">NULL</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2174</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"swr opts: out_channel_layout:%lld, out_sample_fmt:%d, out_sample_rate:%d, in_channel_layout:%lld, in_sample_fmt:%d, in_sample_rate:%d"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2175</span></pre></td><td class="code"><pre><span class="line">            out_channel_layout, AV_SAMPLE_FMT_S16, out_sample_rate, in_channel_layout, is-&gt;audio_ctx-&gt;sample_fmt, is-&gt;audio_ctx-&gt;sample_rate);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2176</span></pre></td><td class="code"><pre><span class="line">    swr_init(audio_convert_ctx);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2177</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2178</span></pre></td><td class="code"><pre><span class="line">    is-&gt;audio_swr_ctx = audio_convert_ctx;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2179</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2180</span></pre></td><td class="code"><pre><span class="line">    SDL_PauseAudio(<span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2181</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2182</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">case</span> AVMEDIA_TYPE_VIDEO:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2183</span></pre></td><td class="code"><pre><span class="line">    is-&gt;videoStream = stream_index;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2184</span></pre></td><td class="code"><pre><span class="line">    is-&gt;video_st = pFormatCtx-&gt;streams[stream_index];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2185</span></pre></td><td class="code"><pre><span class="line">    is-&gt;video_ctx = codecCtx;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2186</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2187</span></pre></td><td class="code"><pre><span class="line">    is-&gt;frame_timer = (<span class="keyword">double</span>)av_gettime() / <span class="number">1000000.0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2188</span></pre></td><td class="code"><pre><span class="line">    is-&gt;frame_last_delay = <span class="number">40e-3</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2189</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2190</span></pre></td><td class="code"><pre><span class="line">    packet_queue_init(&amp;is-&gt;videoq);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2191</span></pre></td><td class="code"><pre><span class="line">    is-&gt;video_sws_ctx = sws_getContext(is-&gt;video_ctx-&gt;<span class="built_in">width</span>, is-&gt;video_ctx-&gt;<span class="built_in">height</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2192</span></pre></td><td class="code"><pre><span class="line">				 is-&gt;video_ctx-&gt;pix_fmt, is-&gt;video_ctx-&gt;<span class="built_in">width</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2193</span></pre></td><td class="code"><pre><span class="line">				 is-&gt;video_ctx-&gt;<span class="built_in">height</span>, AV_PIX_FMT_YUV420P,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2194</span></pre></td><td class="code"><pre><span class="line">				 SWS_BILINEAR, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2195</span></pre></td><td class="code"><pre><span class="line">				 );</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2196</span></pre></td><td class="code"><pre><span class="line">    is-&gt;video_tid = SDL_CreateThread(decode_video_thread, <span class="string">"decode_video_thread"</span>, is);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2197</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2198</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">default</span>:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2199</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2200</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2201</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2202</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2203</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">demux_thread</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2204</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2205</span></pre></td><td class="code"><pre><span class="line">  Uint32 pixformat;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2206</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2207</span></pre></td><td class="code"><pre><span class="line">  VideoState *is = (VideoState *)arg;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2208</span></pre></td><td class="code"><pre><span class="line">  AVFormatContext *pFormatCtx;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2209</span></pre></td><td class="code"><pre><span class="line">  AVPacket pkt1, *packet = &amp;pkt1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2210</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2211</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> video_index = <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2212</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> audio_index = <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2213</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> i;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2214</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2215</span></pre></td><td class="code"><pre><span class="line">  is-&gt;videoStream=<span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2216</span></pre></td><td class="code"><pre><span class="line">  is-&gt;audioStream=<span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2217</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2218</span></pre></td><td class="code"><pre><span class="line">  global_video_state = is;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2219</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2220</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Open video file</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2221</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(avformat_open_input(&amp;pFormatCtx, is-&gt;filename, <span class="literal">NULL</span>, <span class="literal">NULL</span>)!=<span class="number">0</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2222</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">// Couldn't open file</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2223</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2224</span></pre></td><td class="code"><pre><span class="line">  is-&gt;pFormatCtx = pFormatCtx;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2225</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2226</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Retrieve stream information</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2227</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(avformat_find_stream_info(pFormatCtx, <span class="literal">NULL</span>)&lt;<span class="number">0</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2228</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">// Couldn't find stream information</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2229</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2230</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Dump information about file onto standard error</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2231</span></pre></td><td class="code"><pre><span class="line">  av_dump_format(pFormatCtx, <span class="number">0</span>, is-&gt;filename, <span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2232</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2233</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Find the first video stream</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2234</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;pFormatCtx-&gt;nb_streams; i++) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2235</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(pFormatCtx-&gt;streams[i]-&gt;codec-&gt;codec_type==AVMEDIA_TYPE_VIDEO &amp;&amp;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2236</span></pre></td><td class="code"><pre><span class="line">       video_index &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2237</span></pre></td><td class="code"><pre><span class="line">      video_index=i;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2238</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2239</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(pFormatCtx-&gt;streams[i]-&gt;codec-&gt;codec_type==AVMEDIA_TYPE_AUDIO &amp;&amp;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2240</span></pre></td><td class="code"><pre><span class="line">       audio_index &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2241</span></pre></td><td class="code"><pre><span class="line">      audio_index=i;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2242</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2243</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2244</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2245</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(audio_index &gt;= <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2246</span></pre></td><td class="code"><pre><span class="line">    stream_component_open(is, audio_index);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2247</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2248</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(video_index &gt;= <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2249</span></pre></td><td class="code"><pre><span class="line">    stream_component_open(is, video_index);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2250</span></pre></td><td class="code"><pre><span class="line">  &#125;   </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2251</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2252</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(is-&gt;videoStream &lt; <span class="number">0</span> || is-&gt;audioStream &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2253</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"%s: could not open codecs\n"</span>, is-&gt;filename);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2254</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">goto</span> fail;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2255</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2256</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2257</span></pre></td><td class="code"><pre><span class="line">  win = SDL_CreateWindow(<span class="string">"Media Player"</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2258</span></pre></td><td class="code"><pre><span class="line">     		   SDL_WINDOWPOS_UNDEFINED,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2259</span></pre></td><td class="code"><pre><span class="line">		   SDL_WINDOWPOS_UNDEFINED,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2260</span></pre></td><td class="code"><pre><span class="line">		   is-&gt;video_ctx-&gt;<span class="built_in">width</span>, is-&gt;video_ctx-&gt;<span class="built_in">height</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2261</span></pre></td><td class="code"><pre><span class="line">		   SDL_WINDOW_OPENGL | SDL_WINDOW_RESIZABLE);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2262</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2263</span></pre></td><td class="code"><pre><span class="line">  renderer = SDL_CreateRenderer(win, <span class="number">-1</span>, <span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2264</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2265</span></pre></td><td class="code"><pre><span class="line">  pixformat = SDL_PIXELFORMAT_IYUV;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2266</span></pre></td><td class="code"><pre><span class="line">  texture = SDL_CreateTexture(renderer,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2267</span></pre></td><td class="code"><pre><span class="line">			      pixformat, </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2268</span></pre></td><td class="code"><pre><span class="line">			      SDL_TEXTUREACCESS_STREAMING,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2269</span></pre></td><td class="code"><pre><span class="line">			      is-&gt;video_ctx-&gt;<span class="built_in">width</span>,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2270</span></pre></td><td class="code"><pre><span class="line">			      is-&gt;video_ctx-&gt;<span class="built_in">height</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2271</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2272</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// main decode loop</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2273</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2274</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span>(;;) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2275</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2276</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(is-&gt;quit) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2277</span></pre></td><td class="code"><pre><span class="line">      SDL_CondSignal(is-&gt;videoq.cond);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2278</span></pre></td><td class="code"><pre><span class="line">      SDL_CondSignal(is-&gt;audioq.cond);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2279</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2280</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2281</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// seek stuff goes here</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2282</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(is-&gt;audioq.<span class="built_in">size</span> &gt; MAX_AUDIOQ_SIZE ||</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2283</span></pre></td><td class="code"><pre><span class="line">       is-&gt;videoq.<span class="built_in">size</span> &gt; MAX_VIDEOQ_SIZE) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2284</span></pre></td><td class="code"><pre><span class="line">      SDL_Delay(<span class="number">10</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2285</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">continue</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2286</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2287</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(av_read_frame(is-&gt;pFormatCtx, packet) &lt; <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2288</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span>(is-&gt;pFormatCtx-&gt;pb-&gt;error == <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2289</span></pre></td><td class="code"><pre><span class="line">	SDL_Delay(<span class="number">100</span>); <span class="comment">/* no error; wait for user input */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2290</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">continue</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2291</span></pre></td><td class="code"><pre><span class="line">      &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2292</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2293</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2294</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2295</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// Is this a packet from the video stream?</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2296</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(packet-&gt;stream_index == is-&gt;videoStream) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2297</span></pre></td><td class="code"><pre><span class="line">      packet_queue_put(&amp;is-&gt;videoq, packet);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2298</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(packet-&gt;stream_index == is-&gt;audioStream) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2299</span></pre></td><td class="code"><pre><span class="line">      packet_queue_put(&amp;is-&gt;audioq, packet);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2300</span></pre></td><td class="code"><pre><span class="line">    &#125; <span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2301</span></pre></td><td class="code"><pre><span class="line">      av_free_packet(packet);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2302</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2303</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2304</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">/* all done - wait for it */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2305</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">while</span>(!is-&gt;quit) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2306</span></pre></td><td class="code"><pre><span class="line">    SDL_Delay(<span class="number">100</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2307</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2308</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2309</span></pre></td><td class="code"><pre><span class="line"> fail:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2310</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(<span class="number">1</span>)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2311</span></pre></td><td class="code"><pre><span class="line">    SDL_Event event;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2312</span></pre></td><td class="code"><pre><span class="line">    event.type = FF_QUIT_EVENT;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2313</span></pre></td><td class="code"><pre><span class="line">    event.user.data1 = is;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2314</span></pre></td><td class="code"><pre><span class="line">    SDL_PushEvent(&amp;event);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2315</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2316</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2317</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2318</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2319</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2320</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2321</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span>             ret = <span class="number">-1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2322</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2323</span></pre></td><td class="code"><pre><span class="line">  SDL_Event       event;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2324</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2325</span></pre></td><td class="code"><pre><span class="line">  VideoState      *is;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2326</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2327</span></pre></td><td class="code"><pre><span class="line">  is = av_mallocz(<span class="keyword">sizeof</span>(VideoState));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2328</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2329</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(argc &lt; <span class="number">2</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2330</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Usage: test &lt;file&gt;\n"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2331</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2332</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2333</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Register all formats and codecs</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2334</span></pre></td><td class="code"><pre><span class="line">  av_register_all();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2335</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2336</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(SDL_Init(SDL_INIT_VIDEO | SDL_INIT_AUDIO | SDL_INIT_TIMER)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2337</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Could not initialize SDL - %s\n"</span>, SDL_GetError());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2338</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2339</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2340</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2341</span></pre></td><td class="code"><pre><span class="line">  text_mutex = SDL_CreateMutex();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2342</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2343</span></pre></td><td class="code"><pre><span class="line">  av_strlcpy(is-&gt;filename, argv[<span class="number">1</span>], <span class="keyword">sizeof</span>(is-&gt;filename));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2344</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2345</span></pre></td><td class="code"><pre><span class="line">  is-&gt;pictq_mutex = SDL_CreateMutex();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2346</span></pre></td><td class="code"><pre><span class="line">  is-&gt;pictq_cond = SDL_CreateCond();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2347</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2348</span></pre></td><td class="code"><pre><span class="line">  schedule_refresh(is, <span class="number">40</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2349</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2350</span></pre></td><td class="code"><pre><span class="line">  is-&gt;parse_tid = SDL_CreateThread(demux_thread, <span class="string">"demux_thread"</span>, is);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2351</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span>(!is-&gt;parse_tid) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2352</span></pre></td><td class="code"><pre><span class="line">    av_free(is);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2353</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">goto</span> __FAIL;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2354</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2355</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span>(;;) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2356</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2357</span></pre></td><td class="code"><pre><span class="line">    SDL_WaitEvent(&amp;event);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2358</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">switch</span>(event.type) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2359</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">case</span> FF_QUIT_EVENT:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2360</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">case</span> SDL_QUIT:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2361</span></pre></td><td class="code"><pre><span class="line">      is-&gt;quit = <span class="number">1</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2362</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">//SDL_Quit();</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2363</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">//return 0;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2364</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">goto</span> __QUIT;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2365</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2366</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">case</span> FF_REFRESH_EVENT:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2367</span></pre></td><td class="code"><pre><span class="line">      video_refresh_timer(event.user.data1);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2368</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2369</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">default</span>:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2370</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">break</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2371</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2372</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2373</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2374</span></pre></td><td class="code"><pre><span class="line">__QUIT:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2375</span></pre></td><td class="code"><pre><span class="line">  ret = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2376</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2377</span></pre></td><td class="code"><pre><span class="line">__FAIL:</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2378</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2379</span></pre></td><td class="code"><pre><span class="line">  SDL_Quit();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2380</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">/*</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2381</span></pre></td><td class="code"><pre><span class="line"><span class="comment">  if(audiofd)&#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2382</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    fclose(audiofd);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2383</span></pre></td><td class="code"><pre><span class="line"><span class="comment">  &#125;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2384</span></pre></td><td class="code"><pre><span class="line"><span class="comment">  if(audiofd1)&#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2385</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    fclose(audiofd1);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2386</span></pre></td><td class="code"><pre><span class="line"><span class="comment">  &#125;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2387</span></pre></td><td class="code"><pre><span class="line"><span class="comment">  */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2388</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> ret;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2389</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2390</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2391</span></pre></td><td class="code"><pre><span class="line">``` </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2392</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2393</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2394</span></pre></td><td class="code"><pre><span class="line">#### <span class="number">55.</span>Android中使用FFmpeg</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2395</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2396</span></pre></td><td class="code"><pre><span class="line">- Java与C之间的相互调用</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2397</span></pre></td><td class="code"><pre><span class="line">- Android下FFmpeg的编译</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2398</span></pre></td><td class="code"><pre><span class="line">- Android下如何使用FFmpeg</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2399</span></pre></td><td class="code"><pre><span class="line">- JNI基本概念</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2400</span></pre></td><td class="code"><pre><span class="line">    - JNIEnv Java本地化环境，C/C++要访问Java相关的代码都需要它</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2401</span></pre></td><td class="code"><pre><span class="line">    - JavaVM  一个进程对于一个JavaVM，用于获取JNIEnv，一个JavaVM里边很多线程，一个线程对应一个JNIEnv</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2402</span></pre></td><td class="code"><pre><span class="line">    - 线程</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2403</span></pre></td><td class="code"><pre><span class="line">- [Java调用C/C++方法一](#Java调用C/C++)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2404</span></pre></td><td class="code"><pre><span class="line">    - 在Java层定义native关键字函数</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2405</span></pre></td><td class="code"><pre><span class="line">    - 在C/C++层创建`Java_packname_classname_methodname`函数</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2406</span></pre></td><td class="code"><pre><span class="line">- [Java调用C/C++方法二](#Java调用C/C++)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2407</span></pre></td><td class="code"><pre><span class="line">    - 在Java层定义native关键字函数</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2408</span></pre></td><td class="code"><pre><span class="line">    - [RegisterNative](#方法二的定义)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2409</span></pre></td><td class="code"><pre><span class="line">        - <span class="function">Jnit <span class="title">JNI_OnLoad</span><span class="params">(JavaVM *vm, <span class="keyword">void</span>* reserved)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2410</span></pre></td><td class="code"><pre><span class="line">        - Jint JNI_OnUnload(JavaVM *vm, void* reserved)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2411</span></pre></td><td class="code"><pre><span class="line">- 什么是Signature</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2412</span></pre></td><td class="code"><pre><span class="line">    - Java与C/C++相互调用时，用于描述函数参数的描述符【可以理解为映射表的key】</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2413</span></pre></td><td class="code"><pre><span class="line">    - 输入参数放在()内，输出参数放在()外</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2414</span></pre></td><td class="code"><pre><span class="line">    - 多个参数之间顺序存放，且用`;`分割</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2415</span></pre></td><td class="code"><pre><span class="line">- 原始类型的Signature</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2416</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2417</span></pre></td><td class="code"><pre><span class="line">Java类型 | 符号</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2418</span></pre></td><td class="code"><pre><span class="line">---|---</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2419</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> | Z</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2420</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">byte</span>    | B</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2421</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span>    | C</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2422</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">short</span>   | S</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2423</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span>     | I</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2424</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span>    | L</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2425</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">float</span>   | F</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2426</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">double</span>  | D</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2427</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span>    | V</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2428</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2429</span></pre></td><td class="code"><pre><span class="line">- 类的Signature</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2430</span></pre></td><td class="code"><pre><span class="line">    - Java对象参数`L包路径/类名`</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2431</span></pre></td><td class="code"><pre><span class="line">    - Java数组`[`</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2432</span></pre></td><td class="code"><pre><span class="line">        -  ([Student;)[LStudent]  ==&gt; Student[] Xxx(Student[])</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2433</span></pre></td><td class="code"><pre><span class="line">        -  ([java/lang/<span class="keyword">String</span>;)[Ljava/lang/Object  ==&gt; Object[] Xxx(<span class="keyword">String</span>[] s)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2434</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2435</span></pre></td><td class="code"><pre><span class="line">- [C/C++调Java方法](#C/C++调Java方法)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2436</span></pre></td><td class="code"><pre><span class="line">    - <span class="number">1.</span> FindClass 获取Java中的类</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2437</span></pre></td><td class="code"><pre><span class="line">    - <span class="number">2.</span> GetMethodID / GetFieldID  获取Java类中所有的方法/属性</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2438</span></pre></td><td class="code"><pre><span class="line">    - <span class="number">3.</span> NewObject  获取Java中的内存对象</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2439</span></pre></td><td class="code"><pre><span class="line">    - <span class="number">4.</span> Call&lt;TYPE&gt;Method / [G/S]et&lt;Type&gt;Field</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2440</span></pre></td><td class="code"><pre><span class="line">        </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2441</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2442</span></pre></td><td class="code"><pre><span class="line"> ###### 方法二的定义</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2443</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2444</span></pre></td><td class="code"><pre><span class="line">```c</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2445</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> struct &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2446</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* name; <span class="comment">// 与Java定义的name同名</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2447</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* signature; <span class="comment">// 标注输入输出参数</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2448</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">void</span>* fnPtr; <span class="comment">// 具体API</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2449</span></pre></td><td class="code"><pre><span class="line">&#125;JNINativeMethod;</span></pre></td></tr></table></figure>

<h6 id="Java调用C-C"><a href="#Java调用C-C" class="headerlink" title="Java调用C/C++"></a>Java调用C/C++</h6><ul>
<li><p>C++端代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> JNI_CLASS_PATH <span class="meta-string">"com/muziyu/apple/firstjni/MainActivity"</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> JNIEXPORT jstring JNICALL</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">Java_com_muziyu_apple_firstjni_MainActivity_stringFromJNI(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        JNIEnv *env,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        jobject <span class="comment">/* this */</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> hello = <span class="string">"Hello from C++"</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> env-&gt;NewStringUTF(hello.c_str());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 方法一</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">JNIEXPORT jstring JNICALL</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">Java_com_muziyu_apple_firstjni_MainActivity_mStringFromJNI(JNIEnv *env, jobject thiz, jstring str) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> implement mStringFromJNI()</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *mStr = env-&gt;GetStringUTFChars(str, <span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    env-&gt;ReleaseStringUTFChars(str, mStr);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> env-&gt;NewStringUTF(mStr);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/// 方法二</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">JNIEXPORT jstring JNICALL</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">my_test_register(JNIEnv *env, jobject thiz) &#123; <span class="comment">/// 实现一个Native对应的函数</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> env-&gt;NewStringUTF(<span class="string">"This is a test of register!"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> JNINativeMethod g_methods[] = &#123; <span class="comment">/// 定义了一个静态方法，第一个参数是Java端定义的Native的方法名，第二个参数是一个输入输出参数</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">    &#123; <span class="string">"_test"</span>,<span class="string">"()Ljava/lang/String;"</span>, (<span class="keyword">void</span>*)my_test_register &#125;,</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line"><span class="function">jint <span class="title">JNI_OnLoad</span><span class="params">(JavaVM *vm, <span class="keyword">void</span> *reserved)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">    JNIEnv *env = <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">    vm-&gt;GetEnv((<span class="keyword">void</span>**)&amp;env, JNI_VERSION_1_6); <span class="comment">/// 获取Java虚拟机环境</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">    jclass clazz = env-&gt;FindClass(JNI_CLASS_PATH); <span class="comment">/// 根据Java端的类路径在C/C++层创建这个类</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">    env-&gt;RegisterNatives(clazz, g_methods, <span class="keyword">sizeof</span>(g_methods)/<span class="keyword">sizeof</span>(g_methods[<span class="number">0</span>])); <span class="comment">/// 在Java虚拟机里建立C/C++到Java的映射关系</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> JNI_VERSION_1_6;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
</li>
<li><p>Java端代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.muziyu.apple.firstjni;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.os.Bundle;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.widget.TextView;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// Used to load the 'native-lib' library on application startup.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">static</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        System.loadLibrary(<span class="string">"native-lib"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Override</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">        setContentView(R.layout.activity_main);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// Example of a call to a native method</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">        TextView tv = findViewById(R.id.sample_text);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">        String hello = stringFromJNI() + mStringFromJNI(<span class="string">"ABC"</span>) + <span class="string">' '</span> + _test();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">        tv.setText(hello);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     * A native method that is implemented by the 'native-lib' native library,</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     * which is packaged with this application.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">stringFromJNI</span><span class="params">()</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 方法一</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">mStringFromJNI</span><span class="params">(String str)</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// 方法二</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">_test</span><span class="params">()</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<p>C/C++调Java方法</p>
</li>
<li><p>Java主入口</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.muziyu/apple.firstjni;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.os.Bundle;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.widget.TextView;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// Used to load the 'native-lib' library on application startup.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">static</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        System.loadLibrary(<span class="string">"native-lib"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Override</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">        setContentView(R.layout.activity_main);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">// Example of a call to a native method</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">        TextView tv = findViewById(R.id.sample_text);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">        String hello = mTest();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">        tv.setText(hello);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     * A native method that is implemented by the 'native-lib' native library,</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     * which is packaged with this application.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// C/C++调用Java</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">mTest</span><span class="params">()</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

<ul>
<li>Java外部类</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.muziyu/apple.firstjni;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> year;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getYear</span><span class="params">()</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> year;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setYear</span><span class="params">(<span class="keyword">int</span> year)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">this</span>.year = year;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>


<ul>
<li>C/C++代码<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> JNI_CLAZZ_PATH <span class="meta-string">"com/muziyu/apple/firstjni/Student"</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// C/C++调用Java</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">JNIEXPORT jstring JNICALL</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">Java_com_muziyu_apple_firstjni_MainActivity_mTest(JNIEnv *env, jobject thiz) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/// 第一步：获取Java类</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    jclass clazz = env-&gt;FindClass(JNI_CLAZZ_PATH);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/// 第二步：获取Java类中的方法和属性</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    jmethodID method_init_id = env-&gt;GetMethodID(clazz, <span class="string">"&lt;init&gt;"</span>, <span class="string">"()V"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    jmethodID method_set_id = env-&gt;GetMethodID(clazz, <span class="string">"setYear"</span>, <span class="string">"(I)V"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    jmethodID method_get_id = env-&gt;GetMethodID(clazz, <span class="string">"getYear"</span>, <span class="string">"()I"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/// 第三步：生成一个新的对象</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    jobject obj = env-&gt;NewObject(clazz, method_init_id);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/// 第四步：调用Java中的方法</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    env-&gt;CallVoidMethod(obj, method_set_id, <span class="number">18</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> year = env-&gt;CallIntMethod(obj, method_get_id);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">char</span> tmp [<span class="number">50</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">sprintf</span>(tmp, <span class="string">"%d"</span>, year);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> hello = <span class="string">"Hello from C++, year="</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">    hello.append(tmp);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> env-&gt;NewStringUTF(hello.c_str());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>


</li>
</ul>
<h4 id="56-Android下的播放器"><a href="#56-Android下的播放器" class="headerlink" title="56.Android下的播放器"></a>56.Android下的播放器</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"># 设置CMake版本</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.4.1)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"># 新增的Lib库：第一个参数是自己定义的名字，第二参数是指定是动态库(.so)还是静态库(.a)，第三个参数是Lib的路径</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">add_library(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        native-lib</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        SHARED</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        native-lib.cpp)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"># 指定ffmpeg编译好之后的Lib库目录</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">set(JNI_LIBS_DIR $&#123;CMAKE_SOURCE_DIR&#125;&#x2F;src&#x2F;main&#x2F;jniLibs)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"># 在系统下找对应的Lib库</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">find_library(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">        log-lib</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">        log)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">find_library(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">        android-lib</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">        android)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line"># 引入FFmpeg中的libavutil</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">add_library(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">        avutil</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">        SHARED</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">        native-lib.cpp)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">set_target_properties(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">                avutil</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">                PROPERTIES IMPORTED_LOCATION</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">                $&#123;JNI_LIBS_DIR&#125;&#x2F;$&#123;ANDROID_ABI&#125;&#x2F;libavutil.so)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line"># 引入FFmpeg中的libswresample            </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">add_library(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">        swresample</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">        SHARED</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">        native-lib.cpp)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">set_target_properties(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">                avutil</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">                PROPERTIES IMPORTED_LOCATION</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">                $&#123;JNI_LIBS_DIR&#125;&#x2F;$&#123;ANDROID_ABI&#125;&#x2F;libswresample.so)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line"># 引入FFmpeg中的libswscale</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">add_library(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">        swscale</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">        SHARED</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">        native-lib.cpp)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line">set_target_properties(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line">                avutil</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">51</span></pre></td><td class="code"><pre><span class="line">                PROPERTIES IMPORTED_LOCATION</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">52</span></pre></td><td class="code"><pre><span class="line">                $&#123;JNI_LIBS_DIR&#125;&#x2F;$&#123;ANDROID_ABI&#125;&#x2F;libswscale.so)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">53</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">54</span></pre></td><td class="code"><pre><span class="line"># 引入FFmpeg中的libavcodec            </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">55</span></pre></td><td class="code"><pre><span class="line">add_library(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">56</span></pre></td><td class="code"><pre><span class="line">        avcodec</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">57</span></pre></td><td class="code"><pre><span class="line">        SHARED</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">58</span></pre></td><td class="code"><pre><span class="line">        native-lib.cpp)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">59</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">60</span></pre></td><td class="code"><pre><span class="line">set_target_properties(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">61</span></pre></td><td class="code"><pre><span class="line">                avutil</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">62</span></pre></td><td class="code"><pre><span class="line">                PROPERTIES IMPORTED_LOCATION</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">63</span></pre></td><td class="code"><pre><span class="line">                $&#123;JNI_LIBS_DIR&#125;&#x2F;$&#123;ANDROID_ABI&#125;&#x2F;libavcodec.so)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">64</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">65</span></pre></td><td class="code"><pre><span class="line"># 引入FFmpeg中的libavformat</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">66</span></pre></td><td class="code"><pre><span class="line">add_library(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">67</span></pre></td><td class="code"><pre><span class="line">        avformat</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">68</span></pre></td><td class="code"><pre><span class="line">        SHARED</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">69</span></pre></td><td class="code"><pre><span class="line">        native-lib.cpp)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">70</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">71</span></pre></td><td class="code"><pre><span class="line">set_target_properties(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">72</span></pre></td><td class="code"><pre><span class="line">                avutil</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">73</span></pre></td><td class="code"><pre><span class="line">                PROPERTIES IMPORTED_LOCATION</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">74</span></pre></td><td class="code"><pre><span class="line">                $&#123;JNI_LIBS_DIR&#125;&#x2F;$&#123;ANDROID_ABI&#125;&#x2F;libavformat.so)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">75</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">76</span></pre></td><td class="code"><pre><span class="line"># 引入FFmpeg中的libavfilter</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">77</span></pre></td><td class="code"><pre><span class="line">add_library(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">78</span></pre></td><td class="code"><pre><span class="line">        avfilter</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">79</span></pre></td><td class="code"><pre><span class="line">        SHARED</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">80</span></pre></td><td class="code"><pre><span class="line">        native-lib.cpp)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">81</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">82</span></pre></td><td class="code"><pre><span class="line">set_target_properties(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">83</span></pre></td><td class="code"><pre><span class="line">                avutil</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">84</span></pre></td><td class="code"><pre><span class="line">                PROPERTIES IMPORTED_LOCATION</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">85</span></pre></td><td class="code"><pre><span class="line">                $&#123;JNI_LIBS_DIR&#125;&#x2F;$&#123;ANDROID_ABI&#125;&#x2F;libavfilter.so)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">86</span></pre></td><td class="code"><pre><span class="line">                </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">87</span></pre></td><td class="code"><pre><span class="line"># 引入FFmpeg中的libavdevice</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">88</span></pre></td><td class="code"><pre><span class="line">add_library(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">89</span></pre></td><td class="code"><pre><span class="line">        avdevice</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">90</span></pre></td><td class="code"><pre><span class="line">        SHARED</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">91</span></pre></td><td class="code"><pre><span class="line">        native-lib.cpp)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">92</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">93</span></pre></td><td class="code"><pre><span class="line">set_target_properties(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">94</span></pre></td><td class="code"><pre><span class="line">                avutil</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">95</span></pre></td><td class="code"><pre><span class="line">                PROPERTIES IMPORTED_LOCATION</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">96</span></pre></td><td class="code"><pre><span class="line">                $&#123;JNI_LIBS_DIR&#125;&#x2F;$&#123;ANDROID_ABI&#125;&#x2F;libavdevice.so)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">97</span></pre></td><td class="code"><pre><span class="line">      </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">98</span></pre></td><td class="code"><pre><span class="line"># 设置第三方lib库的头文件路径          </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">99</span></pre></td><td class="code"><pre><span class="line">include_directories($&#123;JNI_LIBS_DIR&#125;&#x2F;includes)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">100</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">101</span></pre></td><td class="code"><pre><span class="line"># 链接所有Lib库</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">102</span></pre></td><td class="code"><pre><span class="line">target_link_libraries(</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">103</span></pre></td><td class="code"><pre><span class="line">            native-lib</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">104</span></pre></td><td class="code"><pre><span class="line">            avutil swresample swscale avcodec avformat avfilter avdevice</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">105</span></pre></td><td class="code"><pre><span class="line">            $&#123;log-lib&#125; $&#123;android-lib&#125;)</span></pre></td></tr></table></figure>


<h4 id="57-IOS下使用FFmpeg"><a href="#57-IOS下使用FFmpeg" class="headerlink" title="57.IOS下使用FFmpeg"></a>57.IOS下使用FFmpeg</h4><ul>
<li>build-ffmpeg.sh</li>
</ul>
<pre><code class="bash"><span class="meta">#!/bin/sh</span>

<span class="comment"># directories</span>
FF_VERSION=<span class="string">"4.2"</span>
<span class="comment">#FF_VERSION="snapshot-git"</span>
<span class="keyword">if</span> [[ <span class="variable">$FFMPEG_VERSION</span> != <span class="string">""</span> ]]; <span class="keyword">then</span>
  FF_VERSION=<span class="variable">$FFMPEG_VERSION</span>
<span class="keyword">fi</span>
SOURCE=<span class="string">"ffmpeg-<span class="variable">$FF_VERSION</span>"</span>
FAT=<span class="string">"FFmpeg-iOS"</span>

SCRATCH=<span class="string">"scratch"</span>
<span class="comment"># must be an absolute path</span>
THIN=`<span class="built_in">pwd</span>`/<span class="string">"thin"</span>

<span class="comment"># absolute path to x264 library</span>
<span class="comment">#X264=`pwd`/fat-x264</span>

<span class="comment">#FDK_AAC=`pwd`/../fdk-aac-build-script-for-iOS/fdk-aac-ios</span>

CONFIGURE_FLAGS=<span class="string">"--enable-cross-compile --disable-debug --disable-programs \</span>
<span class="string">                 --disable-doc --enable-pic"</span>

<span class="keyword">if</span> [ <span class="string">"<span class="variable">$X264</span>"</span> ]
<span class="keyword">then</span>
    CONFIGURE_FLAGS=<span class="string">"<span class="variable">$CONFIGURE_FLAGS</span> --enable-gpl --enable-libx264"</span>
<span class="keyword">fi</span>

<span class="keyword">if</span> [ <span class="string">"<span class="variable">$FDK_AAC</span>"</span> ]
<span class="keyword">then</span>
    CONFIGURE_FLAGS=<span class="string">"<span class="variable">$CONFIGURE_FLAGS</span> --enable-libfdk-aac --enable-nonfree"</span>
<span class="keyword">fi</span>

<span class="comment"># avresample</span>
<span class="comment">#CONFIGURE_FLAGS="$CONFIGURE_FLAGS --enable-avresample"</span>

ARCHS=<span class="string">"arm64 armv7 x86_64 i386"</span>

COMPILE=<span class="string">"y"</span>
LIPO=<span class="string">"y"</span>

DEPLOYMENT_TARGET=<span class="string">"8.0"</span>

<span class="keyword">if</span> [ <span class="string">"$*"</span> ]
<span class="keyword">then</span>
    <span class="keyword">if</span> [ <span class="string">"$*"</span> = <span class="string">"lipo"</span> ]
    <span class="keyword">then</span>
        <span class="comment"># skip compile</span>
        COMPILE=
    <span class="keyword">else</span>
        ARCHS=<span class="string">"$*"</span>
        <span class="keyword">if</span> [ <span class="variable">$#</span> -eq 1 ]
        <span class="keyword">then</span>
            <span class="comment"># skip lipo</span>
            LIPO=
        <span class="keyword">fi</span>
    <span class="keyword">fi</span>
<span class="keyword">fi</span>

<span class="keyword">if</span> [ <span class="string">"<span class="variable">$COMPILE</span>"</span> ]
<span class="keyword">then</span>
    <span class="keyword">if</span> [ ! `<span class="built_in">which</span> yasm` ]
    <span class="keyword">then</span>
        <span class="built_in">echo</span> <span class="string">'Yasm not found'</span>
        <span class="keyword">if</span> [ ! `<span class="built_in">which</span> brew` ]
        <span class="keyword">then</span>
            <span class="built_in">echo</span> <span class="string">'Homebrew not found. Trying to install...'</span>
                        ruby -e <span class="string">"<span class="variable">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)</span>"</span> \
                || <span class="built_in">exit</span> 1
        <span class="keyword">fi</span>
        <span class="built_in">echo</span> <span class="string">'Trying to install Yasm...'</span>
        brew install yasm || <span class="built_in">exit</span> 1
    <span class="keyword">fi</span>
    <span class="keyword">if</span> [ ! `<span class="built_in">which</span> gas-preprocessor.pl` ]
    <span class="keyword">then</span>
        <span class="built_in">echo</span> <span class="string">'gas-preprocessor.pl not found. Trying to install...'</span>
        (curl -L https://github.com/libav/gas-preprocessor/raw/master/gas-preprocessor.pl \
            -o /usr/<span class="built_in">local</span>/bin/gas-preprocessor.pl \
            &amp;&amp; chmod +x /usr/<span class="built_in">local</span>/bin/gas-preprocessor.pl) \
            || <span class="built_in">exit</span> 1
    <span class="keyword">fi</span>

    <span class="keyword">if</span> [ ! -r <span class="variable">$SOURCE</span> ]
    <span class="keyword">then</span>
        <span class="built_in">echo</span> <span class="string">'FFmpeg source not found. Trying to download...'</span>
        curl http://www.ffmpeg.org/releases/<span class="variable">$SOURCE</span>.tar.bz2 | tar xj \
            || <span class="built_in">exit</span> 1
    <span class="keyword">fi</span>

    CWD=`<span class="built_in">pwd</span>`
    <span class="keyword">for</span> ARCH <span class="keyword">in</span> <span class="variable">$ARCHS</span>
    <span class="keyword">do</span>
        <span class="built_in">echo</span> <span class="string">"building <span class="variable">$ARCH</span>..."</span>
        mkdir -p <span class="string">"<span class="variable">$SCRATCH</span>/<span class="variable">$ARCH</span>"</span>
        <span class="built_in">cd</span> <span class="string">"<span class="variable">$SCRATCH</span>/<span class="variable">$ARCH</span>"</span>

        CFLAGS=<span class="string">"-arch <span class="variable">$ARCH</span>"</span>
        <span class="keyword">if</span> [ <span class="string">"<span class="variable">$ARCH</span>"</span> = <span class="string">"i386"</span> -o <span class="string">"<span class="variable">$ARCH</span>"</span> = <span class="string">"x86_64"</span> ]
        <span class="keyword">then</span>
            PLATFORM=<span class="string">"iPhoneSimulator"</span>
            CFLAGS=<span class="string">"<span class="variable">$CFLAGS</span> -mios-simulator-version-min=<span class="variable">$DEPLOYMENT_TARGET</span>"</span>
        <span class="keyword">else</span>
            PLATFORM=<span class="string">"iPhoneOS"</span>
            CFLAGS=<span class="string">"<span class="variable">$CFLAGS</span> -mios-version-min=<span class="variable">$DEPLOYMENT_TARGET</span> -fembed-bitcode"</span>
            <span class="keyword">if</span> [ <span class="string">"<span class="variable">$ARCH</span>"</span> = <span class="string">"arm64"</span> ]
            <span class="keyword">then</span>
                EXPORT=<span class="string">"GASPP_FIX_XCODE5=1"</span>
            <span class="keyword">fi</span>
        <span class="keyword">fi</span>

        XCRUN_SDK=`<span class="built_in">echo</span> <span class="variable">$PLATFORM</span> | tr <span class="string">'[:upper:]'</span> <span class="string">'[:lower:]'</span>`
        CC=<span class="string">"xcrun -sdk <span class="variable">$XCRUN_SDK</span> clang"</span>

        <span class="comment"># force "configure" to use "gas-preprocessor.pl" (FFmpeg 3.3)</span>
        <span class="keyword">if</span> [ <span class="string">"<span class="variable">$ARCH</span>"</span> = <span class="string">"arm64"</span> ]
        <span class="keyword">then</span>
            AS=<span class="string">"gas-preprocessor.pl -arch aarch64 -- <span class="variable">$CC</span>"</span>
        <span class="keyword">else</span>
            AS=<span class="string">"gas-preprocessor.pl -- <span class="variable">$CC</span>"</span>
        <span class="keyword">fi</span>

        CXXFLAGS=<span class="string">"<span class="variable">$CFLAGS</span>"</span>
        LDFLAGS=<span class="string">"<span class="variable">$CFLAGS</span>"</span>
        <span class="keyword">if</span> [ <span class="string">"<span class="variable">$X264</span>"</span> ]
        <span class="keyword">then</span>
            CFLAGS=<span class="string">"<span class="variable">$CFLAGS</span> -I<span class="variable">$X264</span>/include"</span>
            LDFLAGS=<span class="string">"<span class="variable">$LDFLAGS</span> -L<span class="variable">$X264</span>/lib"</span>
        <span class="keyword">fi</span>
        <span class="keyword">if</span> [ <span class="string">"<span class="variable">$FDK_AAC</span>"</span> ]
        <span class="keyword">then</span>
            CFLAGS=<span class="string">"<span class="variable">$CFLAGS</span> -I<span class="variable">$FDK_AAC</span>/include"</span>
            LDFLAGS=<span class="string">"<span class="variable">$LDFLAGS</span> -L<span class="variable">$FDK_AAC</span>/lib"</span>
        <span class="keyword">fi</span>

        TMPDIR=<span class="variable">${TMPDIR/%\/}</span> <span class="variable">$CWD</span>/<span class="variable">$SOURCE</span>/configure \
            --target-os=darwin \
            --arch=<span class="variable">$ARCH</span> \
            --cc=<span class="string">"<span class="variable">$CC</span>"</span> \
            --as=<span class="string">"<span class="variable">$AS</span>"</span> \
            <span class="variable">$CONFIGURE_FLAGS</span> \
            --extra-cflags=<span class="string">"<span class="variable">$CFLAGS</span>"</span> \
            --extra-ldflags=<span class="string">"<span class="variable">$LDFLAGS</span>"</span> \
            --prefix=<span class="string">"<span class="variable">$THIN</span>/<span class="variable">$ARCH</span>"</span> \
        || <span class="built_in">exit</span> 1

        make -j3 install <span class="variable">$EXPORT</span> || <span class="built_in">exit</span> 1
        <span class="built_in">cd</span> <span class="variable">$CWD</span>
    <span class="keyword">done</span>
<span class="keyword">fi</span>

<span class="keyword">if</span> [ <span class="string">"<span class="variable">$LIPO</span>"</span> ]
<span class="keyword">then</span>
    <span class="built_in">echo</span> <span class="string">"building fat binaries..."</span>
    mkdir -p <span class="variable">$FAT</span>/lib
    <span class="built_in">set</span> - <span class="variable">$ARCHS</span>
    CWD=`<span class="built_in">pwd</span>`
    <span class="built_in">cd</span> <span class="variable">$THIN</span>/<span class="variable">$1</span>/lib
    <span class="keyword">for</span> LIB <span class="keyword">in</span> *.a
    <span class="keyword">do</span>
        <span class="built_in">cd</span> <span class="variable">$CWD</span>
        <span class="built_in">echo</span> lipo -create `find <span class="variable">$THIN</span> -name <span class="variable">$LIB</span>` -output <span class="variable">$FAT</span>/lib/<span class="variable">$LIB</span> 1&gt;&amp;2
        lipo -create `find <span class="variable">$THIN</span> -name <span class="variable">$LIB</span>` -output <span class="variable">$FAT</span>/lib/<span class="variable">$LIB</span> || <span class="built_in">exit</span> 1
    <span class="keyword">done</span>

    <span class="built_in">cd</span> <span class="variable">$CWD</span>
    cp -rf <span class="variable">$THIN</span>/<span class="variable">$1</span>/include <span class="variable">$FAT</span>
<span class="keyword">fi</span>

<span class="built_in">echo</span> Done</code></pre>
<h4 id="58-音视频进阶"><a href="#58-音视频进阶" class="headerlink" title="58.音视频进阶"></a>58.音视频进阶</h4><ul>
<li>FFmpeg Filter的使用与开发</li>
<li>FFmpeg裁剪与优化</li>
<li>视频渲染(OpenGL / Metal)</li>
<li>声音特效</li>
<li>网络传输</li>
<li>WebRTC 在浏览器之间进行P2P的传输，视频会议</li>
<li>AR技术</li>
<li>OpenCV </li>
<li>回音消除</li>
<li>降噪</li>
<li>视频秒开</li>
<li>多人多视频实时互动</li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/ffmpeg/" rel="tag"># ffmpeg</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
                <a href="/2019/10/02/ng-canDeactivate/" rel="next" title="意外未保存的数据？angular杀手锏CanDeactivate">
                  <i class="fa fa-chevron-left"></i> 意外未保存的数据？angular杀手锏CanDeactivate
                </a>
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
                <a href="/2020/01/11/rxjs-combineLatest-withLatestFrom-zip/" rel="prev" title="Rxjs【combineLatest、withLatestFrom、zip】">
                  Rxjs【combineLatest、withLatestFrom、zip】 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    <div class="comments" id="gitalk-container"></div>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-ffmpeg常用命令"><span class="nav-number">1.</span> <span class="nav-text">1.ffmpeg常用命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-应用场景"><span class="nav-number">2.</span> <span class="nav-text">2.应用场景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-基本流程"><span class="nav-number">3.</span> <span class="nav-text">3.基本流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-ffmpeg的历史"><span class="nav-number">4.</span> <span class="nav-text">4.ffmpeg的历史</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-下载"><span class="nav-number">5.</span> <span class="nav-text">5.下载</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-ffmpeg命令分类"><span class="nav-number">6.</span> <span class="nav-text">6.ffmpeg命令分类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-ffmpeg处理流程"><span class="nav-number">7.</span> <span class="nav-text">7.ffmpeg处理流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-ffmpeg命令之基本信息查询"><span class="nav-number">8.</span> <span class="nav-text">8.ffmpeg命令之基本信息查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-ffmpeg命令之录制"><span class="nav-number">9.</span> <span class="nav-text">9.ffmpeg命令之录制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#10-ffmpeg命令之分解与复用"><span class="nav-number">10.</span> <span class="nav-text">10.ffmpeg命令之分解与复用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#11-ffmpeg命令之处理原始数据"><span class="nav-number">11.</span> <span class="nav-text">11.ffmpeg命令之处理原始数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#12-ffmpeg命令之滤镜"><span class="nav-number">12.</span> <span class="nav-text">12.ffmpeg命令之滤镜</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-ffmpeg命令之裁剪与合并"><span class="nav-number">13.</span> <span class="nav-text">13.ffmpeg命令之裁剪与合并</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#14-ffmpeg命令之图片与视频互转"><span class="nav-number">14.</span> <span class="nav-text">14.ffmpeg命令之图片与视频互转</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#15-ffmpeg命令之直播推流与拉流"><span class="nav-number">15.</span> <span class="nav-text">15.ffmpeg命令之直播推流与拉流</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#18-C语言基础之常用基本类型"><span class="nav-number">16.</span> <span class="nav-text">18.C语言基础之常用基本类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#19-C语言基础之指针与数组"><span class="nav-number">17.</span> <span class="nav-text">19.C语言基础之指针与数组</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#20-C语言基础之结构体"><span class="nav-number">18.</span> <span class="nav-text">20.C语言基础之结构体</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#20-C语言基础之算数运算符与比较运算符"><span class="nav-number">19.</span> <span class="nav-text">20.C语言基础之算数运算符与比较运算符</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#21-C语言基础之循环"><span class="nav-number">20.</span> <span class="nav-text">21.C语言基础之循环</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#22-C语言基础之函数"><span class="nav-number">21.</span> <span class="nav-text">22.C语言基础之函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#23-C语言基础之文件操作"><span class="nav-number">22.</span> <span class="nav-text">23.C语言基础之文件操作</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#24-C语言基础之编译器"><span class="nav-number">23.</span> <span class="nav-text">24.C语言基础之编译器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#25-C语言基础之调试器"><span class="nav-number">24.</span> <span class="nav-text">25.C语言基础之调试器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#27-ffmpeg代码结构"><span class="nav-number">25.</span> <span class="nav-text">27.ffmpeg代码结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#28-ffmpeg日志系统"><span class="nav-number">26.</span> <span class="nav-text">28.ffmpeg日志系统</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#29-ffmpeg文件的删除与重命名"><span class="nav-number">27.</span> <span class="nav-text">29.ffmpeg文件的删除与重命名</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#30-ffmpeg操作目录函数"><span class="nav-number">28.</span> <span class="nav-text">30.ffmpeg操作目录函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#31-多媒体文件"><span class="nav-number">29.</span> <span class="nav-text">31.多媒体文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#32-打印音视频信息"><span class="nav-number">30.</span> <span class="nav-text">32.打印音视频信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#33-抽取音频数据"><span class="nav-number">31.</span> <span class="nav-text">33.抽取音频数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#35-将MP4转成FLV格式"><span class="nav-number">32.</span> <span class="nav-text">35.将MP4转成FLV格式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#44-纹理渲染"><span class="nav-number">33.</span> <span class="nav-text">44.纹理渲染</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#45-YUV播放器"><span class="nav-number">34.</span> <span class="nav-text">45.YUV播放器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#49-实现一个最简单的播放器（支持视频和音频）"><span class="nav-number">35.</span> <span class="nav-text">49.实现一个最简单的播放器（支持视频和音频）</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Java调用C-C"><span class="nav-number">35.0.1.</span> <span class="nav-text">Java调用C/C++</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#56-Android下的播放器"><span class="nav-number">36.</span> <span class="nav-text">56.Android下的播放器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#57-IOS下使用FFmpeg"><span class="nav-number">37.</span> <span class="nav-text">57.IOS下使用FFmpeg</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#58-音视频进阶"><span class="nav-number">38.</span> <span class="nav-text">58.音视频进阶</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="site-author-image" itemprop="image" alt="lanxuexing"
    src="/images/avatar.jpeg">
  <p class="site-author-name" itemprop="name">lanxuexing</p>
  <div class="site-description" itemprop="description">love digging into the internals of frontend. always trying to reach the next level.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">39</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/lanxuexing" title="GitHub &amp;rarr; https:&#x2F;&#x2F;github.com&#x2F;lanxuexing" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.jianshu.com/u/5d2ca1a95d0f" title="简书 &amp;rarr; https:&#x2F;&#x2F;www.jianshu.com&#x2F;u&#x2F;5d2ca1a95d0f" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i>简书</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lanxuexing</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">246k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">3:44</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.5.0
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  




  <script src="/js/local-search.js"></script>













  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID: '6de5df5c9b850c3a6301',
      clientSecret: 'd468faddc108a77530ab2ef61ddb80f1721549f6',
      repo: 'blog-comments',
      owner: 'lanxuexing',
      admin: ['lanxuexing'],
      id: 'aae5ea962b918fd9c3fd5ac8cda6e723',
        language: 'zh-CN',
      distractionFreeMode: 'false'
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
</script>

</body>
</html>
